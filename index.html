<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>æ—…éŠå°å¹«æ‰‹ v3.2 (Share)</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght=400;500;700&family=Zen+Maru+Gothic:wght=400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #FEFDF5;
            --text-main: #433D3C;
            --text-sub: #9CA3AF;
            --accent: #D4C4B7;
            --highlight: #F43F5E;
        }
        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            -webkit-user-select: none;
            user-select: none;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .zen-shadow {
            box-shadow: 0 8px 24px rgba(149, 157, 165, 0.08);
            border: 1px solid rgba(255,255,255,0.8);
        }
        .share-btn-selected { background-color: #433D3C; color: #FFFFFF; border-color: #433D3C; }
        .share-btn-unselected { background-color: #F5F5F4; color: #A8A29E; border-color: transparent; }
        .filter-btn-active { background-color: rgba(255,255,255,0.2); color: white; font-weight: bold; border: 1px solid rgba(255,255,255,0.4); }
        .filter-btn-inactive { color: rgba(255,255,255,0.6); }
        .modal-enter { animation: slide-up-spring 0.4s ease-out forwards; }
        @keyframes slide-up-spring {
            0% { transform: translateY(100%); opacity: 0; }
            60% { transform: translateY(-10px); opacity: 1; }
            100% { transform: translateY(0); }
        }
        /* Sync & toast */
        #sync-indicator { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(67, 61, 60, 0.9); color: white; padding: 6px 16px; border-radius: 20px; font-size: 11px; font-weight: bold; z-index: 9999; backdrop-filter: blur(4px); display:flex; align-items:center; gap:6px; transition: opacity 0.3s, transform 0.3s; opacity: 0; pointer-events: none; }
        #sync-indicator.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        #sync-indicator.error { background: rgba(239, 68, 68, 0.95); }
        #toast-message { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 50px; font-size: 14px; opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 10000; }
        #toast-message.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        /* Page view helpers */
        .page-view { width:100%; height:100%; display:flex; flex-direction:column; position:absolute; top:0; left:0; background-color:var(--bg-color); transition: transform 0.3s ease-in-out, opacity 0.3s; }
        .page-hidden { transform: translateX(100%); opacity: 0; pointer-events: none; z-index: -1; }
        .page-active { transform: translateX(0); opacity: 1; z-index:10; }
    </style>
</head>
<body class="h-screen overflow-hidden bg-[#FEFDF5] relative">

    <!-- Sync -->
    <div id="sync-indicator"><i id="sync-icon" data-lucide="refresh-cw" class="w-3 h-3 animate-spin"></i><span id="sync-msg">åŒæ­¥ä¸­...</span></div>
    <div id="toast-message"></div>

    <!-- VIEW 1: TRIP LIST -->
    <div id="view-trip-list" class="page-view z-20 page-active">
        <header class="pt-safe-top px-6 py-6 pb-2 flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold text-[#433D3C] tracking-tight">My Trips âœˆï¸</h1>
                <p class="text-stone-400 text-sm font-bold mt-1">é¸æ“‡æ‚¨çš„æ—…ç¨‹æˆ–å»ºç«‹æ–°è¨ˆç•«</p>
            </div>
            <div id="user-auth-area">
                <button onclick="loginWithGoogle()" class="flex flex-col items-center gap-1 group">
                    <div class="w-10 h-10 rounded-full bg-white border border-stone-200 shadow-sm flex items-center justify-center overflow-hidden">
                        <i data-lucide="user" class="w-5 h-5 text-stone-400"></i>
                    </div>
                    <span class="text-[10px] font-bold text-stone-400 group-hover:text-[#433D3C]">ç™»å…¥å‚™ä»½</span>
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar p-6 space-y-4" id="trip-list-container"></main>

        <div class="absolute bottom-8 right-6">
            <button onclick="openAddTripModal()" class="w-14 h-14 bg-[#433D3C] rounded-full text-white shadow-xl flex items-center justify-center tap-effect hover:scale-105 transition-transform">
                <i data-lucide="plus" class="w-7 h-7"></i>
            </button>
        </div>
    </div>

    <!-- VIEW 2: TRIP DETAIL -->
    <div id="view-trip-detail" class="page-view page-hidden">
        <header class="bg-[#FEFDF5]/90 backdrop-blur-sm pt-safe-top sticky top-0 z-20 px-4 py-3 flex justify-between items-center border-b border-stone-100/50">
            <div class="flex items-center gap-3">
                <button onclick="backToTripList()" class="w-10 h-10 rounded-full bg-white border border-stone-100 flex items-center justify-center text-stone-500 tap-effect shadow-sm">
                    <i data-lucide="chevron-left" class="w-6 h-6"></i>
                </button>
                <div>
                    <p class="text-[10px] text-gray-400 tracking-widest mb-0.5 font-bold uppercase" id="header-subtitle">TRIP</p>
                    <div class="flex items-center gap-2">
                        <h1 class="text-lg font-bold tracking-wide text-[#433D3C] truncate max-w-[160px]" id="header-title">Loading...</h1>
                        <button onclick="openDateModal()" class="text-stone-400 hover:text-stone-600 tap-effect p-1"><i data-lucide="settings-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </div>

            <div class="text-right flex items-center gap-3">
                <div id="share-save-area">
                    <button onclick="openShareModal()" id="share-button" class="bg-white hover:bg-stone-50 text-stone-600 px-3 py-1.5 rounded-xl text-xs font-bold shadow-sm border border-stone-100 tap-effect hidden">
                        <i data-lucide="share-2" class="w-4 h-4 mr-1 inline-block"></i> åˆ†äº«
                    </button>
                    <button onclick="forkSharedTrip()" id="save-button" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-xl text-xs font-bold shadow-sm border border-blue-700 tap-effect hidden">
                        <i data-lucide="bookmark" class="w-4 h-4 mr-1 inline-block"></i> å„²å­˜åˆ°æˆ‘çš„è¨ˆç•«
                    </button>
                </div>

                <div class="flex flex-col items-end gap-1">
                    <div class="flex items-center gap-1 text-gray-600 bg-white px-2 py-1 rounded-full shadow-sm border border-stone-100">
                        <i data-lucide="cloud" class="w-3 h-3 text-stone-400"></i>
                        <span class="text-xs font-bold">22Â°</span>
                    </div>
                    <div class="flex items-center gap-1 mt-1">
                        <div id="status-dot" class="w-1.5 h-1.5 rounded-full bg-gray-300 transition-colors"></div>
                        <span id="status-text" class="text-[9px] text-stone-400">Connecting...</span>
                    </div>
                </div>
            </div>
        </header>

        <main id="main-content" class="flex-1 overflow-y-auto no-scrollbar pb-28 relative px-4">

            <!-- Tab 1: è¡Œç¨‹ -->
            <div id="view-schedule" class="view-section pt-2 space-y-6 animate-fade-in">
                <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2 px-1" id="day-selector"></div>

                <div class="bg-white rounded-[24px] p-4 zen-shadow border border-white overflow-hidden">
                    <div class="flex items-center gap-2 mb-3 px-1">
                        <i data-lucide="cloud-sun" class="w-4 h-4 text-blue-400"></i>
                        <span class="text-xs font-bold text-stone-500">æ¯å°æ™‚å¤©æ°£é å ±</span>
                    </div>
                    <div class="flex overflow-x-auto no-scrollbar gap-2" id="hourly-weather-container"></div>
                </div>

                <div id="timeline-container" class="space-y-4 pb-10"></div>
            </div>

            <!-- Tab 2: è³‡è¨Š -->
            <div id="view-info" class="view-section hidden pt-4 space-y-6 animate-fade-in">
                <div class="bg-white rounded-[24px] p-6 zen-shadow">
                    <h3 class="text-lg font-bold text-gray-800 mb-5 flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-500"><i data-lucide="plane-takeoff" class="w-4 h-4"></i></div>
                        èˆªç­è³‡è¨Š
                    </h3>
                    <div class="space-y-6">
                        <div class="relative pl-6 border-l-2 border-stone-100">
                            <div class="absolute -left-[7px] top-0 w-3 h-3 rounded-full bg-stone-200 border-2 border-white ring-1 ring-stone-100"></div>
                            <p class="text-xs text-stone-400 mb-1 font-bold">å»ç¨‹</p>
                            <div class="flex justify-between items-center mb-2 bg-stone-50 p-3 rounded-xl">
                                <span class="text-xl font-bold text-stone-700">HKG</span>
                                <i data-lucide="arrow-right" class="w-4 h-4 text-stone-300"></i>
                                <span class="text-xl font-bold text-stone-700">TPE</span>
                            </div>
                            <p class="text-sm text-stone-500">08:00 æŠµé” (è½æ©Ÿ)</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: è¨˜å¸³ -->
            <div id="view-budget" class="view-section hidden pt-4 space-y-6 animate-fade-in">
                <div class="bg-[#2D2A26] rounded-[24px] p-6 text-white zen-shadow relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 w-24 h-24 bg-white/5 rounded-full blur-2xl"></div>
                    <div class="flex justify-between items-start mb-4">
                        <p class="text-stone-400 text-xs font-medium tracking-wide uppercase" id="budget-title">ç¸½æ¶ˆè²» (ALL)</p>
                        <button onclick="promptAddCompanion()" class="bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-full text-[10px] flex items-center gap-1 backdrop-blur-sm transition-colors">
                            <i data-lucide="user-plus" class="w-3 h-3"></i> ç®¡ç†æ—…ä¼´
                        </button>
                    </div>

                    <div class="mb-6">
                        <div class="flex items-baseline gap-2">
                            <span class="text-lg text-stone-400 font-bold">NT$</span>
                            <h2 class="text-5xl font-bold tracking-tighter font-mono" id="total-expense-twd">0</h2>
                        </div>
                        <p class="text-stone-400 text-sm mt-1 font-medium flex items-center gap-1">
                            <span class="bg-white/10 px-2 py-0.5 rounded text-xs">ç´„ HK$ <span id="total-expense-hkd" class="font-mono">0</span></span>
                        </p>
                    </div>

                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1" id="member-filter-container"></div>
                </div>

                <div class="bg-white p-5 rounded-[24px] zen-shadow space-y-5 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-stone-200 to-white"></div>
                    <h3 class="text-stone-800 font-bold text-lg flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-600"><i data-lucide="receipt" class="w-4 h-4"></i></div>
                        è¨˜ä¸€ç­†
                    </h3>

                    <div class="bg-stone-50 rounded-2xl px-5 py-4 flex flex-col border border-transparent focus-within:border-[#433D3C] transition-all shadow-inner relative group">
                        <label class="text-[10px] text-stone-400 font-bold mb-1 uppercase">é‡‘é¡ (TWD)</label>
                        <div class="flex items-baseline">
                            <span class="text-stone-400 text-2xl mr-2 font-bold">$</span>
                            <input type="number" id="expense-amount" placeholder="0" class="flex-1 bg-transparent text-4xl focus:outline-none text-stone-800 font-mono font-bold placeholder-stone-200">
                        </div>
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 text-stone-300 font-mono text-sm pointer-events-none group-focus-within:text-stone-400 transition-colors">
                            â‰ˆ HK$ <span id="input-hkd-preview">0</span>
                        </div>
                    </div>

                    <div class="bg-stone-50 rounded-2xl px-4 py-3 flex items-center gap-2 border border-transparent focus-within:border-stone-200 transition-colors">
                        <input type="text" id="expense-item" placeholder="æ¶ˆè²»é …ç›® (ä¾‹å¦‚: æ™šé¤ã€è»Šè²»)" class="flex-1 bg-transparent text-base focus:outline-none text-stone-700 placeholder-stone-400 font-medium">
                    </div>

                    <div class="grid grid-cols-1 gap-3 bg-stone-50 p-4 rounded-2xl">
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-stone-500 font-bold flex items-center gap-1"><i data-lucide="wallet" class="w-3 h-3"></i> èª°å…ˆä»˜éŒ¢ï¼Ÿ</span>
                            <select id="expense-payer" class="bg-white text-stone-700 text-sm font-bold px-3 py-1.5 rounded-lg border-none focus:ring-0 outline-none cursor-pointer shadow-sm"></select>
                        </div>
                        <div class="h-px bg-stone-200/50 w-full"></div>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-stone-500 font-bold flex items-center gap-1"><i data-lucide="users" class="w-3 h-3"></i> èª°è¦åˆ†æ”¤ï¼Ÿ</span>
                                <button type="button" onclick="selectAllShares()" class="text-[10px] bg-blue-50 text-blue-500 font-bold px-2 py-1 rounded hover:bg-blue-100 transition-colors">å…¨é¸</button>
                            </div>
                            <div id="share-buttons-container" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>

                    <button onclick="addExpense()" class="w-full bg-[#433D3C] text-white py-4 rounded-2xl flex items-center justify-center gap-2 tap-effect shadow-lg shadow-stone-200 font-bold text-lg active:scale-[0.98] transition-transform">
                        <i data-lucide="plus" class="w-5 h-5"></i> åŠ å…¥è¨˜å¸³
                    </button>
                </div>

                <div class="flex justify-between items-end px-2">
                    <h4 class="text-stone-400 text-xs font-bold tracking-widest uppercase">äº¤æ˜“ç´€éŒ„ (HISTORY)</h4>
                    <span class="text-[10px] text-stone-300" id="list-filter-status">é¡¯ç¤ºå…¨éƒ¨</span>
                </div>

                <div id="expense-list" class="space-y-3 pb-10 min-h-[100px]"></div>
            </div>

        </main>

        <div class="fixed bottom-6 left-6 right-6 z-30">
            <nav class="bg-white/90 backdrop-blur-xl rounded-[24px] shadow-[0_8px_32px_rgba(0,0,0,0.08)] p-2 border border-white/50">
                <div class="flex justify-around items-center">
                    <button onclick="switchTab('schedule')" id="tab-schedule" class="active-tab flex items-center gap-2 px-4 py-3 tap-effect transition-all duration-300">
                        <i data-lucide="map" class="w-5 h-5"></i><span class="text-xs font-bold">è¡Œç¨‹</span>
                    </button>
                    <button onclick="switchTab('info')" id="tab-info" class="inactive-tab flex items-center gap-2 px-4 py-3 tap-effect transition-all duration-300">
                        <i data-lucide="sparkles" class="w-5 h-5"></i><span class="text-xs font-bold hidden">è³‡è¨Š</span>
                    </button>
                    <button onclick="switchTab('budget')" id="tab-budget" class="inactive-tab flex items-center gap-2 px-4 py-3 tap-effect transition-all duration-300">
                        <i data-lucide="wallet" class="w-5 h-5"></i><span class="text-xs font-bold hidden">è¨˜å¸³</span>
                    </button>
                </div>
            </nav>
        </div>
    </div>

    <!-- Modals (add/edit/share/detail/date) -->
    <div id="add-trip-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#FEFDF5] w-full max-w-sm rounded-[32px] p-6 shadow-2xl modal-enter relative">
            <h3 class="text-xl font-bold mb-6 text-[#433D3C]">å»ºç«‹æ–°æ—…ç¨‹</h3>
            <div class="space-y-4">
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">æ—…ç¨‹åç¨±</label><input type="text" id="new-trip-title" class="w-full bg-white rounded-2xl p-4 text-base font-bold border border-transparent focus:border-stone-200 focus:outline-none shadow-sm" placeholder="ä¾‹å¦‚: æ±äº¬äº”æ—¥éŠ"></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">å‡ºç™¼æ—¥æœŸ</label><input type="date" id="new-trip-date" class="w-full bg-white rounded-2xl p-4 text-base font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm"></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">å¤©æ•¸</label><input type="number" id="new-trip-days" value="3" min="1" max="30" class="w-full bg-white rounded-2xl p-4 text-base font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm"></div>
                <div class="pt-2 flex items-center gap-2">
                    <input type="checkbox" id="use-template" class="w-4 h-4 rounded text-[#433D3C] focus:ring-[#433D3C]">
                    <label for="use-template" class="text-sm text-stone-600">ä½¿ç”¨ç¯„æœ¬ (å°ç£äº”æ—¥éŠ)</label>
                </div>
            </div>
            <div class="flex gap-3 mt-6"><button onclick="closeAddTripModal()" class="flex-1 py-3 rounded-2xl bg-stone-100 text-stone-500 font-bold tap-effect">å–æ¶ˆ</button><button onclick="confirmAddTrip()" class="flex-1 py-3 rounded-2xl bg-[#433D3C] text-white font-bold tap-effect shadow-lg shadow-stone-300">å»ºç«‹</button></div>
        </div>
    </div>

    <div id="share-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#FEFDF5] w-full max-w-sm rounded-[32px] p-6 shadow-2xl modal-enter relative">
            <h3 class="text-xl font-bold mb-6 text-[#433D3C] text-center">åˆ†äº«è¡Œç¨‹ (å”ä½œæ¨¡å¼)</h3>
            <p class="text-sm text-stone-600 mb-4 text-center">ä¸€æ—¦ç™¼å¸ƒï¼Œæ‰€æœ‰æ“æœ‰æ­¤é€£çµçš„äººéƒ½å¯ä»¥å³æ™‚ç·¨è¼¯å’ŒæŸ¥çœ‹æ­¤è¡Œç¨‹ï¼</p>
            <div id="share-content"></div>
            <div class="flex gap-3 mt-6"><button onclick="closeShareModal()" class="flex-1 py-3 rounded-2xl bg-stone-100 text-stone-500 font-bold tap-effect">é—œé–‰</button></div>
        </div>
    </div>

    <div id="detail-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 hidden flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#FEFDF5] w-full max-w-md rounded-[32px] p-6 shadow-2xl modal-enter relative max-h-[85vh] overflow-y-auto no-scrollbar">
            <div class="w-12 h-1.5 bg-stone-200 rounded-full mx-auto mb-6"></div>
            <div id="detail-content" class="space-y-5"></div>
            <button onclick="closeDetailModal()" class="absolute top-6 right-6 w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-400 hover:text-stone-600 tap-effect"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 hidden flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#FEFDF5] w-full max-w-md rounded-[32px] p-6 shadow-2xl modal-enter relative max-h-[90vh] overflow-y-auto no-scrollbar">
            <h3 class="text-xl font-bold mb-6 flex justify-between items-center text-[#433D3C]">
                <span id="modal-title">ç·¨è¼¯è¡Œç¨‹</span>
                <button onclick="closeEditModal()" class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-400 hover:text-stone-600 tap-effect"><i data-lucide="x" class="w-5 h-5"></i></button>
            </h3>
            <form id="edit-form" class="space-y-4" onsubmit="saveScheduleItem(event)">
                <input type="hidden" id="edit-day-index">
                <input type="hidden" id="edit-item-index">
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">é–‹å§‹æ™‚é–“</label><input type="time" id="edit-time" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm text-center"></div>
                    <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">çµæŸæ™‚é–“ (é¸å¡«)</label><input type="time" id="edit-end-time" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm text-center text-stone-500 placeholder-stone-300"></div>
                </div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">é¡å‹</label><select id="edit-type" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm appearance-none"><option value="sight">ğŸ“· æ™¯é»</option><option value="food">ğŸœ ç¾é£Ÿ</option><option value="shop">ğŸ›ï¸ è³¼ç‰©</option><option value="transport">ğŸšŒ äº¤é€š</option><option value="stay">ğŸ›ï¸ ä½å®¿</option></select></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">æ¨™é¡Œ</label><input type="text" id="edit-title" required class="w-full bg-white rounded-2xl p-4 text-sm font-bold border border-transparent focus:border-stone-200 focus:outline-none shadow-sm" placeholder="è¡Œç¨‹åç¨±"></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">åœ°é»</label><div class="relative"><i data-lucide="map-pin" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-stone-400"></i><input type="text" id="edit-location" class="w-full bg-white rounded-2xl p-4 pl-10 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm" placeholder="è¼¸å…¥åœ°é»é—œéµå­—"></div></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">æ¨™ç±¤ (é€—è™Ÿåˆ†éš”)</label><input type="text" id="edit-tags" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm" placeholder="ä¾‹å¦‚: å¿…åƒ, æ¨è–¦"></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">ç°¡çŸ­å‚™è¨»</label><input type="text" id="edit-note" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm" placeholder="é¡¯ç¤ºåœ¨å¡ç‰‡ä¸Šçš„çŸ­å¥"></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">è©³ç´°ä»‹ç´¹ (åŒæ­¥é¡¯ç¤º)</label><textarea id="edit-description" rows="4" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm resize-none" placeholder="é€™è£¡è¼¸å…¥çš„å…§å®¹æœƒåŒæ­¥åˆ°è©³ç´°é é¢..."></textarea></div>
                <div class="pt-4"><button type="submit" class="w-full py-4 rounded-2xl bg-[#433D3C] text-[#FEFDF5] font-bold shadow-lg shadow-stone-300 tap-effect">å„²å­˜è®Šæ›´</button></div>
            </form>
        </div>
    </div>

    <div id="date-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#FEFDF5] w-full max-w-sm rounded-[32px] p-6 shadow-2xl modal-enter relative">
            <h3 class="text-lg font-bold mb-6 text-[#433D3C] text-center">è¡Œç¨‹è¨­å®š</h3>
            <div class="space-y-4">
                <div><label class="text-xs text-stone-500 font-bold ml-1 block mb-2">å‡ºç™¼æ—¥æœŸ</label><input type="date" id="start-date-input" class="w-full bg-white rounded-2xl p-4 text-lg font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm text-center text-[#433D3C]"></div>
                <div><label class="text-xs text-stone-500 font-bold ml-1 block mb-2">æ—…è¡Œç¸½å¤©æ•¸</label><div class="flex items-center gap-3 bg-white rounded-2xl p-2 shadow-sm"><button onclick="changeDays(-1)" class="w-10 h-10 rounded-xl bg-stone-100 text-stone-600 flex items-center justify-center font-bold text-xl tap-effect">-</button><input type="number" id="trip-days-input" readonly class="flex-1 text-center text-xl font-bold bg-transparent border-none focus:ring-0 text-[#433D3C]" value="5"><button onclick="changeDays(1)" class="w-10 h-10 rounded-xl bg-stone-100 text-stone-600 flex items-center justify-center font-bold text-xl tap-effect">+</button></div></div>
            </div>
            <p class="text-[10px] text-red-400 text-center mt-6 mb-2">* æ¸›å°‘å¤©æ•¸å°‡æœƒåˆªé™¤å¤šé¤˜æ—¥æœŸçš„è¡Œç¨‹</p>
            <div class="flex gap-3"><button onclick="closeDateModal()" class="flex-1 py-3 rounded-2xl bg-stone-100 text-stone-500 font-bold tap-effect">å–æ¶ˆ</button><button onclick="updateTravelDates()" class="flex-1 py-3 rounded-2xl bg-[#433D3C] text-white font-bold tap-effect shadow-lg shadow-stone-300">ç¢ºèªæ›´æ–°</button></div>
        </div>
    </div>

    <!-- Firebase Integration + Application Script -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // -----------------------
        // Firebase config (unchanged)
        // -----------------------
        const firebaseConfig = {
            apiKey: "AIzaSyDP1jX1u8TCI3TY8U3xfhEZbaMv9JLgJNw",
            authDomain: "mytaiwantrip-603c6.firebaseapp.com",
            projectId: "mytaiwantrip-603c6",
            storageBucket: "mytaiwantrip-603c6.firebasestorage.app",
            messagingSenderId: "1063667328708",
            appId: "1:1063667328708:web:d2ae7acd304e589b790b91"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // App constants
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'travel_app_v2';
        const EXCHANGE_RATE = 0.26; // TWD -> HKD approximate multiplier used across UI

        // Global state
        window.tripsList = [];
        window.scheduleData = [];
        window.expenses = [];
        window.companions = ["æˆ‘"];
        window.currentTrip = { id: null, sharedId: null, isShared: false, creatorId: null, meta: {} };
        window.currentDayIndex = 0;
        window.currentFilter = 'ALL';
        let tripUnsubscribes = [];

        // -----------------------
        // UI helpers: sync / toast
        // -----------------------
        const syncIndicator = document.getElementById('sync-indicator');
        const syncIcon = document.getElementById('sync-icon');
        const syncMsg = document.getElementById('sync-msg');
        function showSyncing() {
            syncIndicator.classList.add('show');
            syncIndicator.classList.remove('error');
            syncIcon.classList.add('animate-spin');
            syncIcon.setAttribute('data-lucide', 'refresh-cw');
            syncMsg.innerText = "åŒæ­¥ä¸­...";
            lucide.createIcons();
        }
        function showSaved() {
            syncIcon.classList.remove('animate-spin');
            syncIcon.setAttribute('data-lucide', 'check');
            syncMsg.innerText = "å·²å„²å­˜";
            lucide.createIcons();
            setTimeout(() => syncIndicator.classList.remove('show'), 1000);
        }
        function showError(msg) {
            syncIndicator.classList.add('show', 'error');
            syncIcon.classList.remove('animate-spin');
            syncIcon.setAttribute('data-lucide', 'alert-circle');
            syncMsg.innerText = msg || "å„²å­˜å¤±æ•—";
            lucide.createIcons();
        }
        window.showToast = function(message) {
            const toast = document.getElementById('toast-message');
            toast.innerText = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        };

        // -----------------------
        // Firestore path helper (dynamic public/private)
        // -----------------------
        function getTripDocRef(tripId, collectionName, forcePublic = false) {
            const docName = `${tripId}_${collectionName}`;
            if (window.currentTrip.isShared || forcePublic) {
                return doc(db, 'artifacts', appId, 'public', 'data', 'shared_trips', docName);
            } else {
                const uid = currentUser?.uid || 'anonymous';
                return doc(db, 'artifacts', appId, 'users', uid, 'travel_data', docName);
            }
        }

        // -----------------------
        // Save helpers
        // -----------------------
        window.saveToFirestore = async (type, data) => {
            if (!currentUser) {
                showToast("å°šæœªé€£ç·šï¼Œç„¡æ³•å„²å­˜");
                return;
            }
            if (!window.currentTrip.id) {
                console.warn("No trip selected, skipping save");
                return;
            }
            try {
                showSyncing();
                const docRef = getTripDocRef(window.currentTrip.id, type);
                await setDoc(docRef, { items: data, lastUpdated: new Date().toISOString() });
                showSaved();
            } catch (e) {
                console.error("Sync error:", e);
                showError();
            }
        };

        window.saveTripsIndex = async (trips) => {
            if (!currentUser) return;
            try {
                showSyncing();
                const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'travel_data', 'trips_index');
                await setDoc(docRef, { items: trips });
                showSaved();
            } catch (e) {
                console.error("Sync error (Index):", e);
                showError();
            }
        };

        window.saveTripMeta = async (tripId, meta) => {
            if (!currentUser) return;
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'travel_data', `${tripId}_meta`);
                await setDoc(docRef, meta);
            } catch (e) {
                console.error("Meta save error:", e);
            }
        };

        // -----------------------
        // Auth initialization & listeners
        // -----------------------
        let currentUser = null;
        async function initFirebase() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                }
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        updateAuthUI(user);
                        statusText.innerText = user.isAnonymous ? "Guest Mode" : (user.displayName || "User");
                        statusDot.classList.replace('bg-gray-300', 'bg-green-400');

                        const urlParams = new URLSearchParams(window.location.search);
                        const sharedTripId = urlParams.get('share');
                        if (sharedTripId) {
                            await loadSharedTrip(sharedTripId);
                            return;
                        }
                        loadTripList(user.uid);
                    } else {
                        await signInAnonymously(auth);
                    }
                });
            } catch (e) {
                console.error("Auth error:", e);
                statusText.innerText = "Offline";
                statusDot.classList.replace('bg-gray-300', 'bg-red-400');
            }
        }

        window.loginWithGoogle = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google login failed", error);
                if (error.code === 'auth/popup-blocked' || error.code === 'auth/operation-not-supported-in-this-environment') {
                    showToast("âš ï¸ ç™»å…¥å—é™: è«‹åœ¨ç€è¦½å™¨ä¸­é‹è¡Œç¨‹å¼ç¢¼ã€‚");
                } else {
                    showToast("ç™»å…¥å¤±æ•—: " + error.message);
                }
            }
        };
        window.logoutGoogle = async () => {
            showCustomConfirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ', async () => {
                await signOut(auth);
            });
        };

        function updateAuthUI(user) {
            const container = document.getElementById('user-auth-area');
            if (user.isAnonymous) {
                container.innerHTML = `
                <button onclick="loginWithGoogle()" class="flex flex-col items-center gap-1 group">
                    <div class="w-10 h-10 rounded-full bg-white border border-stone-200 shadow-sm flex items-center justify-center overflow-hidden transition-all group-hover:border-blue-300">
                        <i data-lucide="user" class="w-5 h-5 text-stone-400 group-hover:text-blue-500"></i>
                    </div>
                    <span class="text-[10px] font-bold text-stone-400 group-hover:text-blue-500">ç™»å…¥å‚™ä»½</span>
                </button>`;
            } else {
                const photoURL = user.photoURL || '';
                const initial = user.displayName ? user.displayName[0] : 'U';
                container.innerHTML = `
                <button onclick="logoutGoogle()" class="flex flex-col items-center gap-1 group">
                    <div class="w-10 h-10 rounded-full bg-stone-100 border-2 border-green-400 shadow-sm flex items-center justify-center overflow-hidden">
                        ${photoURL ? `<img src="${photoURL}" class="w-full h-full object-cover">` : `<span class="text-stone-600 font-bold">${initial}</span>`}
                    </div>
                    <span class="text-[10px] font-bold text-stone-600 group-hover:text-red-400">${user.displayName || user.uid.substring(0, 4)}</span>
                </button>`;
            }
            lucide.createIcons();
        }

        // -----------------------
        // Trip list & listeners
        // -----------------------
        function loadTripList(uid) {
            const indexRef = doc(db, 'artifacts', appId, 'users', uid, 'travel_data', 'trips_index');
            onSnapshot(indexRef, (docSnap) => {
                const privateTripId = new URLSearchParams(window.location.search).get('id');
                if (docSnap.exists()) {
                    window.tripsList = docSnap.data().items || [];
                } else {
                    window.tripsList = [];
                }
                renderTripListUI();
                if (window.currentTrip.id === null && privateTripId) {
                    const trip = window.tripsList.find(t => t.id === privateTripId);
                    if (trip) {
                        openTrip(privateTripId);
                        return;
                    } else {
                        history.pushState(null, '', window.location.pathname);
                    }
                }
                if (window.currentTrip.id === null) {
                    document.getElementById('view-trip-list').classList.add('page-active');
                    document.getElementById('view-trip-detail').classList.add('page-hidden');
                }
            });
        }

        async function loadSharedTrip(sharedTripId) {
            const metaRef = getTripDocRef(sharedTripId, 'meta', true);
            const metaSnap = await getDoc(metaRef);
            if (!metaSnap.exists()) {
                window.showToast("åˆ†äº«çš„è¡Œç¨‹ä¸å­˜åœ¨æˆ–å·²è¢«ç§»é™¤ã€‚");
                backToTripList();
                return;
            }
            const meta = metaSnap.data();
            window.currentTrip = { id: sharedTripId, sharedId: sharedTripId, isShared: true, creatorId: meta.creatorId, meta: meta };
            history.pushState(null, '', `${window.location.pathname}?share=${sharedTripId}`);
            document.getElementById('header-title').innerText = meta.title;
            document.getElementById('header-subtitle').innerText = "SHARED TRIP";
            const isCreator = currentUser && currentUser.uid === meta.creatorId;
            document.getElementById('share-button').classList.toggle('hidden', !isCreator);
            document.getElementById('save-button').classList.toggle('hidden', isCreator);
            document.getElementById('view-trip-list').classList.remove('page-active');
            document.getElementById('view-trip-list').classList.add('page-hidden');
            document.getElementById('view-trip-detail').classList.remove('page-hidden');
            document.getElementById('view-trip-detail').classList.add('page-active');
            startTripListeners(sharedTripId);
        }

        function startTripListeners(tripId) {
            tripUnsubscribes.forEach(unsub => unsub());
            tripUnsubscribes = [];
            const types = ['schedule', 'expenses', 'companions'];
            types.forEach(type => {
                const docRef = getTripDocRef(tripId, type);
                const unsub = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data().items;
                        if (type === 'schedule') {
                            window.scheduleData = data || [];
                            renderDaySelector();
                            renderTimeline(window.currentDayIndex);
                        } else if (type === 'expenses') {
                            window.expenses = data || [];
                            renderExpenses();
                        } else if (type === 'companions') {
                            window.companions = data || ["æˆ‘"];
                            updatePayerSelect();
                            renderShareButtons();
                            renderFilter();
                        }
                    } else {
                        if (type === 'schedule') window.scheduleData = [];
                        if (type === 'expenses') window.expenses = [];
                        if (type === 'companions') window.companions = ["æˆ‘"];
                    }

                    if (!window.currentTrip.isShared && type === 'schedule' && window.scheduleData.length > 0) {
                        const trip = window.tripsList.find(t => t.id === tripId);
                        if (trip && trip.days !== window.scheduleData.length) {
                            trip.days = window.scheduleData.length;
                            trip.startDate = `${window.scheduleData[0].month}/${window.scheduleData[0].date}`;
                            window.saveTripsIndex(window.tripsList);
                        }
                    }
                }, (error) => {
                    console.error(`Read error (${type}):`, error);
                });
                tripUnsubscribes.push(unsub);
            });
        }

        function openTrip(tripId) {
            const trip = window.tripsList.find(t => t.id === tripId);
            if (!trip) return;
            if (trip.isShared) {
                loadSharedTrip(tripId);
                return;
            }
            window.currentTrip = { id: tripId, sharedId: trip.sharedId || null, isShared: false, creatorId: trip.creatorId || currentUser?.uid, meta: trip };
            document.getElementById('header-title').innerText = trip.title;
            document.getElementById('header-subtitle').innerText = "TRIP";
            document.getElementById('share-button').classList.remove('hidden');
            document.getElementById('save-button').classList.add('hidden');
            startTripListeners(tripId);
            history.pushState(null, '', `${window.location.pathname}?id=${tripId}`);
            document.getElementById('view-trip-list').classList.remove('page-active');
            document.getElementById('view-trip-list').classList.add('page-hidden');
            document.getElementById('view-trip-detail').classList.remove('page-hidden');
            document.getElementById('view-trip-detail').classList.add('page-active');
        }

        function backToTripList() {
            history.pushState(null, '', window.location.pathname);
            window.currentTrip = { id: null, sharedId: null, isShared: false, creatorId: null, meta: {} };
            document.getElementById('share-button').classList.add('hidden');
            document.getElementById('save-button').classList.add('hidden');
            document.getElementById('view-trip-detail').classList.remove('page-active');
            document.getElementById('view-trip-detail').classList.add('page-hidden');
            document.getElementById('view-trip-list').classList.remove('page-hidden');
            document.getElementById('view-trip-list').classList.add('page-active');
        }

        // -----------------------
        // Sharing / publishing
        // -----------------------
        const shareModal = document.getElementById('share-modal');
        const shareContent = document.getElementById('share-content');
        window.openShareModal = function() {
            if (!window.currentTrip.id) return showToast("è«‹å…ˆé¸æ“‡ä¸€å€‹è¡Œç¨‹");
            if (!window.currentTrip.meta.isShared) {
                publishTripForSharing();
            } else {
                renderShareLink(window.currentTrip.id);
            }
            shareModal.classList.remove('hidden');
            lucide.createIcons();
        };
        window.closeShareModal = function() { shareModal.classList.add('hidden'); };
        shareModal.addEventListener('click', (e) => { if (e.target === shareModal) closeShareModal(); });

        async function publishTripForSharing() {
            if (!currentUser) return showToast("è«‹å…ˆç™»å…¥æ‰èƒ½åˆ†äº«è¡Œç¨‹");
            const tripId = window.currentTrip.id;
            const meta = window.currentTrip.meta;
            const sharedMeta = { ...meta, creatorId: currentUser.uid, isShared: true, createdAt: meta.createdAt || new Date().toISOString() };
            try {
                showSyncing();
                const metaRef = getTripDocRef(tripId, 'meta', true);
                await setDoc(metaRef, sharedMeta);
                const originalIsShared = window.currentTrip.isShared;
                window.currentTrip.isShared = true;
                window.currentTrip.sharedId = tripId;
                await window.saveToFirestore('schedule', window.scheduleData);
                await window.saveToFirestore('expenses', window.expenses);
                await window.saveToFirestore('companions', window.companions);
                window.currentTrip.isShared = originalIsShared;
                showSaved();
                window.showToast("âœ… è¡Œç¨‹å·²æˆåŠŸç™¼å¸ƒç‚ºå”ä½œæ¨¡å¼ï¼");
                const tripIndex = window.tripsList.findIndex(t => t.id === tripId);
                if (tripIndex !== -1) {
                    window.tripsList[tripIndex].isShared = true;
                    window.tripsList[tripIndex].sharedId = tripId;
                    window.tripsList[tripIndex].creatorId = currentUser.uid;
                    await window.saveTripsIndex(window.tripsList);
                }
                window.currentTrip.meta = sharedMeta;
                window.currentTrip.sharedId = tripId;
                renderShareLink(tripId);
                history.pushState(null, '', `${window.location.pathname}?share=${tripId}`);
            } catch (e) {
                console.error("Publish error:", e);
                showError("ç™¼å¸ƒå¤±æ•—");
            }
        }

        function renderShareLink(tripId) {
            const shareLink = `${window.location.origin}${window.location.pathname}?share=${tripId}`;
            shareContent.innerHTML = `
                <div class="bg-stone-100 p-4 rounded-xl flex flex-col gap-2 mb-4">
                    <p class="text-xs text-stone-500 font-bold uppercase">å”ä½œé€£çµ</p>
                    <input type="text" id="share-link-input" value="${shareLink}" readonly class="w-full bg-stone-50 text-stone-700 font-mono text-sm p-2 rounded-lg border-none focus:outline-none">
                </div>
                <div class="flex flex-col gap-3">
                    <button onclick="copyShareLink('${shareLink}')" class="w-full py-3 rounded-2xl bg-blue-600 text-white font-bold tap-effect shadow-md shadow-blue-200 flex items-center justify-center gap-2">
                        <i data-lucide="copy" class="w-4 h-4"></i> è¤‡è£½é€£çµ
                    </button>
                    <button onclick="window.location.href = 'mailto:?subject=é‚€è«‹ä½ ä¸€èµ·è¦åŠƒè¡Œç¨‹ï¼š${encodeURIComponent(window.currentTrip.meta.title || '')}&body=é»æ“Šæ­¤é€£çµåŠ å…¥å”ä½œï¼š${encodeURIComponent(shareLink)}'" class="w-full py-3 rounded-2xl bg-stone-200 text-stone-700 font-bold tap-effect flex items-center justify-center gap-2">
                        <i data-lucide="mail" class="w-4 h-4"></i> é›»éƒµåˆ†äº«
                    </button>
                </div>
            `;
            lucide.createIcons();
        }

        window.copyShareLink = function(link) {
            const el = document.createElement('textarea');
            el.value = link;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            window.showToast("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
            closeShareModal();
        };

        // -----------------------
        // Forking (bookmark shared)
        // -----------------------
        window.forkSharedTrip = async function() {
            if (!currentUser) return showToast("è«‹å…ˆç™»å…¥æˆ–è¨»å†Šæ‰èƒ½å„²å­˜è¡Œç¨‹ï¼");
            if (!window.currentTrip.isShared) return;
            const sharedId = window.currentTrip.id;
            if (window.tripsList.some(t => t.sharedId === sharedId && t.isShared)) {
                return window.showToast("æ­¤å”ä½œè¡Œç¨‹å·²å„²å­˜åˆ°æ‚¨çš„è¨ˆç•«ä¸­ã€‚");
            }
            showCustomConfirm(`ç¢ºå®šè¦å°‡ã€Œ${window.currentTrip.meta.title}ã€å„²å­˜ç‚ºå”ä½œé€£çµåˆ°æ‚¨çš„è¨ˆç•«ä¸­å—ï¼Ÿ`, async () => {
                const newTripMeta = {
                    id: sharedId,
                    title: window.currentTrip.meta.title,
                    startDate: window.currentTrip.meta.startDate,
                    days: window.currentTrip.meta.days,
                    isShared: true,
                    sharedId: sharedId,
                    creatorId: window.currentTrip.creatorId,
                    bookmarkedAt: new Date().toISOString()
                };
                try {
                    showSyncing();
                    window.tripsList.push(newTripMeta);
                    await window.saveTripsIndex(window.tripsList);
                    showSaved();
                    window.showToast(`âœ… å·²å°‡è¡Œç¨‹ã€Œ${newTripMeta.title}ã€å„²å­˜ç‚ºå”ä½œé€£çµï¼`);
                } catch (e) {
                    console.error("Fork error:", e);
                    showError("å„²å­˜å¤±æ•—");
                }
            });
        };

        // -----------------------
        // Custom confirm modal
        // -----------------------
        function showCustomConfirm(message, onConfirm) {
            const modalHtml = `
                <div id="custom-confirm-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div class="bg-[#FEFDF5] w-full max-w-xs rounded-[24px] p-6 modal-enter relative">
                        <p class="text-sm font-bold text-stone-700 mb-6 text-center">${message}</p>
                        <div class="flex gap-3">
                            <button id="confirm-cancel" class="flex-1 py-3 rounded-xl bg-stone-100 text-stone-500 font-bold tap-effect">å–æ¶ˆ</button>
                            <button id="confirm-ok" class="flex-1 py-3 rounded-xl bg-red-500 text-white font-bold tap-effect shadow-md shadow-red-200">ç¢ºå®š</button>
                        </div>
                    </div>
                </div>`;
            const wrapper = document.createElement('div');
            wrapper.innerHTML = modalHtml;
            document.body.appendChild(wrapper);
            const modal = document.getElementById('custom-confirm-modal');
            document.getElementById('confirm-cancel').onclick = () => { modal.remove(); };
            document.getElementById('confirm-ok').onclick = () => { onConfirm(); modal.remove(); };
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        }

        // -----------------------
        // Trip UI rendering
        // -----------------------
        window.renderTripListUI = function() {
            const container = document.getElementById('trip-list-container');
            if (!window.tripsList || window.tripsList.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-center mt-10">
                        <div class="w-20 h-20 bg-stone-100 rounded-full flex items-center justify-center text-stone-300 mb-4"><i data-lucide="map" class="w-10 h-10"></i></div>
                        <h3 class="text-xl font-bold text-stone-600">é‚„æ²’æœ‰æ—…ç¨‹</h3>
                        <p class="text-stone-400 text-sm mt-2">é»æ“Šå³ä¸‹è§’çš„ + é–‹å§‹è¦åŠƒå§ï¼</p>
                    </div>`;
            } else {
                container.innerHTML = window.tripsList.map((trip, idx) => {
                    const days = trip.days || '?';
                    const bgClass = `trip-card-bg-${idx % 4}`;
                    const isSharedText = trip.isShared ? `<div class="text-[10px] font-bold text-white/80 bg-black/20 px-2 py-0.5 rounded-full absolute top-3 left-3 flex items-center gap-1"><i data-lucide="users" class="w-3 h-3"></i> å”ä½œ</div>` : '';
                    return `
                        <div onclick="openTrip('${trip.id}')" class="relative group w-full ${bgClass} rounded-[24px] p-6 shadow-lg transform transition-all tap-effect overflow-hidden cursor-pointer min-h-[140px] flex flex-col justify-between">
                            ${isSharedText}
                            <div class="absolute top-0 right-0 p-3 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="event.stopPropagation(); deleteTrip('${trip.id}')" class="w-8 h-8 bg-white/30 backdrop-blur-md rounded-full flex items-center justify-center text-white hover:bg-red-500 hover:text-white transition-colors">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold text-white mb-1 drop-shadow-sm leading-tight">${trip.title}</h3>
                                <div class="flex items-center gap-2 text-white/90 text-xs font-bold bg-black/10 w-fit px-2 py-1 rounded-lg backdrop-blur-sm">
                                    <i data-lucide="calendar" class="w-3 h-3"></i> ${trip.startDate || ''}
                                </div>
                            </div>
                            <div class="flex items-end justify-between mt-4">
                                <div class="flex -space-x-2">
                                     <div class="w-8 h-8 rounded-full bg-white/90 border-2 border-white flex items-center justify-center text-xs font-bold text-stone-500">æˆ‘</div>
                                </div>
                                <span class="text-white font-bold text-4xl opacity-80">${days}<span class="text-sm ml-1">Days</span></span>
                            </div>
                        </div>`;
                }).join('');
            }
            lucide.createIcons();
        };

        // Add trip modal helpers
        const addTripModal = document.getElementById('add-trip-modal');
        window.openAddTripModal = function() { addTripModal.classList.remove('hidden'); };
        window.closeAddTripModal = function() { addTripModal.classList.add('hidden'); };

        window.confirmAddTrip = async function() {
            const title = document.getElementById('new-trip-title').value;
            const startDate = document.getElementById('new-trip-date').value;
            const days = parseInt(document.getElementById('new-trip-days').value);
            const useTemplate = document.getElementById('use-template').checked;
            if (!title || !startDate) return window.showToast("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");
            const newId = 'trip_' + Date.now();
            const newTripMeta = {
                id: newId,
                title: title,
                startDate: startDate,
                days: days,
                isShared: false,
                creatorId: currentUser?.uid || 'anonymous',
                createdAt: new Date().toISOString()
            };
            let initialSchedule = [];
            const start = new Date(startDate.replace(/-/g, '/'));
            for (let i=0; i<days; i++) {
                const dt = new Date(start);
                dt.setDate(start.getDate()+i);
                let items = [];
                if (useTemplate && window.templateScheduleData && window.templateScheduleData[i]) {
                    items = window.templateScheduleData[i].items;
                }
                initialSchedule.push({ date: dt.getDate(), month: dt.getMonth()+1, day: `Day ${i+1}`, items });
            }
            window.tripsList.push(newTripMeta);
            window.renderTripListUI();
            closeAddTripModal();
            const prevContext = window.currentTrip;
            window.currentTrip = { id: newId, isShared: false, meta: newTripMeta };
            await window.saveTripMeta(newId, newTripMeta);
            await window.saveToFirestore('schedule', initialSchedule);
            await window.saveToFirestore('expenses', []);
            await window.saveToFirestore('companions', ["æˆ‘"]);
            window.currentTrip = prevContext;
            await window.saveTripsIndex(window.tripsList);
            openTrip(newId);
        };

        window.deleteTrip = async function(tripId) {
            showCustomConfirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹æ—…ç¨‹å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚", async () => {
                window.tripsList = window.tripsList.filter(t => t.id !== tripId);
                window.renderTripListUI();
                await window.saveTripsIndex(window.tripsList);
                window.showToast("è¡Œç¨‹å·²ç§»é™¤");
            });
        };

        // -----------------------
        // Rendering schedule / timeline
        // -----------------------
        window.renderDaySelector = function() {
            const c = document.getElementById('day-selector');
            if (!window.scheduleData || window.scheduleData.length === 0) { c.innerHTML = ""; return; }
            if (window.currentDayIndex >= window.scheduleData.length) window.currentDayIndex = 0;
            c.innerHTML = window.scheduleData.map((d, i) => `<button onclick="selectDay(${i})" class="day-btn flex-shrink-0 flex flex-col items-center justify-center w-[60px] h-[72px] rounded-2xl transition-all border border-transparent tap-effect ${i===window.currentDayIndex?'bg-[#433D3C] text-[#FEFDF5] shadow-lg shadow-stone-200':'bg-white text-stone-300'}"><span class="text-[10px] font-bold tracking-wide opacity-80">${d.day}</span><span class="text-xl font-bold font-mono mt-1">${d.month}/${d.date}</span></button>`).join('');
        };

        window.selectDay = function(i) {
            window.currentDayIndex = i;
            document.querySelectorAll('.day-btn').forEach((b, idx) => { b.className = `day-btn flex-shrink-0 flex flex-col items-center justify-center w-[60px] h-[72px] rounded-2xl transition-all border border-transparent tap-effect ${idx===i?'bg-[#433D3C] text-[#FEFDF5] shadow-lg shadow-stone-200 transform scale-105':'bg-white text-stone-300'}`; });
            window.renderTimeline(i);
            generateHourlyWeather();
        };

        window.renderTimeline = function(i) {
            const c = document.getElementById('timeline-container');
            if (!window.scheduleData[i]) {
                c.innerHTML = `<div class="text-center text-stone-300 py-10">å°šç„¡è¡Œç¨‹</div>`;
                return;
            }
            const d = window.scheduleData[i];
            if (!d.items) d.items = [];
            d.items.sort((a,b)=> (a.time || '').localeCompare(b.time || ''));
            let html = d.items.map((item, idx) => {
                let icon = item.type==='food'?'utensils':item.type==='transport'?'bus':item.type==='shop'?'shopping-bag':item.type==='stay'?'bed':'map-pin';
                let color = item.type==='food'?'text-orange-500 bg-orange-50':item.type==='transport'?'text-blue-500 bg-blue-50':item.type==='shop'?'text-pink-500 bg-pink-50':item.type==='stay'?'text-purple-500 bg-purple-50':'text-stone-500 bg-stone-100';
                const tags = (item.tags || []).map(t => `<span class="text-xs text-stone-400 bg-stone-50 px-2 py-1 rounded-lg">${t}</span>`).join('');
                return `<div class="bg-white rounded-[20px] p-4 zen-shadow border border-stone-100 mb-2">
                    <div class="flex items-start justify-between gap-3">
                        <div class="flex items-start gap-3">
                            <div class="w-12 h-12 rounded-2xl bg-stone-50 flex items-center justify-center text-stone-600"><i data-lucide="${icon}" class="w-6 h-6"></i></div>
                            <div>
                                <div class="text-sm text-stone-400">${item.time || ''}${item.endTime ? ' - ' + item.endTime : ''}</div>
                                <div class="text-lg font-bold text-stone-800">${item.title}</div>
                                <div class="mt-2 flex flex-wrap gap-2">${tags}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <button onclick="openEditModal(${i}, ${idx}); event.stopPropagation()" class="px-3 py-1.5 bg-stone-100 rounded-lg text-xs font-bold text-stone-500 tap-effect">ç·¨è¼¯</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
            html += `<button onclick="openAddModal(${i})" class="w-full py-4 rounded-[24px] border-2 border-dashed border-stone-200 text-stone-300 hover:border-stone-300 hover:text-stone-500 transition-all flex items-center justify-center gap-2 tap-effect mt-2 bg-white/50"><i data-lucide="plus" class="w-5 h-5"></i><span class="font-bold">æ–°å¢è¡Œç¨‹</span></button>`;
            c.innerHTML = html;
            lucide.createIcons();
        };

        // Edit modal helpers
        const editModal = document.getElementById('edit-modal');
        window.openAddModal = function(dayIndex) {
            document.getElementById('edit-day-index').value = dayIndex;
            document.getElementById('edit-item-index').value = -1;
            document.getElementById('modal-title').innerText = "æ–°å¢è¡Œç¨‹";
            document.getElementById('edit-time').value = "12:00";
            document.getElementById('edit-end-time').value = "";
            document.getElementById('edit-type').value = "sight";
            document.getElementById('edit-title').value = "";
            document.getElementById('edit-location').value = "";
            document.getElementById('edit-tags').value = "";
            document.getElementById('edit-note').value = "";
            document.getElementById('edit-description').value = "";
            editModal.classList.remove('hidden');
        };
        window.openEditModal = function(dayIndex, itemIndex) {
            const item = window.scheduleData[dayIndex].items[itemIndex];
            document.getElementById('edit-day-index').value = dayIndex;
            document.getElementById('edit-item-index').value = itemIndex;
            document.getElementById('modal-title').innerText = "ç·¨è¼¯è¡Œç¨‹";
            document.getElementById('edit-time').value = item.time || "";
            document.getElementById('edit-end-time').value = item.endTime || "";
            document.getElementById('edit-type').value = item.type || "sight";
            document.getElementById('edit-title').value = item.title || "";
            document.getElementById('edit-location').value = item.location || "";
            document.getElementById('edit-tags').value = (item.tags || []).join(', ');
            document.getElementById('edit-note').value = item.note || "";
            document.getElementById('edit-description').value = item.description || "";
            editModal.classList.remove('hidden');
        };
        window.closeEditModal = function() { editModal.classList.add('hidden'); };
        window.saveScheduleItem = function(e) {
            e.preventDefault();
            const d = parseInt(document.getElementById('edit-day-index').value);
            const i = parseInt(document.getElementById('edit-item-index').value);
            const item = {
                time: document.getElementById('edit-time').value,
                endTime: document.getElementById('edit-end-time').value,
                type: document.getElementById('edit-type').value,
                title: document.getElementById('edit-title').value,
                location: document.getElementById('edit-location').value,
                tags: document.getElementById('edit-tags').value.split(',').map(t => t.trim()).filter(t => t),
                note: document.getElementById('edit-note').value,
                description: document.getElementById('edit-description').value
            };
            if (i === -1) window.scheduleData[d].items.push(item); else window.scheduleData[d].items[i] = item;
            window.saveToFirestore('schedule', window.scheduleData);
            window.renderTimeline(d);
            closeEditModal();
        };
        window.deleteScheduleItem = function(d, i) {
            showCustomConfirm("ç¢ºå®šåˆªé™¤ï¼Ÿ", () => {
                window.scheduleData[d].items.splice(i, 1);
                window.saveToFirestore('schedule', window.scheduleData);
                window.renderTimeline(d);
            });
        };

        // -----------------------
        // Budget / Expenses helpers (clean, no duplicates)
        // -----------------------
        window.updatePayerSelect = function () {
            const sel = document.getElementById('expense-payer');
            sel.innerHTML = window.companions.map(c => `<option value="${c}">${c}</option>`).join('');
        };

        window.renderShareButtons = function () {
            const container = document.getElementById('share-buttons-container');
            container.innerHTML = window.companions.map(c => `<button type="button" class="share-toggle-btn share-btn-selected px-3 py-1.5 rounded-lg text-xs font-bold border transition-colors" data-name="${c}" onclick="toggleShare(this)">${c}</button>`).join('');
            lucide.createIcons();
        };

        window.toggleShare = function (btn) {
            btn.classList.toggle('share-btn-selected');
            btn.classList.toggle('share-btn-unselected');
        };

        window.selectAllShares = function () {
            document.querySelectorAll('.share-toggle-btn').forEach(btn => {
                btn.classList.remove('share-btn-unselected');
                btn.classList.add('share-btn-selected');
            });
        };

        window.setFilter = function(name) {
            window.currentFilter = name;
            window.renderExpenses();
        };

        window.renderFilter = function() {
            const c = document.getElementById('member-filter-container');
            let h = `<button onclick="setFilter('ALL')" class="flex-shrink-0 px-4 py-1.5 rounded-full text-xs transition-all ${window.currentFilter === 'ALL' ? 'filter-btn-active' : 'filter-btn-inactive'}">å…¨é«”</button>`;
            window.companions.forEach(n => {
                h += `<button onclick="setFilter('${n}')" class="flex-shrink-0 px-4 py-1.5 rounded-full text-xs transition-all ${window.currentFilter === n ? 'filter-btn-active' : 'filter-btn-inactive'}">${n}</button>`;
            });
            c.innerHTML = h;
        };

        // Render expenses list and totals
        window.renderExpenses = function() {
            const list = document.getElementById('expense-list');
            const totalTwdEl = document.getElementById('total-expense-twd');
            const totalHkdEl = document.getElementById('total-expense-hkd');
            const titleEl = document.getElementById('budget-title');
            const listStatusEl = document.getElementById('list-filter-status');

            let displayExpenses = [];
            let totalTWD = 0;

            if (window.currentFilter === 'ALL') {
                displayExpenses = window.expenses || [];
                titleEl.innerText = "ç¸½æ¶ˆè²» (ALL)";
                listStatusEl.innerText = "é¡¯ç¤ºå…¨éƒ¨";
                totalTWD = (window.expenses || []).reduce((sum, ex) => sum + parseInt(ex.amount || 0, 10), 0);
            } else {
                titleEl.innerText = `å€‹äººæ¶ˆè²» (${window.currentFilter})`;
                listStatusEl.innerText = `åªé¡¯ç¤º ${window.currentFilter} çš„åˆ†æ”¤é …ç›®`;
                displayExpenses = (window.expenses || []).filter(ex => (ex.sharedBy || []).includes(window.currentFilter));
                totalTWD = displayExpenses.reduce((sum, ex) => {
                    const sharersCount = (ex.sharedBy && ex.sharedBy.length > 0) ? ex.sharedBy.length : 1;
                    return sum + (parseInt(ex.amount || 0, 10) / sharersCount);
                }, 0);
            }

            const html = (displayExpenses.map((ex) => {
                const originalIndex = window.expenses.indexOf(ex);
                const fullAmount = parseInt(ex.amount || 0, 10);
                let displayAmount = fullAmount;
                let displayLabel = "ç¸½é¡";
                let detailText = "";
                let amountClass = "text-stone-800";
                if (window.currentFilter !== 'ALL') {
                    const sharersCount = (ex.sharedBy && ex.sharedBy.length > 0) ? ex.sharedBy.length : 1;
                    displayAmount = fullAmount / sharersCount;
                    displayLabel = "æ‡‰ä»˜";
                    detailText = `(ç¸½é¡ $${fullAmount} Ã· ${sharersCount}äºº)`;
                    amountClass = "text-blue-600";
                }
                const amountHKD = Math.round(displayAmount * EXCHANGE_RATE);
                const amountTWD = Math.round(displayAmount);
                const payer = ex.payer || "æˆ‘";
                const sharedBy = ex.sharedBy || ["æˆ‘"];
                const shareText = sharedBy.length === window.companions.length ? "å…¨å“¡" : sharedBy.join(",");
                return `<div class="flex flex-col bg-white p-4 rounded-[20px] shadow-sm border border-stone-100">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="text-base font-bold text-stone-700 block">${ex.item}</span>
                            <span class="text-[10px] text-stone-400">ç”± ${payer} å…ˆä»˜ â€¢ åˆ†æ”¤: ${shareText}</span>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-stone-300 font-bold mb-0.5 text-right">${displayLabel}</div>
                            <div class="font-mono font-bold ${amountClass} text-lg">NT$ ${amountTWD}</div>
                            <div class="font-mono text-xs text-stone-400">â‰ˆ HK$ ${amountHKD}</div>
                            ${detailText ? `<div class="text-[10px] text-stone-400 mt-0.5">${detailText}</div>` : ''}
                        </div>
                    </div>
                    <div class="flex justify-end border-t border-stone-50 pt-2 mt-1">
                        <button onclick="deleteExpense(${originalIndex})" class="text-xs text-stone-300 hover:text-red-400 flex items-center gap-1 px-2 py-1 rounded tap-effect"><i data-lucide="trash-2" class="w-3 h-3"></i> åˆªé™¤</button>
                    </div>
                </div>`;
            }).reverse().join('')) || `<div class="text-center text-stone-300 text-sm py-8">æ²’æœ‰ç›¸é—œç´€éŒ„</div>`;

            list.innerHTML = html;
            totalTwdEl.innerText = Math.round(totalTWD).toLocaleString();
            totalHkdEl.innerText = Math.round(totalTWD * EXCHANGE_RATE).toLocaleString();
            window.renderFilter();
            lucide.createIcons();
        };

        // -----------------------
        // addExpense (å”¯ä¸€ä¸”ä¿®æ­£ç‰ˆ)
        // -----------------------
        window.addExpense = function () {
            const item = document.getElementById('expense-item').value.trim();
            const amountInput = document.getElementById('expense-amount').value;
            const amount = parseInt(amountInput, 10);
            const payer = document.getElementById('expense-payer').value || (window.companions[0] || 'æˆ‘');

            const shareBtns = document.querySelectorAll('.share-toggle-btn.share-btn-selected');
            const sharedBy = Array.from(shareBtns).map(btn => btn.getAttribute('data-name'));

            // Basic validations
            if (!item) return window.showToast("è«‹è¼¸å…¥é …ç›®");
            if (!amountInput || isNaN(amount) || amount <= 0) return window.showToast("è«‹è¼¸å…¥æ­£ç¢ºé‡‘é¡");
            if (sharedBy.length === 0) return window.showToast("è«‹è‡³å°‘é¸æ“‡ä¸€ä½åˆ†æ”¤å°è±¡");

            // Push to local state
            window.expenses.push({ item, amount, payer, sharedBy });

            // Clear inputs
            document.getElementById('expense-item').value = '';
            document.getElementById('expense-amount').value = '';
            document.getElementById('input-hkd-preview').innerText = '0';

            // Persist and re-render
            window.saveToFirestore('expenses', window.expenses);
            if (typeof window.renderExpenses === "function") window.renderExpenses();

            window.showToast("å·²åŠ å…¥è¨˜å¸³");
        };

        window.deleteExpense = function (index) {
            showCustomConfirm('ç¢ºå®šåˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ', () => {
                window.expenses.splice(index, 1);
                window.saveToFirestore('expenses', window.expenses);
                if (typeof window.renderExpenses === "function") window.renderExpenses();
            });
        };

        window.promptAddCompanion = function() {
            const name = prompt("è«‹è¼¸å…¥æ—…ä¼´åå­—ï¼š");
            if (name && name.trim() !== "") {
                if (!window.companions.includes(name.trim())) {
                    window.companions.push(name.trim());
                    window.saveToFirestore('companions', window.companions);
                } else {
                    window.showToast("å·²ç¶“åœ¨åå–®å…§å›‰ï¼");
                }
            }
        };

        // -----------------------
        // Date/days helpers
        // -----------------------
        const dateModal = document.getElementById('date-modal');
        window.openDateModal = function() {
            document.getElementById('start-date-input').value = window.currentTrip.meta.startDate || new Date().toISOString().split('T')[0];
            document.getElementById('trip-days-input').value = window.scheduleData.length || 3;
            dateModal.classList.remove('hidden');
        };
        window.closeDateModal = function() { dateModal.classList.add('hidden'); };
        window.changeDays = function(delta) {
            let v = parseInt(document.getElementById('trip-days-input').value) + delta;
            if (v < 1) v = 1;
            document.getElementById('trip-days-input').value = v;
        };
        window.updateTravelDates = function() {
            const dStr = document.getElementById('start-date-input').value;
            const days = parseInt(document.getElementById('trip-days-input').value);
            if (!dStr) return window.showToast("è«‹é¸æ“‡æ—¥æœŸ");
            const start = new Date(dStr.replace(/-/g, '/'));
            const oldLength = window.scheduleData.length;
            if (days > oldLength) {
                for (let i = oldLength; i < days; i++) window.scheduleData.push({ date: "", month: "", day: `Day ${i+1}`, items: [] });
            } else if (days < oldLength) {
                if (!confirm(`ç¢ºå®šæ¸›å°‘å¤©æ•¸ï¼Ÿ`)) return;
                window.scheduleData.length = days;
            }
            window.scheduleData.forEach((d, i) => {
                const dt = new Date(start);
                dt.setDate(start.getDate() + i);
                d.date = dt.getDate();
                d.month = dt.getMonth() + 1;
                d.day = `Day ${i+1}`;
            });
            window.saveToFirestore('schedule', window.scheduleData);
            if (!window.currentTrip.isShared) {
                const tripIndex = window.tripsList.findIndex(t => t.id === window.currentTrip.id);
                if (tripIndex !== -1) {
                    window.tripsList[tripIndex].days = days;
                    window.tripsList[tripIndex].startDate = dStr;
                    window.currentTrip.meta = window.tripsList[tripIndex];
                    window.saveTripsIndex(window.tripsList);
                    window.saveTripMeta(window.currentTrip.id, window.currentTrip.meta);
                }
            }
            window.renderDaySelector();
            window.renderTimeline(0);
            closeDateModal();
        };

        window.switchTab = function(tabId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            ['schedule','info','budget'].forEach(id => {
                const btn = document.getElementById(`tab-${id}`);
                const span = btn.querySelector('span');
                if (id === tabId) {
                    btn.className = "active-tab flex items-center gap-2 px-5 py-3 tap-effect transition-all duration-300";
                    span.classList.remove('hidden');
                } else {
                    btn.className = "inactive-tab flex items-center gap-2 px-3 py-3 tap-effect transition-all duration-300";
                    span.classList.add('hidden');
                }
            });
        };

        function generateHourlyWeather() {
            const ws = [{i:'sun',t:22},{i:'cloud-sun',t:24},{i:'cloud',t:23},{i:'cloud-rain',t:20}];
            let h = '';
            for (let i=6; i<=23; i++) {
                const m = ws[Math.floor(Math.random()*ws.length)];
                h += `<div class="weather-scroll-item flex flex-col items-center justify-center bg-stone-50 rounded-xl py-2 px-1 snap-start"><span class="text-[10px] text-stone-400 font-mono mb-1">${i}:00</span><i data-lucide="${m.i}" class="w-5 h-5 text-stone-600 mb-1"></i><span class="text-xs font-bold text-stone-800">${m.t}Â°</span></div>`;
            }
            document.getElementById('hourly-weather-container').innerHTML = h;
        }

        // -----------------------
        // Template schedule (kept from original)
        // -----------------------
        const templateScheduleData = [
            // Day 1 (27)
            {
                date: "27",
                month: "12",
                day: "Day 1",
                items: [
                    {
                        time: "08:00",
                        endTime: "11:00",
                        title: "æŠµé”è½æ©Ÿ",
                        type: "transport",
                        location: "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ (TPE)",
                        note: "è²·æ‚ éŠå¡/SIMå¡ï¼Œæ­æ©Ÿå ´æ·é‹",
                        description: "é£›æ©ŸæŠµé”æ©Ÿå ´ä¸¦å®Œæˆå…¥å¢ƒæ‰‹çºŒã€‚å»ºè­°åœ¨æ©Ÿå ´å…ˆå…Œæ›å°‘é‡å°å¹£æˆ–å–æ¬¾ã€‚"
                    },
                    {
                        time: "11:00",
                        endTime: "12:00",
                        title: "æ°‘å®¿æ“ºè¡Œæ",
                        type: "stay",
                        location: "å°åŒ—å¸‚å€ (è‡ªè¨‚)",
                        note: "è¾¦ç†å…¥ä½æˆ–å¯„æ”¾è¡Œæ",
                        description: "å°‡è¡Œæå¯„æ”¾åˆ°ä½å®¿åœ°é»ï¼Œæ–¹ä¾¿é–‹å§‹è¼•é¬†çš„è¡Œç¨‹ã€‚"
                    },
                    {
                        time: "13:00",
                        endTime: "14:30",
                        title: "ç¨‹å‘³çæ„éºµæ»·å‘³",
                        type: "food",
                        location: "ç¨‹å‘³çæ„éºµ",
                        tags: ["å¿…åƒæ»·å‘³", "è¥¿é–€ç”º"],
                        note: "è¥¿é–€ç”ºè€å­—è™Ÿï¼Œå¿…é»æ„éºµ",
                        description: "ä¸€å®¶å—æ­¡è¿çš„æ»·å‘³åº—ï¼Œæ»·æ±æ¿ƒéƒå…¥å‘³ï¼Œæ„éºµ Q å½ˆæœ‰åš¼å‹ã€‚"
                    },
                    {
                        time: "14:30",
                        endTime: "17:00",
                        title: "è¥¿é–€ç”º",
                        type: "sight",
                        location: "è¥¿é–€ç”ºå•†åœˆ",
                        tags: ["é€›è¡—", "æ½®æµ"],
                        note: "å¹´è¼•äººæ–‡åŒ–ä¸­å¿ƒã€è¬å¹´å¤§æ¨“",
                        description: "å°åŒ—çš„æµè¡ŒæŒ‡æ¨™ï¼Œæœ‰è¨±å¤šé›»å½±é™¢ã€å•†åº—å’Œå°åƒæ”¤ï¼Œé©åˆé€›è¡—è³¼ç‰©ã€‚"
                    },
                    {
                        time: "17:00",
                        endTime: "18:30",
                        title: "å¦³æœ‰å’–å•¡ neo cafe",
                        type: "food",
                        location: "å¦³æœ‰å’–å•¡",
                        tags: ["å’–å•¡å»³", "ä¸‹åˆèŒ¶"],
                        note: "ç¶²ç¾é¢¨å’–å•¡åº—ï¼Œé©åˆä¼‘æ¯æ‰“å¡",
                        description: "é¢¨æ ¼æº«é¦¨çš„å°åº—ï¼Œå¯ä»¥å–æ¯å’–å•¡ã€æ•´ç†ä¸€ä¸‹è¡Œç¨‹ç…§ç‰‡ã€‚"
                    }
                ]
            },

            // Day 2 (28)
            {
                date: "28",
                month: "12",
                day: "Day 2",
                items: [
                    {
                        time: "09:00",
                        endTime: "11:00",
                        title: "æ—©é¤",
                        type: "food",
                        location: "å°åŒ— (è‡ªè¨‚)",
                        note: "æ‰¾é–“å‚³çµ±è±†æ¼¿åº—æˆ–è›‹é¤…åº—",
                        description: "å“åšå°å¼å‚³çµ±æ—©é¤ï¼Œå¦‚ç‡’é¤…æ²¹æ¢ã€é£¯ç³°æˆ–è›‹é¤…ã€‚"
                    },
                    {
                        time: "11:00",
                        endTime: "15:00",
                        title: "ä¹ä»½åä»½",
                        type: "sight",
                        location: "ä¹ä»½è€è¡— / ååˆ†ç€‘å¸ƒ",
                        tags: ["å±±åŸ", "å¤©ç‡ˆ", "ç€‘å¸ƒ"],
                        note: "å»ºè­°å…ˆåˆ°ååˆ†ç€‘å¸ƒï¼Œä¸‹åˆä¸Šä¹ä»½",
                        description: "å¯å…ˆåœ¨ååˆ†æ”¾å¤©ç‡ˆï¼Œä¸‹åˆå‰å¾€ä¹ä»½è€è¡—æ¬£è³å±±åŸæ™¯è§€åŠèŒ¶æ¨“æ–‡åŒ–ã€‚"
                    },
                    {
                        time: "15:00",
                        endTime: "17:00",
                        title: "çŒ´ç¡è²“æ‘",
                        type: "sight",
                        location: "çŒ´ç¡è²“æ‘",
                        tags: ["å‹•ç‰©", "æ‰“å¡"],
                        note: "è²“å¥´å¿…å»ï¼Œæ„›è­·å‹•ç‰©",
                        description: "ä»¥è²“å’ªç‚ºä¸»é¡Œçš„å°æ‘è½ï¼Œåˆ°è™•å¯è¦‹å¯æ„›çš„è²“å’ªï¼Œæ˜¯æ„›è²“äººå£«çš„å¤©å ‚ã€‚"
                    },
                    {
                        time: "18:00",
                        endTime: "20:00",
                        title: "å¤§è‚¡ç†Ÿæˆç‡’è‚‰å°ˆé–€-å°åŒ—å—äº¬åº—",
                        type: "food",
                        location: "å¤§è‚¡ç†Ÿæˆç‡’è‚‰ (å—äº¬åº—)",
                        tags: ["ç‡’è‚‰", "æ™šé¤"],
                        note: "ç‡’è‚‰åº—ï¼Œç†Ÿæˆè‚‰å“è³ªä¸éŒ¯",
                        description: "å°ˆæ³¨æ–¼ç†Ÿæˆè‚‰å“çš„ç‡’è‚‰åº—ï¼Œæä¾›é«˜å“è³ªçš„ç‰›è‚‰å’Œèˆ’é©çš„ç”¨é¤ç’°å¢ƒã€‚"
                    },
                    {
                        time: "21:00",
                        endTime: "23:00",
                        title: "å¯§å¤å¤œå¸‚",
                        type: "food",
                        location: "å¯§å¤å¤œå¸‚",
                        tags: ["å¤œå¸‚", "åœ“ç’°ç¾é£Ÿ"],
                        note: "ç¾é£Ÿé›†ä¸­ï¼Œå¿…åƒåŠ‰èŠ‹ä»”",
                        description: "ä»¥ç¾é£Ÿèåçš„ç’°ç‹€å¤œå¸‚ï¼Œå°åƒç¨®é¡è±å¯Œï¼Œç‰¹åˆ¥æ¨è–¦åŠ‰èŠ‹ä»”è›‹é»ƒèŠ‹é¤…ã€‚"
                    }
                ]
            },

            // Day 3 (29)
            {
                date: "29",
                month: "12",
                day: "Day 3",
                items: [
                    {
                        time: "11:00",
                        endTime: "12:30",
                        title: "çŠåœ’æ¹¯åŒ…é¤¨",
                        type: "food",
                        location: "çŠåœ’æ¹¯åŒ…é¤¨",
                        tags: ["æ¹¯åŒ…", "åˆé¤"],
                        note: "çµ²ç“œè¦ä»æ¹¯åŒ…å¿…é»",
                        description: "æä¾›å„å¼æ¹¯åŒ…é»å¿ƒï¼Œå°¤å…¶æ˜¯çµ²ç“œè¦ä»æ¹¯åŒ…æ¸…çˆ½å¤šæ±ã€‚"
                    },
                    {
                        time: "12:30",
                        endTime: "14:00",
                        title: "ä¸‰å‰µç”Ÿæ´»åœ’å€",
                        type: "shop",
                        location: "ä¸‰å‰µç”Ÿæ´»åœ’å€",
                        tags: ["3C", "ç§‘æŠ€"],
                        note: "æœ€æ–°çš„é›»å­ç”¢å“å’Œæ•¸ä½å…§å®¹",
                        description: "å°åŒ—ä¸»è¦çš„é›»å­ç”¢å“å’Œç§‘æŠ€å•†å ´ï¼Œé›†åˆäº†å„ç¨®å“ç‰Œå’Œé«”é©—åº—ã€‚"
                    },
                    {
                        time: "14:00",
                        endTime: "16:00",
                        title: "è¯å±±1914æ–‡åŒ–å‰µæ„ç”¢æ¥­åœ’å€",
                        type: "sight",
                        location: "è¯å±±1914æ–‡å‰µåœ’å€",
                        tags: ["æ–‡å‰µ", "è—è¡“"],
                        note: "æ¬£è³å±•è¦½å’Œç¨ç«‹å•†åº—",
                        description: "ç”±èˆŠé…’å» æ”¹é€ çš„è—è¡“åœ’å€ï¼Œç¶“å¸¸èˆ‰è¾¦å„ç¨®å±•è¦½ã€å¸‚é›†å’Œè¡¨æ¼”ï¼Œå……æ»¿æ–‡è—æ°£æ¯ã€‚"
                    },
                    {
                        time: "16:00",
                        endTime: "18:00",
                        title: "èç±³è²å¯åƒå±¤è´è¶é…¥/ä¼´æ‰‹ç¦®",
                        type: "shop",
                        location: "èç±³è²å¯ (è‡ªè¨‚)",
                        tags: ["ä¼´æ‰‹ç¦®", "æ‰‹ä¿¡"],
                        note: "è³¼è²·åƒå±¤è´è¶é…¥ç­‰ä¼´æ‰‹ç¦®",
                        description: "è³¼è²·å°ç£ç‰¹è‰²é»å¿ƒä½œç‚ºé€çµ¦è¦ªå‹çš„ç¦®ç‰©ã€‚"
                    },
                    {
                        time: "19:00",
                        endTime: "21:00",
                        title: "è¼¸æ¼æ°¸åº·åº—",
                        type: "food",
                        location: "è¼¸æ¼æ—¥å¼æ–™ç† (æ°¸åº·åº—)",
                        tags: ["æ—¥å¼æ–™ç†", "æ™šé¤"],
                        note: "å¹³åƒ¹æ–°é®®çš„æµ·é®®ä¸¼é£¯",
                        description: "æä¾›æ–°é®®çš„æµ·é®®å’Œæ—¥å¼æ–™ç†ï¼Œåœ¨æ°¸åº·è¡—é™„è¿‘ã€‚"
                    },
                    {
                        time: "21:00",
                        endTime: "23:00",
                        title: "é¥’æ²³è¡—è§€å…‰å¤œå¸‚",
                        type: "food",
                        location: "é¥’æ²³è¡—è§€å…‰å¤œå¸‚",
                        tags: ["å¤œå¸‚", "å°åƒ"],
                        note: "èƒ¡æ¤’é¤…ã€è—¥ç‡‰æ’éª¨",
                        description: "å°åŒ—çŸ¥åçš„å¤œå¸‚ä¹‹ä¸€ï¼Œä»¥èƒ¡æ¤’é¤…ã€è—¥ç‡‰æ’éª¨å’Œè±å¯Œçš„å°åƒèåã€‚"
                    }
                ]
            },

            // Day 4 (30)
            {
                date: "30",
                month: "12",
                day: "Day 4",
                items: [
                    {
                        time: "12:00",
                        endTime: "14:00",
                        title: "æ¯”è–©å»£å ´/æ–°åŒ—æ°¸å’Œ",
                        type: "food",
                        location: "æ¯”è–©å»£å ´ (æ°¸å’Œ)",
                        tags: ["åˆé¤", "ç¾©å¼"],
                        note: "äº«å—æŠ«è–©å’Œç¾©å¤§åˆ©éºµ",
                        description: "åœ¨æ°¸å’Œåœ°å€äº«ç”¨ç¾©å¼åˆé¤ï¼Œå¯ä»¥å˜—è©¦ä¸åŒçš„æŠ«è–©å£å‘³ã€‚"
                    },
                    {
                        time: "14:00",
                        endTime: "15:00",
                        title: "æ¨‚è¯å•†åœˆå•†åº—è¡—",
                        type: "shop",
                        location: "æ¨‚è¯å¤œå¸‚å•†åœˆ",
                        tags: ["é€›è¡—", "è³¼ç‰©"],
                        note: "å‘¨é‚Šå•†åº—è¡—é–’é€›",
                        description: "æ¨‚è¯å¤œå¸‚å‘¨é‚Šçš„å•†åº—ï¼Œé©åˆä¸‹åˆèŒ¶æˆ–è³¼è²·å°ç‰©å“ã€‚"
                    },
                    {
                        time: "15:00",
                        endTime: "17:00",
                        title: "Chill! Gelato",
                        type: "food",
                        location: "Chill! Gelato (è‡ªè¨‚)",
                        tags: ["ç”œé»", "ç¾©å¼å†°æ·‡æ·‹"],
                        note: "å“åšæ‰‹å·¥ç¾©å¼å†°æ·‡æ·‹",
                        description: "ä¸€é–“æ‰‹å·¥ç¾©å¼å†°æ·‡æ·‹åº—ï¼Œå£å‘³æ¸…çˆ½ï¼Œé©åˆç‚ç†±çš„ä¸‹åˆã€‚"
                    },
                    {
                        time: "17:00",
                        endTime: "18:00",
                        title: "ä¸‹åˆèŒ¶/å’–å•¡æ™‚é–“",
                        type: "food",
                        location: "å°åŒ—å’–å•¡åº— (è‡ªè¨‚)",
                        tags: ["å’–å•¡", "ä¸‹åˆèŒ¶"],
                        note: "äº«ç”¨å’–å•¡æˆ–è¼•é£Ÿ",
                        description: "ä¸€å®¶é¢¨æ ¼ç¨ç‰¹çš„å’–å•¡åº—ï¼Œå¯ä»¥ä¼‘æ¯æ”¾é¬†ï¼Œäº«å—åˆå¾Œæ™‚å…‰ã€‚"
                    },
                    {
                        time: "18:00",
                        endTime: "20:30",
                        title: "è©¹è¨˜éº»è¾£ç«é‹-è¥¿é–€å¤§ä¸–ç•Œ",
                        type: "food",
                        location: "è©¹è¨˜éº»è¾£ç«é‹ (è¥¿é–€å¤§ä¸–ç•Œ)",
                        tags: ["éº»è¾£é‹", "å¿…åƒ"],
                        note: "å°ç£æœ€ç´…éº»è¾£é‹ä¹‹ä¸€ï¼Œé´¨è¡€è±†è…ç„¡é™çºŒ",
                        description: "ä»¥å¾©å¤è£æ½¢å’Œæ‹›ç‰Œé´¨è¡€ã€è±†è…èåçš„éº»è¾£ç«é‹åº—ï¼Œå»ºè­°æå‰è¨‚ä½ã€‚"
                    },
                    {
                        time: "21:00",
                        endTime: "23:00",
                        title: "å—æ©Ÿå ´å¤œå¸‚",
                        type: "food",
                        location: "å—æ©Ÿå ´å¤œå¸‚",
                        tags: ["å¤œå¸‚", "ç¾é£Ÿ"],
                        note: "åœ¨åœ°äººæ„›é€›ï¼Œä¾†æ’èŠ‹é ­é¤…",
                        description: "ç•¶åœ°çŸ¥åçš„å¤œå¸‚ï¼Œæ“æœ‰è¨±å¤šæ’éšŠç¾é£Ÿï¼Œé©åˆæ™šé¤å¾Œç¹¼çºŒå“åšå°åƒã€‚"
                    }
                ]
            },

            // Day 5 (31)
            {
                date: "31",
                month: "12",
                day: "Day 5",
                items: [
                    {
                        time: "12:00",
                        endTime: "14:00",
                        title: "Check Out / è¯æ³°åå“åŸ",
                        type: "shop",
                        location: "è¯æ³°åå“åŸ (GLORIA OUTLETS)",
                        tags: ["è³¼ç‰©", "Outlet"],
                        note: "é›¢æ©Ÿå ´è¿‘ï¼Œæœ€å¾Œè³¼ç‰©è¡åˆº",
                        description: "åœ¨å‰å¾€æ©Ÿå ´å‰ï¼Œå…ˆåˆ° Outlet é€²è¡Œæœ€å¾Œçš„è³¼ç‰©ï¼Œæœ‰è¨±å¤šåœ‹éš›å“ç‰ŒæŠ˜æ‰£åº—ã€‚"
                    },
                    {
                        time: "20:00",
                        endTime: "21:00",
                        title: "æ™šé¤",
                        type: "food",
                        location: "æ©Ÿå ´æˆ–å¸‚å€ (è‡ªè¨‚)",
                        note: "å›æ¸¯å‰æœ€å¾Œä¸€é¤",
                        description: "åœ¨æ©Ÿå ´æˆ–å¸‚å€æ‰¾ä¸€é–“é¤å»³äº«ç”¨æ™šé¤ï¼Œæº–å‚™æ­æ©Ÿå›æ¸¯ã€‚"
                    },
                    {
                        time: "22:00",
                        endTime: "23:00",
                        title: "å›é¦™æ¸¯",
                        type: "transport",
                        location: "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ (TPE)",
                        note: "æ­æ©Ÿå›ç¨‹",
                        description: "æå‰åˆ°é”æ©Ÿå ´è¾¦ç†ç™»æ©Ÿæ‰‹çºŒï¼Œæ­ä¹˜é£›æ©Ÿè¿”å›é¦™æ¸¯ã€‚"
                    }
                ]
            }
        ];

        // æä¾›çµ¦å»ºç«‹æ–°æ—…ç¨‹æ™‚ä½¿ç”¨
        window.templateScheduleData = templateScheduleData;

        // -----------------------
        // Init UI
        // -----------------------
        function initUI() {
            lucide.createIcons();
            generateHourlyWeather();
            document.getElementById('expense-amount').addEventListener('input', function(e) {
                const val = parseInt(e.target.value || 0, 10) || 0;
                document.getElementById('input-hkd-preview').innerText = Math.round(val * EXCHANGE_RATE);
            });
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('new-trip-date').value = today;
        }

        initUI();
        initFirebase();

        // Close modals helpers
        function closeDetailModal() { document.getElementById('detail-modal').classList.add('hidden'); }
        document.getElementById('detail-modal').addEventListener('click', (e) => { if (e.target === document.getElementById('detail-modal')) closeDetailModal(); });

    </script>
</body>
</html>
