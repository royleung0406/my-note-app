<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å°ç£ä¹‹æ—…</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#FAFAFA">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Shippori+Mincho:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #FAFAFA;
            --card-bg: #FFFFFF;
            --text-main: #333333;
            --text-sub: #888888;
            --accent: #4B5563; /* è³ªæ„Ÿæ·±ç° */
            --highlight: #BE123C; /* æ—¥å¼èŒœè‰² - ç”¨æ–¼é‡é»æ¨™ç±¤ */
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            -webkit-user-select: none;
            user-select: none;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* æ—¥å¼æ¨™é¡Œå­—å‹ */
        h1, h2, .date-font {
            font-family: 'Shippori Mincho', serif;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* æ¥µç°¡å¡ç‰‡é™°å½± */
        .zen-shadow {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0,0,0,0.02);
        }

        .active-tab {
            color: var(--text-main);
            font-weight: 500;
        }
        .active-tab::after {
            content: '';
            display: block;
            width: 4px;
            height: 4px;
            background: var(--text-main);
            border-radius: 50%;
            margin: 4px auto 0;
        }
        
        .inactive-tab { color: #CCCCCC; }

        /* æŒ‰éˆ•é»æ“Šæ„Ÿ */
        .tap-effect:active { opacity: 0.7; transform: scale(0.98); }

        /* æ¨™ç±¤é…è‰² */
        .tag-must-eat { background: #FFF1F2; color: #BE123C; border: 1px solid #FFE4E6; }
        .tag-nav { background: #F3F4F6; color: #374151; }
        .tag-tips { background: #ECFEFF; color: #0E7490; border: 1px solid #CFFAFE; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-[#FAFAFA]">

    <!-- é ‚éƒ¨è³‡è¨Š -->
    <header class="bg-[#FAFAFA]/95 backdrop-blur-sm pt-safe-top sticky top-0 z-20 px-6 py-4 border-b border-gray-100 flex justify-between items-end">
        <div>
            <p class="text-xs text-gray-400 tracking-widest mb-1">TAIPEI TRIP</p>
            <h1 class="text-2xl font-bold tracking-wide text-gray-800">å°ç£äº”æ—¥éŠ</h1>
        </div>
        <div class="text-right flex flex-col items-end gap-1">
             <div class="flex items-center gap-1 text-gray-700">
                <i data-lucide="cloud" class="w-4 h-4"></i>
                <span class="text-sm font-medium">22Â°C</span>
            </div>
            <button onclick="resetToDefault()" class="text-[10px] text-gray-300 underline mt-1">æ¢å¾©é è¨­</button>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main id="main-content" class="flex-1 overflow-y-auto no-scrollbar pb-24 relative px-4">
        
        <!-- Tab 1: è¡Œç¨‹ -->
        <div id="view-schedule" class="view-section pt-4 space-y-6 animate-fade-in">
            
            <!-- æ—¥æœŸé¸æ“‡ (æ©«å‘æ²å‹•) -->
            <div class="flex gap-4 overflow-x-auto no-scrollbar pb-2 px-1" id="day-selector">
                <!-- JS ç”Ÿæˆ -->
            </div>

            <!-- æ™‚é–“è»¸å®¹å™¨ -->
            <div id="timeline-container" class="space-y-4 pb-10">
                <!-- JS ç”Ÿæˆ -->
            </div>
        </div>

        <!-- Tab 2: è³‡è¨Š (èˆªç­/ä½å®¿/ç·Šæ€¥) -->
        <div id="view-info" class="view-section hidden pt-6 space-y-6 animate-fade-in">
            
            <!-- èˆªç­å¡ç‰‡ -->
            <div class="bg-white rounded-xl p-6 zen-shadow">
                <h3 class="font-serif text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <i data-lucide="plane-takeoff" class="w-4 h-4"></i> èˆªç­è³‡è¨Š
                </h3>
                <div class="space-y-6">
                    <!-- å»ç¨‹ -->
                    <div class="relative pl-4 border-l-2 border-gray-100">
                        <div class="absolute -left-[5px] top-0 w-2 h-2 rounded-full bg-gray-300"></div>
                        <p class="text-xs text-gray-400 mb-1">å»ç¨‹ 11/27 (Day 1)</p>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xl font-bold font-serif">HKG</span>
                            <i data-lucide="arrow-right" class="w-4 h-4 text-gray-300"></i>
                            <span class="text-xl font-bold font-serif">TPE</span>
                        </div>
                        <p class="text-sm text-gray-600">07:00 æŠµé” (è½æ©Ÿ)</p>
                    </div>
                    <!-- å›ç¨‹ -->
                    <div class="relative pl-4 border-l-2 border-gray-100">
                        <div class="absolute -left-[5px] top-0 w-2 h-2 rounded-full bg-gray-300"></div>
                        <p class="text-xs text-gray-400 mb-1">å›ç¨‹ 11/31 (Day 5)</p>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xl font-bold font-serif">TPE</span>
                            <i data-lucide="arrow-right" class="w-4 h-4 text-gray-300"></i>
                            <span class="text-xl font-bold font-serif">HKG</span>
                        </div>
                        <p class="text-sm text-gray-600">22:00 å›é¦™æ¸¯</p>
                    </div>
                </div>
            </div>

            <!-- ä½å®¿ -->
            <div class="bg-white rounded-xl p-6 zen-shadow">
                <h3 class="font-serif text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <i data-lucide="bed-double" class="w-4 h-4"></i> ä½å®¿è³‡è¨Š
                </h3>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-bold text-gray-700">æ°‘å®¿ (å¾…å¡«å…¥åç¨±)</p>
                                <p class="text-xs text-gray-400 mt-0.5">11/27 - 11/31</p>
                            </div>
                            <button class="text-xs bg-gray-100 px-3 py-1.5 rounded-full text-gray-600 tap-effect">
                                å°èˆª
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 bg-gray-50 p-2 rounded">
                            <span class="font-bold">Check-in:</span> 15:00 <br>
                            <span class="font-bold">Check-out:</span> 11:00
                        </p>
                    </div>
                </div>
            </div>

            <!-- ç·Šæ€¥è¯çµ¡ -->
            <div class="bg-red-50 rounded-xl p-6 border border-red-100">
                <h3 class="font-serif text-lg font-bold text-red-800 mb-4 flex items-center gap-2">
                    <i data-lucide="phone" class="w-4 h-4"></i> ç·Šæ€¥è¯çµ¡
                </h3>
                <div class="grid grid-cols-2 gap-3">
                    <a href="tel:110" class="bg-white p-3 rounded-lg text-center tap-effect shadow-sm">
                        <p class="text-xs text-red-400 mb-1">å ±æ¡ˆ</p>
                        <p class="text-lg font-bold text-red-600">110</p>
                    </a>
                    <a href="tel:119" class="bg-white p-3 rounded-lg text-center tap-effect shadow-sm">
                        <p class="text-xs text-red-400 mb-1">æ•‘è­·è»Š</p>
                        <p class="text-lg font-bold text-red-600">119</p>
                    </a>
                </div>
            </div>
        </div>

        <!-- Tab 3: è¨˜å¸³ -->
        <div id="view-budget" class="view-section hidden pt-6 space-y-4 animate-fade-in">
            <div class="bg-gray-800 rounded-xl p-6 text-white zen-shadow">
                <p class="text-gray-400 text-xs mb-1">ç¸½æ”¯å‡º (NTD)</p>
                <h2 class="text-4xl font-serif font-bold tracking-wider" id="total-expense">0</h2>
            </div>
            
            <form onsubmit="addExpense(event)" class="bg-white p-4 rounded-xl zen-shadow flex gap-2">
                <input type="text" id="expense-item" placeholder="é …ç›®" class="flex-1 bg-gray-50 px-4 py-2 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-gray-300">
                <input type="number" id="expense-amount" placeholder="$" class="w-20 bg-gray-50 px-3 py-2 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-gray-300">
                <button type="submit" class="bg-gray-800 text-white w-10 h-10 rounded-lg flex items-center justify-center tap-effect">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
            </form>

            <div id="expense-list" class="space-y-2 pb-10">
                <!-- JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨å°èˆª -->
    <nav class="fixed bottom-0 w-full bg-white/95 backdrop-blur-md border-t border-gray-100 pb-safe-bottom z-30">
        <div class="flex justify-center items-center h-16 gap-12">
            <button onclick="switchTab('schedule')" id="tab-schedule" class="active-tab flex flex-col items-center">
                <span class="text-xs tracking-widest mt-1">è¡Œç¨‹</span>
            </button>
            <button onclick="switchTab('info')" id="tab-info" class="inactive-tab flex flex-col items-center">
                <span class="text-xs tracking-widest mt-1">è³‡è¨Š</span>
            </button>
            <button onclick="switchTab('budget')" id="tab-budget" class="inactive-tab flex flex-col items-center">
                <span class="text-xs tracking-widest mt-1">è¨˜å¸³</span>
            </button>
        </div>
    </nav>

    <!-- ç·¨è¼¯ Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl animate-slide-up">
            <h3 class="text-lg font-bold mb-4 flex justify-between items-center">
                <span id="modal-title">ç·¨è¼¯è¡Œç¨‹</span>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </h3>
            <form id="edit-form" class="space-y-4" onsubmit="saveScheduleItem(event)">
                <input type="hidden" id="edit-day-index">
                <input type="hidden" id="edit-item-index">
                
                <div class="flex gap-3">
                    <div class="w-1/3 space-y-1">
                        <label class="text-xs text-gray-500 font-medium ml-1">æ™‚é–“</label>
                        <input type="time" id="edit-time" class="w-full bg-gray-50 rounded-xl p-3 text-sm border-0 ring-1 ring-gray-200 focus:ring-2 focus:ring-gray-800 outline-none">
                    </div>
                    <div class="w-2/3 space-y-1">
                        <label class="text-xs text-gray-500 font-medium ml-1">é¡å‹</label>
                        <select id="edit-type" class="w-full bg-gray-50 rounded-xl p-3 text-sm border-0 ring-1 ring-gray-200 focus:ring-2 focus:ring-gray-800 outline-none appearance-none">
                            <option value="sight">ğŸ“· æ™¯é»</option>
                            <option value="food">ğŸœ ç¾é£Ÿ</option>
                            <option value="shop">ğŸ›ï¸ è³¼ç‰©</option>
                            <option value="transport">ğŸšŒ äº¤é€š</option>
                            <option value="stay">ğŸ›ï¸ ä½å®¿</option>
                        </select>
                    </div>
                </div>

                <div class="space-y-1">
                    <label class="text-xs text-gray-500 font-medium ml-1">æ¨™é¡Œ</label>
                    <input type="text" id="edit-title" required class="w-full bg-gray-50 rounded-xl p-3 text-sm border-0 ring-1 ring-gray-200 focus:ring-2 focus:ring-gray-800 outline-none" placeholder="è¡Œç¨‹åç¨±">
                </div>

                <div class="space-y-1">
                    <label class="text-xs text-gray-500 font-medium ml-1">åœ°é» (Google Maps å°èˆªç”¨)</label>
                    <input type="text" id="edit-location" class="w-full bg-gray-50 rounded-xl p-3 text-sm border-0 ring-1 ring-gray-200 focus:ring-2 focus:ring-gray-800 outline-none" placeholder="è¼¸å…¥åœ°é»é—œéµå­—">
                </div>
                
                 <div class="space-y-1">
                    <label class="text-xs text-gray-500 font-medium ml-1">æ¨™ç±¤ (ç”¨é€—è™Ÿåˆ†éš”)</label>
                    <input type="text" id="edit-tags" class="w-full bg-gray-50 rounded-xl p-3 text-sm border-0 ring-1 ring-gray-200 focus:ring-2 focus:ring-gray-800 outline-none" placeholder="ä¾‹å¦‚: å¿…åƒ, æ¨è–¦">
                </div>

                <div class="space-y-1">
                    <label class="text-xs text-gray-500 font-medium ml-1">å‚™è¨»</label>
                    <textarea id="edit-note" rows="2" class="w-full bg-gray-50 rounded-xl p-3 text-sm border-0 ring-1 ring-gray-200 focus:ring-2 focus:ring-gray-800 outline-none" placeholder="å‚™è¨»äº‹é …..."></textarea>
                </div>

                <div class="pt-2">
                    <button type="submit" class="w-full py-3 rounded-xl bg-gray-800 text-white font-medium shadow-lg shadow-gray-200 active:scale-95 transition-transform">å„²å­˜è®Šæ›´</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒè³‡æ–™: é è¨­è³‡æ–™ (è‹¥ LocalStorage ç‚ºç©ºå‰‡ä½¿ç”¨æ­¤è³‡æ–™) ---
        const defaultScheduleData = [
            {
                date: "27",
                month: "11",
                day: "Day 1",
                items: [
                    { time: "07:00", title: "æŠµé”è½æ©Ÿ", type: "transport", location: "å°ç£æ¡ƒåœ’åœ‹éš›æ©Ÿå ´", note: "æ­¡è¿ä¾†åˆ°å°ç£ï¼" },
                    { time: "11:00", title: "æ°‘å®¿æ”¾è¡Œæ", type: "stay", location: "å°åŒ—", note: "ç¢ºèª Check-in æ™‚é–“" },
                    { time: "13:00", title: "ç¨‹å‘³çæ„éºµæ»·å‘³", type: "food", location: "ç¨‹å‘³çæ„éºµ", tags: ["å¿…åƒ: æ»·å‘³", "å¿…åƒ: æ„éºµ", "å¿…åƒ: æ»·è‚‰é£¯"] },
                    { time: "15:00", title: "è¥¿é–€ç”º", type: "sight", location: "è¥¿é–€ç”º", tags: ["é€›è¡—", "è¡—é ­å°åƒ"] },
                    { time: "17:00", title: "å¦³æœ‰å’–å•¡ neo cafÃ©", type: "food", location: "å¦³æœ‰å’–å•¡ neo cafe", tags: ["æ¨è–¦: å¤§äººå‘³å¸ƒä¸", "æ¨è–¦: Pizza"] },
                    { time: "19:00", title: "è©¹è¨˜éº»è¾£ç«é‹", type: "food", location: "è©¹è¨˜éº»è¾£ç«é‹ è¥¿é–€å¤§ä¸–ç•Œ", tags: ["å¿…åƒ: é´¨è¡€", "å¿…åƒ: è±†è…", "éœ€è¨‚ä½"] },
                    { time: "21:00", title: "å—æ©Ÿå ´å¤œå¸‚", type: "food", location: "å—æ©Ÿå ´å¤œå¸‚", tags: ["å¿…åƒ: æ°´é¤ƒ", "å¿…åƒ: è‡­è±†è…"] }
                ]
            },
            {
                date: "28",
                month: "11",
                day: "Day 2",
                items: [
                    { time: "09:00", title: "æ—©é¤", type: "food", location: "å°åŒ—", note: "é™„è¿‘æ‰¾é–“å‚³çµ±æ—©é¤åº—å§ (é˜œæ­?)" },
                    { time: "12:00", title: "ä¹ä»½ / ååˆ†", type: "sight", location: "ä¹ä»½è€è¡—", tags: ["å¿…åƒ: èŠ‹åœ“", "æ”¾å¤©ç‡ˆ", "ç€‘å¸ƒ"] },
                    { time: "16:00", title: "çŒ´ç¡è²“æ‘", type: "sight", location: "çŒ´ç¡è²“æ‘", tags: ["è²“å’ª", "ç…¤ç¤¦æ­·å²"] },
                    { time: "19:00", title: "å¤§è‚¡ç†Ÿæˆç‡’è‚‰å°ˆé–€", type: "food", location: "å¤§è‚¡ç†Ÿæˆç‡’è‚‰å°ˆé–€ å°åŒ—å—äº¬åº—", tags: ["å¿…é»: è¶…åšåˆ‡ç‰›èˆŒ", "æ¸…é…’è²©è³£æ©Ÿ"] },
                    { time: "21:00", title: "å¯§å¤å¤œå¸‚", type: "food", location: "å¯§å¤å¤œå¸‚", tags: ["å¿…åƒ: èŠ‹ä¸¸", "å¿…åƒ: èšµä»”ç…"] }
                ]
            },
            {
                date: "29",
                month: "11",
                day: "Day 3",
                items: [
                    { time: "11:00", title: "çŠåœ’æ¹¯åŒ…é¤¨", type: "food", location: "çŠåœ’æ¹¯åŒ…é¤¨", tags: ["å¿…é»: çµ²ç“œè¦ä»æ¹¯åŒ…", "å¿…é»: ç¾…å‹’é®®èšµæ¹¯åŒ…"] },
                    { time: "14:00", title: "ä¸‰å‰µç”Ÿæ´»åœ’å€", type: "sight", location: "ä¸‰å‰µç”Ÿæ´»åœ’å€", tags: ["3C", "å‹•æ¼«"] },
                    { time: "15:00", title: "è¯å±±1914æ–‡å‰µåœ’å€", type: "sight", location: "è¯å±±1914æ–‡åŒ–å‰µæ„ç”¢æ¥­åœ’å€", tags: ["å±•è¦½", "æ–‡é’å°åº—"] },
                    { time: "17:00", title: "å¸•ç±³è²å¯è´è¶é…¥", type: "shop", location: "å¸•ç±³è²å¯", tags: ["ä¼´æ‰‹ç¦®: è´è¶é…¥"] },
                    { time: "19:00", title: "æ‹¾æ¼", type: "food", location: "æ‹¾æ¼ æ°¸åº·åº—", tags: ["æ—¥å¼ç„¡èœå–®", "é«˜CPå€¼"] },
                    { time: "21:00", title: "é¥’æ²³è¡—è§€å…‰å¤œå¸‚", type: "food", location: "é¥’æ²³è¡—è§€å…‰å¤œå¸‚", tags: ["å¿…åƒ: èƒ¡æ¤’é¤…", "å¿…åƒ: è—¥ç‡‰æ’éª¨"] }
                ]
            },
            {
                date: "30",
                month: "11",
                day: "Day 4",
                items: [
                    { time: "12:00", title: "æ¯”æ¼¾å»£å ´", type: "shop", location: "æ¯”æ¼¾å»£å ´", tags: ["é€›è¡—", "ç¾é£Ÿè¡—"] },
                    { time: "14:00", title: "æ¨‚è¯å•†åœˆ", type: "sight", location: "æ¨‚è¯å¤œå¸‚", tags: ["é€›è¡—"] },
                    { time: "16:00", title: "Chii! Gelato", type: "food", location: "Chii! Gelato", tags: ["æ¨è–¦: é–‹å¿ƒæœä¸‰é‡å¥", "ç¾©å¼å†°æ·‡æ·‹"] },
                    { time: "19:00", title: "é‡‘æœˆ-æ—¥æœ¬é‹æ–™ç†", type: "food", location: "é‡‘æœˆæ—¥æœ¬é‹æ–™ç†æ“”ç•¶", tags: ["å¿…é»: æ¸…é…’æ¹¯åº•", "A5å’Œç‰›", "å’–å“©å¥¶æ²¹å·"] },
                    { time: "21:00", title: "è‡¨æ±Ÿè¡—(é€šåŒ–)å¤œå¸‚", type: "food", location: "è‡¨æ±Ÿè¡—è§€å…‰å¤œå¸‚", tags: ["å¿…åƒ: å†°ç«æ¹¯åœ“", "å¿…åƒ: ç´…èŠ±é¦™è…¸"] }
                ]
            },
            {
                date: "31",
                month: "11",
                day: "Day 5",
                items: [
                    { time: "12:00", title: "Check Out", type: "stay", location: "å°åŒ—", note: "è¡Œæå¯„æ”¾?" },
                    { time: "14:00", title: "è¯æ³°åå“åŸ", type: "shop", location: "GLORIA OUTLETS è¯æ³°åå“åŸ", tags: ["Outlet", "æœ€å¾Œè¡åˆº"] },
                    { time: "19:00", title: "æ™šé¤", type: "food", location: "æ¡ƒåœ’é«˜éµç«™", note: "æ©Ÿå ´æ·é‹æ²¿ç·š" },
                    { time: "22:00", title: "å›é¦™æ¸¯", type: "transport", location: "å°ç£æ¡ƒåœ’åœ‹éš›æ©Ÿå ´", note: "å¹³å®‰å›å®¶" }
                ]
            }
        ];

        // --- åˆå§‹åŒ– & é‚è¼¯ ---
        let scheduleData = [];
        let currentDayIndex = 0;
        let expenses = JSON.parse(localStorage.getItem('tw_trip_expenses') || '[]');

        function init() {
            // è¼‰å…¥è¡Œç¨‹ (LocalStorage æˆ– é è¨­)
            const savedSchedule = localStorage.getItem('tw_trip_schedule');
            if (savedSchedule) {
                scheduleData = JSON.parse(savedSchedule);
            } else {
                scheduleData = JSON.parse(JSON.stringify(defaultScheduleData)); // Deep copy
                saveSchedule();
            }

            lucide.createIcons();
            renderDaySelector();
            renderTimeline(0);
            renderExpenses();
        }

        // å„²å­˜è¡Œç¨‹åˆ° LocalStorage
        function saveSchedule() {
            localStorage.setItem('tw_trip_schedule', JSON.stringify(scheduleData));
        }

        // æ¢å¾©é è¨­å€¼
        function resetToDefault() {
            if(confirm("ç¢ºå®šè¦æ¢å¾©æˆé è¨­è¡Œç¨‹å—ï¼Ÿæ‚¨æ‰€æœ‰çš„ä¿®æ”¹å°‡æœƒæ¶ˆå¤±ã€‚")) {
                scheduleData = JSON.parse(JSON.stringify(defaultScheduleData));
                saveSchedule();
                renderTimeline(currentDayIndex);
                alert("å·²æ¢å¾©é è¨­è¡Œç¨‹");
            }
        }

        // æ¸²æŸ“æ—¥æœŸé¸å–®
        function renderDaySelector() {
            const container = document.getElementById('day-selector');
            container.innerHTML = scheduleData.map((day, index) => `
                <button onclick="selectDay(${index})" 
                    class="day-btn flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-xl border transition-all ${index === 0 ? 'bg-gray-800 text-white border-gray-800 shadow-md' : 'bg-white text-gray-400 border-gray-200'}"
                    id="day-btn-${index}">
                    <span class="text-[10px] font-medium tracking-wide">${day.day}</span>
                    <span class="text-lg font-serif font-bold">${day.date}</span>
                </button>
            `).join('');
        }

        // åˆ‡æ›æ—¥æœŸ
        function selectDay(index) {
            currentDayIndex = index;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.day-btn').forEach((btn, idx) => {
                if (idx === index) {
                    btn.className = "day-btn flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-xl border transition-all bg-gray-800 text-white border-gray-800 shadow-md transform scale-105";
                } else {
                    btn.className = "day-btn flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-xl border transition-all bg-white text-gray-400 border-gray-200";
                }
            });

            renderTimeline(index);
        }

        // æ¸²æŸ“è¡Œç¨‹å¡ç‰‡
        function renderTimeline(dayIndex) {
            const container = document.getElementById('timeline-container');
            const data = scheduleData[dayIndex];
            
            // å¤©æ°£æ¨¡æ“¬ (éš¨æ©Ÿ)
            const weathers = ['cloud-sun', 'sun', 'cloud-rain'];
            const randomWeather = weathers[Math.floor(Math.random() * weathers.length)];

            let html = `
                <div class="flex items-center justify-between px-2 mb-2 animate-fade-in">
                    <p class="text-sm text-gray-500 font-serif">11æœˆ${data.date}æ—¥ / ${data.day}</p>
                    <i data-lucide="${randomWeather}" class="w-4 h-4 text-gray-400"></i>
                </div>
            `;

            // æ ¹æ“šæ™‚é–“æ’åºé …ç›®
            data.items.sort((a, b) => a.time.localeCompare(b.time));

            html += data.items.map((item, itemIndex) => {
                // æ ¹æ“šé¡å‹æ±ºå®šåœ–ç¤º
                let icon = 'map-pin';
                if(item.type === 'food') icon = 'utensils';
                if(item.type === 'transport') icon = 'bus';
                if(item.type === 'shop') icon = 'shopping-bag';
                if(item.type === 'stay') icon = 'bed';

                // ç”Ÿæˆæ¨™ç±¤
                let tagsHtml = '';
                if(item.tags && item.tags.length > 0) {
                    tagsHtml = `<div class="flex flex-wrap gap-2 mt-3">` + 
                    item.tags.map(tag => {
                        let className = 'tag-tips'; // é è¨­
                        if(tag.includes('å¿…åƒ') || tag.includes('å¿…é»')) className = 'tag-must-eat';
                        return `<span class="text-[10px] px-2 py-0.5 rounded ${className}">${tag}</span>`;
                    }).join('') + `</div>`;
                }

                return `
                <div class="bg-white rounded-xl p-5 zen-shadow relative overflow-hidden animate-slide-up group">
                    <div class="flex gap-4">
                        <div class="flex flex-col items-center pt-1 w-10 flex-shrink-0">
                            <span class="text-xs font-medium text-gray-400 mb-1">${item.time}</span>
                            <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-600">
                                <i data-lucide="${icon}" class="w-4 h-4"></i>
                            </div>
                            <div class="h-full w-[1px] bg-gray-100 my-2"></div>
                        </div>
                        <div class="flex-1 pb-2 min-w-0">
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-gray-800 text-lg leading-tight truncate mr-2">${item.title}</h3>
                                <div class="flex gap-2 flex-shrink-0">
                                    <button onclick="openEditModal(${dayIndex}, ${itemIndex})" class="text-gray-300 hover:text-gray-600 p-1">
                                        <i data-lucide="pencil" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="deleteScheduleItem(${dayIndex}, ${itemIndex})" class="text-gray-300 hover:text-red-500 p-1">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-2 mt-1 mb-2">
                                <button onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}')" 
                                    class="text-xs flex items-center gap-1 bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1.5 rounded-full transition-colors tap-effect max-w-full truncate">
                                    <i data-lucide="navigation" class="w-3 h-3 flex-shrink-0"></i> 
                                    <span class="truncate">${item.location || 'è¨­å®šåœ°é»'}</span>
                                </button>
                            </div>
                            
                            ${item.note ? `<p class="text-xs text-gray-500 mt-1 line-clamp-2">${item.note}</p>` : ''}
                            ${tagsHtml}
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            // æ–°å¢æŒ‰éˆ•
            html += `
                <button onclick="openAddModal(${dayIndex})" class="w-full py-4 rounded-xl border-2 border-dashed border-gray-200 text-gray-400 hover:border-gray-400 hover:text-gray-600 transition-colors flex items-center justify-center gap-2 tap-effect mt-2">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                    <span>æ–°å¢è¡Œç¨‹</span>
                </button>
            `;

            container.innerHTML = html;
            lucide.createIcons();
        }

        // --- ç·¨è¼¯/æ–°å¢åŠŸèƒ½ ---
        const editModal = document.getElementById('edit-modal');
        const modalTitle = document.getElementById('modal-title');
        const editForm = document.getElementById('edit-form');
        
        // é–‹å•Ÿ Modal (æ–°å¢)
        function openAddModal(dayIndex) {
            document.getElementById('edit-day-index').value = dayIndex;
            document.getElementById('edit-item-index').value = -1; // -1 è¡¨ç¤ºæ–°å¢
            
            modalTitle.innerText = "æ–°å¢è¡Œç¨‹";
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('edit-time').value = "12:00";
            document.getElementById('edit-type').value = "sight";
            document.getElementById('edit-title').value = "";
            document.getElementById('edit-location').value = "";
            document.getElementById('edit-tags').value = "";
            document.getElementById('edit-note').value = "";
            
            editModal.classList.remove('hidden');
        }

        // é–‹å•Ÿ Modal (ç·¨è¼¯)
        function openEditModal(dayIndex, itemIndex) {
            const item = scheduleData[dayIndex].items[itemIndex];
            
            document.getElementById('edit-day-index').value = dayIndex;
            document.getElementById('edit-item-index').value = itemIndex;
            
            modalTitle.innerText = "ç·¨è¼¯è¡Œç¨‹";
            
            // å¡«å…¥è³‡æ–™
            document.getElementById('edit-time').value = item.time;
            document.getElementById('edit-type').value = item.type;
            document.getElementById('edit-title').value = item.title;
            document.getElementById('edit-location').value = item.location;
            document.getElementById('edit-tags').value = item.tags ? item.tags.join(', ') : '';
            document.getElementById('edit-note').value = item.note || '';
            
            editModal.classList.remove('hidden');
        }

        function closeEditModal() {
            editModal.classList.add('hidden');
        }

        // å„²å­˜é‚è¼¯
        function saveScheduleItem(e) {
            e.preventDefault();
            
            const dayIndex = parseInt(document.getElementById('edit-day-index').value);
            const itemIndex = parseInt(document.getElementById('edit-item-index').value);
            
            const newItem = {
                time: document.getElementById('edit-time').value,
                type: document.getElementById('edit-type').value,
                title: document.getElementById('edit-title').value,
                location: document.getElementById('edit-location').value,
                tags: document.getElementById('edit-tags').value.split(',').map(t => t.trim()).filter(t => t),
                note: document.getElementById('edit-note').value
            };

            if (itemIndex === -1) {
                // æ–°å¢
                scheduleData[dayIndex].items.push(newItem);
            } else {
                // ä¿®æ”¹
                scheduleData[dayIndex].items[itemIndex] = newItem;
            }

            saveSchedule();
            renderTimeline(dayIndex);
            closeEditModal();
        }

        function deleteScheduleItem(dayIndex, itemIndex) {
            if(confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿ")) {
                scheduleData[dayIndex].items.splice(itemIndex, 1);
                saveSchedule();
                renderTimeline(dayIndex);
            }
        }

        // é»æ“Š Modal å¤–éƒ¨é—œé–‰
        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) closeEditModal();
        });


        // --- è¨˜å¸³åŠŸèƒ½ (Local Storage) ---
        function renderExpenses() {
            const list = document.getElementById('expense-list');
            const totalEl = document.getElementById('total-expense');
            
            let total = 0;
            list.innerHTML = expenses.map((ex, i) => {
                total += parseInt(ex.amount);
                return `
                    <div class="flex justify-between items-center bg-white p-3 rounded-lg border border-gray-50">
                        <span class="text-sm text-gray-700">${ex.item}</span>
                        <div class="flex items-center gap-3">
                            <span class="font-mono font-medium">NT$ ${ex.amount}</span>
                            <button onclick="deleteExpense(${i})" class="text-gray-300 hover:text-red-400">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).reverse().join(''); // æ–°çš„åœ¨ä¸Šé¢
            
            totalEl.innerText = total.toLocaleString();
            localStorage.setItem('tw_trip_expenses', JSON.stringify(expenses));
            lucide.createIcons();
        }

        function addExpense(e) {
            e.preventDefault();
            const item = document.getElementById('expense-item').value;
            const amount = document.getElementById('expense-amount').value;
            if(!item || !amount) return;

            expenses.push({ item, amount });
            document.getElementById('expense-item').value = '';
            document.getElementById('expense-amount').value = '';
            renderExpenses();
        }

        function deleteExpense(index) {
            if(confirm('ç¢ºå®šåˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ')) {
                // å› é¡¯ç¤ºæ˜¯ reverseï¼Œæ‰€ä»¥åˆªé™¤é‚è¼¯è¦å°æ‡‰
                const realIndex = expenses.length - 1 - index;
                expenses.splice(realIndex, 1);
                renderExpenses();
            }
        }

        // --- é é¢åˆ‡æ› ---
        function switchTab(tabId) {
            // éš±è—æ‰€æœ‰ view-section
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            // é¡¯ç¤ºç›®æ¨™
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            
            // æ›´æ–° Tab æ¨£å¼
            ['schedule', 'info', 'budget'].forEach(id => {
                const btn = document.getElementById(`tab-${id}`);
                if(id === tabId) {
                    btn.className = "active-tab flex flex-col items-center transition-colors";
                } else {
                    btn.className = "inactive-tab flex flex-col items-center transition-colors";
                }
            });
        }

        // å•Ÿå‹•
        init();

        // ç°¡å–®å‹•ç•« CSS
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
            @keyframes slide-up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
            .animate-fade-in { animation: fade-in 0.3s ease-out; }
            .animate-slide-up { animation: slide-up 0.4s ease-out; }
        `;
        document.head.appendChild(style);

    </script>
</body>
</html>
