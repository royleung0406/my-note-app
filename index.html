<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ—…éŠå°å¹«æ‰‹</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FEFDF5">
    
    <!-- App Icon -->
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #FEFDF5;
            --text-main: #433D3C;
            --text-sub: #9CA3AF;
        }

        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            -webkit-user-select: none;
            user-select: none;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .zen-shadow {
            box-shadow: 0 8px 24px rgba(149, 157, 165, 0.08);
            border: 1px solid rgba(255,255,255,0.8);
        }

        .tag-must-eat { background: #FFE4E6; color: #BE123C; }
        .tag-nav { background: #F3F4F6; color: #374151; }
        .tag-tips { background: #E0F2FE; color: #0369A1; }

        .active-tab { color: #57534E; font-weight: 700; background-color: #F5F5F4; border-radius: 16px; }
        .inactive-tab { color: #A8A29E; }

        .tap-effect:active { opacity: 0.8; transform: scale(0.98); transition: transform 0.1s; }
        
        @keyframes slide-up-spring {
            0% { transform: translateY(100%); opacity: 0; }
            60% { transform: translateY(-10px); opacity: 1; }
            100% { transform: translateY(0); }
        }
        .modal-enter { animation: slide-up-spring 0.4s ease-out forwards; }
        
        button, .card-clickable { touch-action: manipulation; cursor: pointer; }

        .share-btn-selected { background-color: #433D3C; color: #FFFFFF; border-color: #433D3C; }
        .share-btn-unselected { background-color: #F5F5F4; color: #A8A29E; border-color: transparent; }
        .filter-btn-active { background-color: rgba(255,255,255,0.2); color: white; font-weight: bold; border: 1px solid rgba(255,255,255,0.4); }
        .filter-btn-inactive { color: rgba(255,255,255,0.6); }
        .weather-scroll-item { min-width: 60px; }
        
        /* ç‹€æ…‹ç‡ˆè™Ÿèˆ‡æç¤º */
        #sync-indicator {
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(67, 61, 60, 0.9); color: white;
            padding: 6px 16px; border-radius: 20px; font-size: 11px; font-weight: bold;
            z-index: 9999; backdrop-filter: blur(4px);
            display: flex; align-items: center; gap: 6px;
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0; pointer-events: none;
        }
        #sync-indicator.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        #sync-indicator.error { background: rgba(239, 68, 68, 0.95); }
        #sync-indicator.success { background: rgba(34, 197, 94, 0.95); }

        /* é–å®šç•«é¢ */
        #lock-screen {
            position: fixed; inset: 0; background: #FEFDF5; z-index: 9990;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            padding: 20px;
        }
        #lock-screen.active { display: flex; }

        /* ç”¨æˆ¶é¸å–® */
        #user-menu {
            position: absolute; top: 60px; right: 20px; background: white;
            border-radius: 16px; padding: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 50; display: none; flex-direction: column; gap: 4px; border: 1px solid #eee;
        }
        #user-menu.show { display: flex; }
        #user-avatar { transition: all 0.3s; }
        #user-avatar.logged-in { border: 2px solid #433D3C; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-[#FEFDF5]">

    <!-- åŒæ­¥æç¤º -->
    <div id="sync-indicator">
        <i id="sync-icon" data-lucide="refresh-cw" class="w-3 h-3 animate-spin"></i>
        <span id="sync-msg">åŒæ­¥ä¸­...</span>
    </div>

    <!-- VIEW 0: æ—…ç¨‹åˆ—è¡¨ (é¦–é ) -->
    <div id="view-home" class="h-full flex flex-col p-6 animate-fade-in relative">
        <header class="mb-8 pt-safe-top flex justify-between items-end">
            <div>
                <p class="text-xs text-stone-400 font-bold tracking-widest mb-1">TRAVEL LOG</p>
                <h1 class="text-3xl font-black tracking-wide text-[#433D3C]">æˆ‘çš„æ—…ç¨‹</h1>
            </div>
            
            <!-- ç™»å…¥æŒ‰éˆ• / é ­åƒ -->
            <div class="relative">
                <button onclick="toggleUserMenu()" id="user-avatar" class="w-10 h-10 rounded-full bg-stone-200 flex items-center justify-center overflow-hidden tap-effect shadow-md">
                    <i data-lucide="user" class="w-5 h-5 text-stone-500"></i>
                    <img id="user-img" src="" class="w-full h-full object-cover hidden">
                </button>
                <!-- ç”¨æˆ¶é¸å–® -->
                <div id="user-menu">
                    <div id="user-info" class="px-4 py-2 text-xs text-stone-400 border-b border-stone-100 mb-1 hidden">
                        æœªç™»å…¥
                    </div>
                    <button onclick="handleLogin()" id="btn-login" class="px-4 py-2 text-sm font-bold text-stone-700 hover:bg-stone-50 rounded-lg text-left flex items-center gap-2">
                        <i data-lucide="log-in" class="w-4 h-4"></i> Google ç™»å…¥
                    </button>
                    <button onclick="handleLogout()" id="btn-logout" class="px-4 py-2 text-sm font-bold text-red-500 hover:bg-red-50 rounded-lg text-left flex items-center gap-2 hidden">
                        <i data-lucide="log-out" class="w-4 h-4"></i> ç™»å‡º
                    </button>
                </div>
            </div>
        </header>

        <div id="trip-list-container" class="flex-1 overflow-y-auto no-scrollbar space-y-4 pb-24">
            <!-- JS å‹•æ…‹ç”Ÿæˆæ—…ç¨‹å¡ç‰‡ -->
            <div class="text-center text-stone-400 mt-20">
                <i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto mb-2"></i>
                <p>è¼‰å…¥æ—…ç¨‹ä¸­...</p>
            </div>
        </div>
        
        <!-- æ‡¸æµ®æ–°å¢æŒ‰éˆ• -->
        <button onclick="createNewTrip()" class="absolute bottom-8 right-6 bg-[#433D3C] text-white w-14 h-14 rounded-full flex items-center justify-center shadow-xl tap-effect z-10">
            <i data-lucide="plus" class="w-8 h-8"></i>
        </button>
    </div>

    <!-- é–å®šç•«é¢ -->
    <div id="lock-screen">
        <div class="w-16 h-16 rounded-full bg-stone-100 flex items-center justify-center mb-6 text-stone-400">
            <i data-lucide="lock" class="w-8 h-8"></i>
        </div>
        <h2 class="text-2xl font-bold text-[#433D3C] mb-2">æ­¤æ—…ç¨‹å—ä¿è­·</h2>
        <p class="text-sm text-stone-400 mb-6 text-center">è«‹è¼¸å…¥é€šè¡Œç¢¼ä»¥è§£é–è¡Œç¨‹</p>
        <div class="flex gap-2 mb-6">
            <input type="text" id="access-code-input" maxlength="4" class="w-32 bg-white text-center text-2xl font-bold tracking-[0.5em] py-3 rounded-2xl border-2 border-stone-100 focus:border-[#433D3C] outline-none" placeholder="â€¢â€¢â€¢â€¢">
        </div>
        <button onclick="verifyAccessCode()" class="w-full max-w-xs py-3 rounded-2xl bg-[#433D3C] text-white font-bold tap-effect shadow-lg">è§£é–</button>
        <button onclick="backToHome()" class="mt-4 text-sm text-stone-400 underline">è¿”å›é¦–é </button>
    </div>

    <!-- VIEW 1: æ—…ç¨‹è©³æƒ… -->
    <div id="view-app" class="h-full flex flex-col hidden">
        <header class="bg-[#FEFDF5]/90 backdrop-blur-sm pt-safe-top sticky top-0 z-20 px-6 py-4 flex justify-between items-end border-b border-stone-100/50">
            <div class="flex items-center gap-3">
                <button onclick="backToHome()" class="bg-white w-8 h-8 rounded-full flex items-center justify-center shadow-sm text-stone-400 hover:text-stone-600 tap-effect">
                    <i data-lucide="chevron-left" class="w-5 h-5"></i>
                </button>
                <div>
                    <p class="text-[10px] text-gray-400 tracking-widest mb-0.5 font-bold">CURRENT TRIP</p>
                    <div class="flex items-center gap-2">
                        <h1 class="text-xl font-bold tracking-wide text-[#433D3C]" id="header-trip-title">æ—…ç¨‹æ¨™é¡Œ</h1>
                        <button onclick="openSecurityModal()" class="text-stone-300 hover:text-stone-500 tap-effect p-1">
                            <i id="header-lock-icon" data-lucide="unlock" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="text-right flex flex-col items-end gap-1">
                <div class="flex gap-2 mb-1">
                    <button onclick="openDateModal()" class="bg-white text-stone-400 p-1.5 rounded-full shadow-sm tap-effect">
                        <i data-lucide="settings-2" class="w-3 h-3"></i>
                    </button>
                    <button onclick="shareTrip()" class="bg-blue-50 text-blue-500 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1 tap-effect">
                        <i data-lucide="share-2" class="w-3 h-3"></i> é‚€è«‹
                    </button>
                </div>
                 <div class="flex items-center gap-1 text-gray-600 bg-white px-2 py-1 rounded-lg shadow-sm border border-stone-100">
                    <i data-lucide="cloud" class="w-3 h-3 text-stone-400"></i>
                    <span class="text-xs font-bold">22Â°C</span>
                </div>
            </div>
        </header>

        <main id="main-content" class="flex-1 overflow-y-auto no-scrollbar pb-28 relative px-4">
            <!-- Tab 1: è¡Œç¨‹ -->
            <div id="view-schedule" class="view-section pt-2 space-y-6 animate-fade-in">
                <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2 px-1" id="day-selector"></div>
                <div class="bg-white rounded-[24px] p-4 zen-shadow border border-white overflow-hidden">
                    <div class="flex items-center gap-2 mb-3 px-1">
                        <i data-lucide="cloud-sun" class="w-4 h-4 text-blue-400"></i>
                        <span class="text-xs font-bold text-stone-500">é å ±</span>
                    </div>
                    <div class="flex overflow-x-auto no-scrollbar gap-2" id="hourly-weather-container"></div>
                </div>
                <div id="timeline-container" class="space-y-4 pb-10"></div>
            </div>

            <!-- Tab 2: è³‡è¨Š -->
            <div id="view-info" class="view-section hidden pt-4 space-y-6 animate-fade-in">
                <div class="bg-white rounded-[24px] p-6 zen-shadow">
                    <h3 class="text-lg font-bold text-gray-800 mb-5 flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-500"><i data-lucide="plane-takeoff" class="w-4 h-4"></i></div>
                        èˆªç­è³‡è¨Š
                    </h3>
                    <div class="space-y-6" id="flight-info-placeholder">
                        <div class="p-4 bg-stone-50 rounded-xl text-center text-stone-400 text-sm">å¯åœ¨é€™è£¡åŠ å…¥èˆªç­è³‡è¨ŠåŠŸèƒ½ (å¾…é–‹ç™¼)</div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: è¨˜å¸³ -->
            <div id="view-budget" class="view-section hidden pt-4 space-y-6 animate-fade-in">
                <div class="bg-[#2D2A26] rounded-[24px] p-6 text-white zen-shadow relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 w-24 h-24 bg-white/5 rounded-full blur-2xl"></div>
                    <div class="flex justify-between items-start mb-4">
                        <p class="text-stone-400 text-xs font-medium tracking-wide uppercase" id="budget-title">ç¸½æ¶ˆè²» (ALL)</p>
                        <button onclick="promptAddCompanion()" class="bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-full text-[10px] flex items-center gap-1 backdrop-blur-sm transition-colors"><i data-lucide="users" class="w-3 h-3"></i> ç®¡ç†æ—…ä¼´</button>
                    </div>
                    <div class="mb-6">
                        <div class="flex items-baseline gap-2"><span class="text-lg text-stone-400 font-bold">NT$</span><h2 class="text-5xl font-bold tracking-tighter font-mono" id="total-expense-twd">0</h2></div>
                        <p class="text-stone-400 text-sm mt-1 font-medium flex items-center gap-1"><span class="bg-white/10 px-2 py-0.5 rounded text-xs">ç´„ HK$ <span id="total-expense-hkd" class="font-mono">0</span></span></p>
                    </div>
                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1" id="member-filter-container"></div>
                </div>
                
                <div class="bg-white p-5 rounded-[24px] zen-shadow space-y-5 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-stone-200 to-white"></div>
                    <h3 class="text-stone-800 font-bold text-lg flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-600"><i data-lucide="receipt" class="w-4 h-4"></i></div> è¨˜ä¸€ç­†</h3>
                    <div class="bg-stone-50 rounded-2xl px-5 py-4 flex flex-col border border-transparent focus-within:border-[#433D3C] transition-all shadow-inner relative group">
                        <label class="text-[10px] text-stone-400 font-bold mb-1 uppercase">é‡‘é¡ (TWD)</label>
                        <div class="flex items-baseline"><span class="text-stone-400 text-2xl mr-2 font-bold">$</span><input type="number" id="expense-amount" placeholder="0" class="flex-1 bg-transparent text-4xl focus:outline-none text-stone-800 font-mono font-bold placeholder-stone-200"></div>
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 text-stone-300 font-mono text-sm pointer-events-none group-focus-within:text-stone-400 transition-colors">â‰ˆ HK$ <span id="input-hkd-preview">0</span></div>
                    </div>
                    <div class="bg-stone-50 rounded-2xl px-4 py-3 flex items-center gap-2 border border-transparent focus-within:border-stone-200 transition-colors"><input type="text" id="expense-item" placeholder="æ¶ˆè²»é …ç›®" class="flex-1 bg-transparent text-base focus:outline-none text-stone-700 placeholder-stone-400 font-medium"></div>
                    <div class="grid grid-cols-1 gap-3 bg-stone-50 p-4 rounded-2xl">
                        <div class="flex items-center justify-between"><span class="text-xs text-stone-500 font-bold flex items-center gap-1"><i data-lucide="wallet" class="w-3 h-3"></i> èª°å…ˆä»˜éŒ¢ï¼Ÿ</span><select id="expense-payer" class="bg-white text-stone-700 text-sm font-bold px-3 py-1.5 rounded-lg border-none focus:ring-0 outline-none cursor-pointer shadow-sm"></select></div>
                        <div class="h-px bg-stone-200/50 w-full"></div>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center"><span class="text-xs text-stone-500 font-bold flex items-center gap-1"><i data-lucide="users" class="w-3 h-3"></i> èª°è¦åˆ†æ”¤ï¼Ÿ</span><button type="button" onclick="selectAllShares()" class="text-[10px] bg-blue-50 text-blue-500 font-bold px-2 py-1 rounded hover:bg-blue-100 transition-colors">å…¨é¸</button></div>
                            <div id="share-buttons-container" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                    <button onclick="addExpense()" class="w-full bg-[#433D3C] text-white py-4 rounded-2xl flex items-center justify-center gap-2 tap-effect shadow-lg shadow-stone-200 font-bold text-lg active:scale-[0.98] transition-transform"><i data-lucide="plus" class="w-5 h-5"></i> åŠ å…¥è¨˜å¸³</button>
                </div>
                <div class="flex justify-between items-end px-2"><h4 class="text-stone-400 text-xs font-bold tracking-widest uppercase">äº¤æ˜“ç´€éŒ„ (HISTORY)</h4><span class="text-[10px] text-stone-300" id="list-filter-status">é¡¯ç¤ºå…¨éƒ¨</span></div>
                <div id="expense-list" class="space-y-3 pb-10 min-h-[100px]"></div>
            </div>
        </main>

        <!-- åº•éƒ¨å°èˆª -->
        <div class="fixed bottom-6 left-6 right-6 z-30">
            <nav class="bg-white/90 backdrop-blur-xl rounded-[24px] shadow-[0_8px_32px_rgba(0,0,0,0.08)] p-2 border border-white/50">
                <div class="flex justify-around items-center">
                    <button onclick="switchTab('schedule')" id="tab-schedule" class="active-tab flex items-center gap-2 px-4 py-3 tap-effect transition-all duration-300">
                        <i data-lucide="map" class="w-5 h-5"></i><span class="text-xs font-bold">è¡Œç¨‹</span>
                    </button>
                    <button onclick="switchTab('info')" id="tab-info" class="inactive-tab flex items-center gap-2 px-4 py-3 tap-effect transition-all duration-300">
                        <i data-lucide="sparkles" class="w-5 h-5"></i><span class="text-xs font-bold hidden">è³‡è¨Š</span>
                    </button>
                    <button onclick="switchTab('budget')" id="tab-budget" class="inactive-tab flex items-center gap-2 px-4 py-3 tap-effect transition-all duration-300">
                        <i data-lucide="wallet" class="w-5 h-5"></i><span class="text-xs font-bold hidden">è¨˜å¸³</span>
                    </button>
                </div>
            </nav>
        </div>
    </div>

    <!-- Modals (å…±ç”¨) -->
    <div id="detail-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 hidden flex items-end sm:items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-[#FEFDF5] w-full max-w-md rounded-[32px] p-6 shadow-2xl modal-enter relative max-h-[85vh] overflow-y-auto no-scrollbar">
            <div class="w-12 h-1.5 bg-stone-200 rounded-full mx-auto mb-6"></div>
            <div id="detail-content" class="space-y-5"></div>
            <button onclick="closeDetailModal()" class="absolute top-6 right-6 w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-400 hover:text-stone-600 tap-effect"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 hidden flex items-end sm:items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-[#FEFDF5] w-full max-w-md rounded-[32px] p-6 shadow-2xl modal-enter relative max-h-[90vh] overflow-y-auto no-scrollbar">
            <h3 class="text-xl font-bold mb-6 flex justify-between items-center text-[#433D3C]">
                <span id="modal-title">ç·¨è¼¯è¡Œç¨‹</span>
                <button onclick="closeEditModal()" class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-400 hover:text-stone-600 tap-effect"><i data-lucide="x" class="w-5 h-5"></i></button>
            </h3>
            <form id="edit-form" class="space-y-4" onsubmit="saveScheduleItem(event)">
                <input type="hidden" id="edit-day-index"><input type="hidden" id="edit-item-index">
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">é–‹å§‹æ™‚é–“</label><input type="time" id="edit-time" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm text-center"></div>
                    <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">çµæŸæ™‚é–“ (é¸å¡«)</label><input type="time" id="edit-end-time" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm text-center text-stone-500 placeholder-stone-300"></div>
                </div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">é¡å‹</label><select id="edit-type" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm appearance-none"><option value="sight">ğŸ“· æ™¯é»</option><option value="food">ğŸœ ç¾é£Ÿ</option><option value="shop">ğŸ›ï¸ è³¼ç‰©</option><option value="transport">ğŸšŒ äº¤é€š</option><option value="stay">ğŸ›ï¸ ä½å®¿</option></select></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">æ¨™é¡Œ</label><input type="text" id="edit-title" required class="w-full bg-white rounded-2xl p-4 text-sm font-bold border border-transparent focus:border-stone-200 focus:outline-none shadow-sm" placeholder="è¡Œç¨‹åç¨±"></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">åœ°é»</label><div class="relative"><i data-lucide="map-pin" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-stone-400"></i><input type="text" id="edit-location" class="w-full bg-white rounded-2xl p-4 pl-10 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm" placeholder="è¼¸å…¥åœ°é»é—œéµå­—"></div></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">æ¨™ç±¤ (é€—è™Ÿåˆ†éš”)</label><input type="text" id="edit-tags" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm" placeholder="ä¾‹å¦‚: å¿…åƒ, æ¨è–¦"></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">ç°¡çŸ­å‚™è¨»</label><input type="text" id="edit-note" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm" placeholder="é¡¯ç¤ºåœ¨å¡ç‰‡ä¸Šçš„çŸ­å¥"></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">è©³ç´°ä»‹ç´¹ (åŒæ­¥é¡¯ç¤º)</label><textarea id="edit-description" rows="4" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm resize-none" placeholder="é€™è£¡è¼¸å…¥çš„å…§å®¹æœƒåŒæ­¥åˆ°è©³ç´°é é¢..."></textarea></div>
                <div class="pt-4"><button type="submit" class="w-full py-4 rounded-2xl bg-[#433D3C] text-[#FEFDF5] font-bold shadow-lg shadow-stone-300 tap-effect">å„²å­˜è®Šæ›´</button></div>
            </form>
        </div>
    </div>

    <div id="date-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-[#FEFDF5] w-full max-w-sm rounded-[32px] p-6 shadow-2xl modal-enter relative">
            <h3 class="text-lg font-bold mb-6 text-[#433D3C] text-center">è¡Œç¨‹è¨­å®š</h3>
            <div class="space-y-4">
                <div><label class="text-xs text-stone-500 font-bold ml-1 block mb-2">æ—…ç¨‹æ¨™é¡Œ</label><input type="text" id="trip-name-input" class="w-full bg-white rounded-2xl p-4 text-lg font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm text-center text-[#433D3C]"></div>
                <div><label class="text-xs text-stone-500 font-bold ml-1 block mb-2">å‡ºç™¼æ—¥æœŸ</label><input type="date" id="start-date-input" class="w-full bg-white rounded-2xl p-4 text-lg font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm text-center text-[#433D3C]"></div>
                <div><label class="text-xs text-stone-500 font-bold ml-1 block mb-2">æ—…è¡Œç¸½å¤©æ•¸</label><div class="flex items-center gap-3 bg-white rounded-2xl p-2 shadow-sm"><button onclick="changeDays(-1)" class="w-10 h-10 rounded-xl bg-stone-100 text-stone-600 flex items-center justify-center font-bold text-xl tap-effect">-</button><input type="number" id="trip-days-input" readonly class="flex-1 text-center text-xl font-bold bg-transparent border-none focus:ring-0 text-[#433D3C]" value="5"><button onclick="changeDays(1)" class="w-10 h-10 rounded-xl bg-stone-100 text-stone-600 flex items-center justify-center font-bold text-xl tap-effect">+</button></div></div>
            </div>
            <p class="text-[10px] text-red-400 text-center mt-6 mb-2">* æ¸›å°‘å¤©æ•¸å°‡æœƒåˆªé™¤å¤šé¤˜æ—¥æœŸçš„è¡Œç¨‹</p>
            <div class="flex gap-3"><button onclick="closeDateModal()" class="flex-1 py-3 rounded-2xl bg-stone-100 text-stone-500 font-bold tap-effect">å–æ¶ˆ</button><button onclick="updateTripSettings()" class="flex-1 py-3 rounded-2xl bg-[#433D3C] text-white font-bold tap-effect shadow-lg shadow-stone-300">ç¢ºèªæ›´æ–°</button></div>
            
            <hr class="border-stone-200 my-4">
            <button onclick="deleteCurrentTrip()" class="w-full py-3 rounded-2xl bg-red-50 text-red-500 font-bold tap-effect flex items-center justify-center gap-2">
                <i data-lucide="trash-2" class="w-4 h-4"></i> åˆªé™¤æ­¤æ—…ç¨‹
            </button>
        </div>
    </div>

    <div id="security-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-[#FEFDF5] w-full max-w-sm rounded-[32px] p-6 shadow-2xl modal-enter relative text-center">
            <h3 class="text-lg font-bold mb-2 text-[#433D3C]">åˆ†äº«èˆ‡å®‰å…¨è¨­å®š</h3>
            <p class="text-xs text-stone-400 mb-6">è¨­å®šé€šè¡Œç¢¼ï¼Œåªæœ‰çŸ¥é“å¯†ç¢¼çš„äººæ‰èƒ½æŸ¥çœ‹è¡Œç¨‹ã€‚</p>
            <div class="mb-6">
                <label class="text-xs text-stone-500 font-bold mb-2 block text-left ml-1">è¨­å®šé€šè¡Œç¢¼ (4ä½æ•¸å­—)</label>
                <input type="text" id="set-access-code" maxlength="4" class="w-full bg-white rounded-2xl p-4 text-2xl font-bold border border-transparent focus:border-stone-200 focus:outline-none shadow-sm text-center tracking-[0.5em]" placeholder="â€¢â€¢â€¢â€¢">
            </div>
            <div class="flex gap-3">
                <button onclick="closeSecurityModal()" class="flex-1 py-3 rounded-2xl bg-stone-100 text-stone-500 font-bold tap-effect">å–æ¶ˆ</button>
                <button onclick="saveAccessCode()" class="flex-1 py-3 rounded-2xl bg-[#433D3C] text-white font-bold tap-effect shadow-lg shadow-stone-300">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>

    <!-- Firebase Integration -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot, deleteDoc, getDoc, updateDoc, arrayUnion } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = {
          apiKey: "AIzaSyDP1jX1u8TCI3TY8U3xfhEZbaMv9JLgJNw",
          authDomain: "mytaiwantrip-603c6.firebaseapp.com",
          projectId: "mytaiwantrip-603c6",
          storageBucket: "mytaiwantrip-603c6.firebasestorage.app",
          messagingSenderId: "1063667328708",
          appId: "1:1063667328708:web:d2ae7acd304e589b790b91"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // èªè­‰æä¾›è€…
        const provider = new GoogleAuthProvider();

        window.myTrips = JSON.parse(localStorage.getItem('my_trips') || '[]');
        window.currentTripId = null;
        window.isOwner = false;
        window.currentUser = null; // ç”¨æ–¼å„²å­˜ç”¨æˆ¶è³‡è¨Š

        const urlParams = new URLSearchParams(window.location.search);
        const tripIdFromUrl = urlParams.get('id');

        const indicator = document.getElementById('sync-indicator');
        function showSyncing() { indicator.classList.add('show'); }
        function hideSyncing() { setTimeout(() => indicator.classList.remove('show'), 800); }

        // --- Login / Logout Logic ---
        window.toggleUserMenu = () => {
            document.getElementById('user-menu').classList.toggle('show');
        };
        
        // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰é¸å–®
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('user-menu');
            const avatar = document.getElementById('user-avatar');
            if (!menu.contains(e.target) && !avatar.contains(e.target)) {
                menu.classList.remove('show');
            }
        });

        window.handleLogin = async () => {
            try {
                await signInWithPopup(auth, provider);
                document.getElementById('user-menu').classList.remove('show');
            } catch (error) {
                console.error("Login failed", error);
                alert("ç™»å…¥å¤±æ•—: " + error.message);
            }
        };

        window.handleLogout = async () => {
            try {
                await signOut(auth);
                // ç™»å‡ºå¾Œåˆ‡å›åŒ¿åç™»å…¥ä»¥ä¿æŒåŠŸèƒ½æ­£å¸¸
                await signInAnonymously(auth);
                document.getElementById('user-menu').classList.remove('show');
                window.location.reload(); // é‡æ–°è¼‰å…¥ä»¥é‡ç½®ç‹€æ…‹
            } catch (error) {
                console.error("Logout failed", error);
            }
        };

        // --- Trip Synchronization Logic ---
        
        // ç•¶ç”¨æˆ¶ç™»å…¥æ™‚ï¼ŒåŒæ­¥ LocalStorage çš„è¡Œç¨‹åˆ°é›²ç«¯å€‹äººè³‡æ–™
        async function syncUserTrips(user) {
            if (!user || user.isAnonymous) return;

            // 1. è®€å–ç”¨æˆ¶é›²ç«¯çš„è¡Œç¨‹åˆ—è¡¨
            const userProfileRef = doc(db, 'artifacts', 'travel_app_v2', 'users', user.uid, 'data', 'profile');
            let cloudTrips = [];
            
            try {
                const docSnap = await getDoc(userProfileRef);
                if (docSnap.exists()) {
                    cloudTrips = docSnap.data().ids || [];
                }
            } catch (e) { console.error("Error reading profile:", e); }

            // 2. åˆä½µï¼šæœ¬åœ° -> é›²ç«¯
            // æ‰¾å‡ºæœ¬åœ°æœ‰ï¼Œä½†é›²ç«¯æ²’æœ‰çš„
            const localTrips = window.myTrips;
            const newCloudTrips = [...new Set([...cloudTrips, ...localTrips])];

            // å¦‚æœæœ‰è®Šå‹•ï¼Œæ›´æ–°é›²ç«¯
            if (newCloudTrips.length > cloudTrips.length) {
                await setDoc(userProfileRef, { ids: newCloudTrips }, { merge: true });
                console.log("Synced local trips to cloud.");
            }

            // 3. åˆä½µï¼šé›²ç«¯ -> æœ¬åœ°
            // æ›´æ–°æœ¬åœ°åˆ—è¡¨ï¼Œç¢ºä¿åœ¨å…¶ä»–è£ç½®ä¹Ÿèƒ½çœ‹åˆ°
            window.myTrips = newCloudTrips;
            localStorage.setItem('my_trips', JSON.stringify(window.myTrips));

            // é‡æ–°æ¸²æŸ“é¦–é åˆ—è¡¨
            if (!window.currentTripId) {
                window.renderDashboard();
            }
        }

        // Cloud Functions
        window.saveTripMetadata = async (id, name, date, days, accessCode = null) => {
            if (!auth.currentUser) return;
            const data = { name, date, days, ownerId: auth.currentUser.uid };
            if (accessCode !== null) data.accessCode = accessCode;
            await setDoc(doc(db, 'trips', id), { meta: data }, { merge: true });
        };

        window.saveTripData = async (tripId, type, data) => {
            if (!auth.currentUser) return;
            showSyncing();
            const docRef = doc(db, 'trips', tripId, 'data', type);
            await setDoc(docRef, { items: data });
            hideSyncing();
        };

        // Access Control Logic
        window.tripMeta = {};
        window.checkAccess = (meta) => {
            if (meta.accessCode && meta.ownerId !== auth.currentUser.uid) {
                const unlocked = sessionStorage.getItem(`unlocked_${window.currentTripId}`);
                if (unlocked !== 'true') {
                    document.getElementById('lock-screen').classList.add('active');
                    document.getElementById('view-app').classList.add('hidden');
                    return false;
                }
            }
            document.getElementById('lock-screen').classList.remove('active');
            return true;
        };

        window.verifyAccessCode = () => {
            const input = document.getElementById('access-code-input').value;
            if (input === window.tripMeta.accessCode) {
                sessionStorage.setItem(`unlocked_${window.currentTripId}`, 'true');
                document.getElementById('lock-screen').classList.remove('active');
                document.getElementById('view-app').classList.remove('hidden');
                window.renderTripView();
            } else {
                alert("å¯†ç¢¼éŒ¯èª¤");
                document.getElementById('access-code-input').value = '';
            }
        };

        // Load Trip
        window.loadTrip = async (tripId) => {
            window.currentTripId = tripId;
            
            if(!window.myTrips.includes(tripId)) {
                window.myTrips.push(tripId);
                localStorage.setItem('my_trips', JSON.stringify(window.myTrips));
                // å¦‚æœå·²ç™»å…¥ï¼ŒåŒæ­¥æ­¤æ–°åŠ å…¥çš„è¡Œç¨‹åˆ°é›²ç«¯
                if (auth.currentUser && !auth.currentUser.isAnonymous) {
                    syncUserTrips(auth.currentUser);
                }
            }

            document.getElementById('view-home').classList.add('hidden');
            
            onSnapshot(doc(db, 'trips', tripId), (docSnap) => {
                if(docSnap.exists() && docSnap.data().meta) {
                    window.tripMeta = docSnap.data().meta;
                    window.isOwner = (window.tripMeta.ownerId === auth.currentUser.uid);
                    
                    const lockIcon = document.getElementById('header-lock-icon');
                    if (window.tripMeta.accessCode) {
                        lockIcon.setAttribute('data-lucide', 'lock');
                        lockIcon.classList.add('text-red-400');
                    } else {
                        lockIcon.setAttribute('data-lucide', 'unlock');
                        lockIcon.classList.remove('text-red-400');
                    }
                    lucide.createIcons();

                    if (window.checkAccess(window.tripMeta)) {
                         document.getElementById('view-app').classList.remove('hidden');
                         document.getElementById('header-trip-title').innerText = window.tripMeta.name || "æœªå‘½åæ—…ç¨‹";
                    }
                }
            });

            onSnapshot(doc(db, 'trips', tripId, 'data', 'schedule'), (docSnap) => {
                if (docSnap.exists()) {
                    window.scheduleData = docSnap.data().items;
                    window.renderTripView();
                }
            });
            
            onSnapshot(doc(db, 'trips', tripId, 'data', 'expenses'), (docSnap) => {
                window.expenses = docSnap.exists() ? docSnap.data().items : [];
                window.renderExpenses();
            });

            onSnapshot(doc(db, 'trips', tripId, 'data', 'companions'), (docSnap) => {
                window.companions = docSnap.exists() ? docSnap.data().items : ["æˆ‘"];
                window.updatePayerSelect();
                window.renderShareButtons();
                window.renderFilter();
            });
        };

        window.renderTripView = () => {
            if (!document.getElementById('lock-screen').classList.contains('active')) {
                 window.renderDaySelector();
                 window.renderTimeline(window.currentDayIndex);
            }
        };

        window.createNewTrip = async () => {
            const name = prompt("è«‹è¼¸å…¥æ–°æ—…ç¨‹åç¨± (ä¾‹å¦‚: æ±äº¬è³æ«»):");
            if(!name) return;
            
            const newId = 'trip_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            const today = new Date().toISOString().split('T')[0];
            const days = 3;

            await window.saveTripMetadata(newId, name, today, days);
            
            const initialSchedule = Array(days).fill().map((_, i) => ({ date: "", month: "", day: `Day ${i+1}`, items: [] }));
            await window.saveTripData(newId, 'schedule', initialSchedule);
            await window.saveTripData(newId, 'expenses', []);
            await window.saveTripData(newId, 'companions', ["æˆ‘"]);

            window.loadTrip(newId);
        };

        window.renderDashboard = async () => {
            if(tripIdFromUrl) return;

            const container = document.getElementById('trip-list-container');
            container.innerHTML = '';

            if (window.myTrips.length === 0) {
                 container.innerHTML = `
                    <div class="text-center text-stone-400 mt-20 flex flex-col items-center">
                        <i data-lucide="map" class="w-12 h-12 mb-4 opacity-50"></i>
                        <p class="text-lg font-bold">é‚„æ²’æœ‰æ—…ç¨‹</p>
                        <p class="text-sm mt-2">é»æ“Šå³ä¸Šè§’çš„ã€Œ+ã€é–‹å§‹è¦åŠƒ</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            let html = '';
            for(const id of window.myTrips) {
                const docSnap = await getDoc(doc(db, 'trips', id));
                if(docSnap.exists()) {
                    const meta = docSnap.data().meta || { name: 'æœªå‘½å', date: '?', days: '?' };
                    const isLocked = meta.accessCode ? true : false;
                    const lockIcon = isLocked ? '<i data-lucide="lock" class="w-3 h-3 text-stone-300"></i>' : '';
                    
                    html += `
                        <div onclick="loadTrip('${id}')" class="bg-white rounded-[24px] p-5 zen-shadow relative overflow-hidden card-clickable group border border-white mb-4">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-bl from-stone-100 to-transparent rounded-bl-full opacity-50"></div>
                            <div class="relative z-10">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-[10px] font-bold text-stone-400 tracking-widest uppercase flex items-center gap-1">TRIP ${lockIcon}</span>
                                    <button onclick="deleteTrip(event, '${id}')" class="text-stone-300 hover:text-red-400 p-1 -mr-2 -mt-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                                <h2 class="text-2xl font-bold text-[#433D3C] mb-1">${meta.name}</h2>
                                <div class="flex items-center gap-2 text-stone-500 text-xs font-bold">
                                    <i data-lucide="calendar" class="w-3 h-3"></i>
                                    <span>${meta.date}</span>
                                    <span class="w-1 h-1 rounded-full bg-stone-300"></span>
                                    <span>${meta.days} Days</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            container.innerHTML = html;
            lucide.createIcons();
        };

        // Init Firebase & Auth Listener
        function initFirebase() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    window.currentUser = user;
                    if(user.isAnonymous) {
                        // åŒ¿åæ¨¡å¼ UI
                        document.getElementById('user-img').classList.add('hidden');
                        document.getElementById('user-avatar').classList.remove('logged-in');
                        document.getElementById('user-info').innerText = 'è¨ªå®¢æ¨¡å¼';
                        document.getElementById('user-info').classList.remove('hidden');
                        document.getElementById('btn-login').classList.remove('hidden');
                        document.getElementById('btn-logout').classList.add('hidden');
                    } else {
                        // å·²ç™»å…¥ UI
                        document.getElementById('user-img').src = user.photoURL;
                        document.getElementById('user-img').classList.remove('hidden');
                        document.getElementById('user-avatar').classList.add('logged-in');
                        document.getElementById('user-info').innerText = `Hi, ${user.displayName}`;
                        document.getElementById('user-info').classList.remove('hidden');
                        document.getElementById('btn-login').classList.add('hidden');
                        document.getElementById('btn-logout').classList.remove('hidden');

                        // å•Ÿå‹•åŒæ­¥
                        syncUserTrips(user);
                    }
                } else {
                    // æ²’ç™»å…¥æ™‚è‡ªå‹•åŒ¿åç™»å…¥
                    signInAnonymously(auth);
                }
                
                if(tripIdFromUrl) {
                    window.loadTrip(tripIdFromUrl);
                } else {
                    window.renderDashboard();
                }
            });
        }
        initFirebase();
    </script>

    <script>
        // --- UI Logic ---
        const EXCHANGE_RATE = 0.24;
        window.defaultScheduleData = []; // Clean default

        window.scheduleData = [];
        window.currentDayIndex = 0;
        window.expenses = [];
        window.companions = ["æˆ‘"];
        window.currentFilter = 'ALL';

        function init() {
            lucide.createIcons();
            generateHourlyWeather();
            
            document.getElementById('expense-amount').addEventListener('input', function(e) {
                const val = parseInt(e.target.value) || 0;
                document.getElementById('input-hkd-preview').innerText = Math.round(val * EXCHANGE_RATE);
            });
        }

        window.backToHome = function() {
            const newUrl = window.location.origin + window.location.pathname;
            window.history.pushState({path:newUrl},'',newUrl);
            document.getElementById('view-app').classList.add('hidden');
            document.getElementById('view-home').classList.remove('hidden');
            window.currentTripId = null;
            window.renderDashboard();
        };

        window.shareTrip = function() {
            if(!window.currentTripId) return;
            const url = window.location.origin + window.location.pathname + '?id=' + window.currentTripId;
            let msg = "åˆ†äº«é€£çµå·²è¤‡è£½ï¼";
            if(window.tripMeta.accessCode) msg += `\n\næ­¤æ—…ç¨‹å·²è¨­å®šé€šè¡Œç¢¼ï¼š${window.tripMeta.accessCode}\nè«‹å°‡å¯†ç¢¼ä¸€ä½µå‘Šè¨´æœ‹å‹ã€‚`;
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(url).then(() => alert(msg));
            } else {
                prompt("è«‹è¤‡è£½ä»¥ä¸‹é€£çµåˆ†äº«çµ¦æœ‹å‹ï¼š", url);
            }
        };

        window.deleteCurrentTrip = async function() {
            if(!confirm("ç¢ºå®šè¦åˆªé™¤ç›®å‰çš„æ—…ç¨‹å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) return;
            if(!window.currentTripId) return;
            window.myTrips = window.myTrips.filter(id => id !== window.currentTripId);
            localStorage.setItem('my_trips', JSON.stringify(window.myTrips));
            // If logged in, sync deletion to cloud list
            if (auth.currentUser && !auth.currentUser.isAnonymous) {
                 const userProfileRef = doc(db, 'artifacts', 'travel_app_v2', 'users', auth.currentUser.uid, 'data', 'profile');
                 setDoc(userProfileRef, { ids: window.myTrips }, { merge: true });
            }
            window.closeDateModal();
            window.backToHome();
        };

        // Security Functions
        const securityModal = document.getElementById('security-modal');
        window.openSecurityModal = function() { 
            if(!window.isOwner) return alert("åªæœ‰æ—…ç¨‹å»ºç«‹è€…å¯ä»¥ä¿®æ”¹å®‰å…¨è¨­å®š");
            document.getElementById('set-access-code').value = window.tripMeta.accessCode || '';
            securityModal.classList.remove('hidden'); 
        }
        window.closeSecurityModal = function() { securityModal.classList.add('hidden'); }
        
        window.saveAccessCode = async function() {
            const code = document.getElementById('set-access-code').value;
            if(code && code.length !== 4) return alert("è«‹è¨­å®š 4 ä½æ•¸é€šè¡Œç¢¼");
            await window.saveTripMetadata(window.currentTripId, window.tripMeta.name, window.tripMeta.date, window.tripMeta.days, code || null);
            window.closeSecurityModal();
            alert(code ? "å·²è¨­å®šå¯†ç¢¼ä¿è­·" : "å·²ç§»é™¤å¯†ç¢¼ä¿è­·");
        };

        // Core Wrapper
        window.saveCurrentSchedule = () => window.saveTripData(window.currentTripId, 'schedule', window.scheduleData);
        window.saveCurrentExpenses = () => window.saveTripData(window.currentTripId, 'expenses', window.expenses);
        window.saveCurrentCompanions = () => window.saveTripData(window.currentTripId, 'companions', window.companions);

        // Trip Settings Update
        const dateModal = document.getElementById('date-modal');
        const tripNameInput = document.getElementById('trip-name-input');
        const startDateInput = document.getElementById('start-date-input');
        const tripDaysInput = document.getElementById('trip-days-input');

        window.openDateModal = function() {
            const headerTitle = document.getElementById('header-trip-title').innerText;
            tripNameInput.value = headerTitle;
            const start = window.scheduleData[0] ? `2025-${window.scheduleData[0].month}-${window.scheduleData[0].date}` : ''; 
            startDateInput.value = window.tripMeta.date || new Date().toISOString().split('T')[0]; 
            tripDaysInput.value = window.scheduleData.length;
            dateModal.classList.remove('hidden');
        }
        window.closeDateModal = function() { dateModal.classList.add('hidden'); }
        window.changeDays = function(delta) { let v = parseInt(tripDaysInput.value) + delta; if(v < 1) v = 1; tripDaysInput.value = v; }
        
        window.updateTripSettings = async function() {
            const name = tripNameInput.value || "æœªå‘½åæ—…ç¨‹";
            const dStr = startDateInput.value;
            const days = parseInt(tripDaysInput.value);
            if(!dStr) return alert("è«‹é¸æ“‡æ—¥æœŸ");
            document.getElementById('header-trip-title').innerText = name;
            window.saveTripMetadata(window.currentTripId, name, dStr, days, window.tripMeta.accessCode);

            const start = new Date(dStr);
            if(days > window.scheduleData.length) { for(let i=window.scheduleData.length; i<days; i++) window.scheduleData.push({ date:"", month:"", day:`Day ${i+1}`, items:[] }); }
            else if(days < window.scheduleData.length) { if(!confirm(`ç¢ºå®šæ¸›å°‘å¤©æ•¸ï¼Ÿ`)) return; window.scheduleData.length = days; }
            
            window.scheduleData.forEach((d, i) => { 
                const dt = new Date(start); dt.setDate(start.getDate()+i); 
                d.date=dt.getDate(); d.month=dt.getMonth()+1; d.day=`Day ${i+1}`; 
            });
            
            window.saveCurrentSchedule();
            window.renderDaySelector();
            window.renderTimeline(0);
            window.closeDateModal();
        }

        // ... (Rest of logic remains same: renderDaySelector, selectDay, renderTimeline, setFilter, renderFilter, renderExpenses, addExpense, deleteExpense, promptAddCompanion, updatePayerSelect, renderShareButtons, toggleShare, selectAllShares, openDetailModal, closeDetailModal, openAddModal, openEditModal, closeEditModal, saveScheduleItem, deleteScheduleItem, switchTab, generateHourlyWeather)
        
        window.renderDaySelector = function() { const c = document.getElementById('day-selector'); c.innerHTML = window.scheduleData.map((d, i) => `<button onclick="selectDay(${i})" class="day-btn flex-shrink-0 flex flex-col items-center justify-center w-[60px] h-[72px] rounded-2xl transition-all border border-transparent tap-effect ${i===window.currentDayIndex?'bg-[#433D3C] text-[#FEFDF5] shadow-lg shadow-stone-200':'bg-white text-stone-300'}"><span class="text-[10px] font-bold tracking-wide opacity-80">${d.day}</span><span class="text-xl font-bold font-mono mt-1">${d.month}/${d.date}</span></button>`).join(''); }
        window.selectDay = function(i) { window.currentDayIndex = i; window.renderDaySelector(); window.renderTimeline(i); generateHourlyWeather(); }
        window.renderTimeline = function(i) { 
            const c = document.getElementById('timeline-container'); 
            if (!window.scheduleData[i]) { c.innerHTML = ''; return; }
            const d = window.scheduleData[i];
            d.items.sort((a,b)=>a.time.localeCompare(b.time));
            c.innerHTML = d.items.map((item, idx) => {
                let icon = item.type==='food'?'utensils':item.type==='transport'?'bus':item.type==='shop'?'shopping-bag':item.type==='stay'?'bed':'map-pin';
                let color = item.type==='food'?'text-orange-500 bg-orange-50':item.type==='transport'?'text-blue-500 bg-blue-50':item.type==='shop'?'text-pink-500 bg-pink-50':item.type==='stay'?'text-purple-500 bg-purple-50':'text-stone-500 bg-stone-100';
                let tags = item.tags ? item.tags.map(t => `<span class="text-[10px] px-2.5 py-1 rounded-lg font-bold bg-stone-50 text-stone-500 ${t.includes('å¿…')?'tag-must-eat':''}">${t}</span>`).join('') : '';
                let timeDisplay = `<div class="text-center"><span class="text-xs font-bold text-stone-400 font-mono block leading-tight">${item.time}</span>`;
                if(item.endTime) timeDisplay += `<span class="text-[10px] text-stone-300 font-mono block leading-tight my-0.5">â†“</span><span class="text-xs font-bold text-stone-400 font-mono block leading-tight">${item.endTime}</span>`;
                timeDisplay += `</div>`;
                return `<div onclick="openDetailModal(${i}, ${idx})" class="card-clickable bg-white rounded-[24px] p-5 zen-shadow relative overflow-hidden animate-slide-up mb-4 border border-white active:bg-stone-50 transition-colors"><div class="flex gap-4"><div class="flex flex-col items-center pt-1 w-12 flex-shrink-0">${timeDisplay}<div class="w-10 h-10 rounded-full flex items-center justify-center ${color} mt-2"><i data-lucide="${icon}" class="w-5 h-5"></i></div><div class="h-full w-0.5 bg-stone-100 my-2 rounded-full"></div></div><div class="flex-1 pb-2 min-w-0"><div class="flex justify-between items-start"><h3 class="font-bold text-[#433D3C] text-lg leading-tight truncate mr-2">${item.title}</h3></div><div class="flex items-center gap-2 mt-2 mb-3"><div class="text-xs flex items-center gap-1.5 bg-stone-50 text-stone-500 px-3 py-1.5 rounded-xl max-w-full truncate font-medium"><i data-lucide="map-pin" class="w-3 h-3 flex-shrink-0"></i><span class="truncate">${item.location||'è¨­å®šåœ°é»'}</span></div></div>${item.note?`<p class="text-xs text-stone-400 mt-1 line-clamp-2 leading-relaxed bg-[#FEFDF5] p-2 rounded-lg">${item.note}</p>`:''}<div class="flex flex-wrap gap-2 mt-3">${tags}</div><div class="flex justify-end gap-2 mt-3 pt-2 border-t border-stone-50"><button onclick="event.stopPropagation(); openEditModal(${i}, ${idx})" class="px-3 py-1.5 bg-stone-100 rounded-lg text-xs font-bold text-stone-500 tap-effect flex items-center gap-1"><i data-lucide="pencil" class="w-3 h-3"></i> ç·¨è¼¯</button><button onclick="event.stopPropagation(); deleteScheduleItem(${i}, ${idx})" class="px-3 py-1.5 bg-red-50 rounded-lg text-xs font-bold text-red-400 tap-effect flex items-center gap-1"><i data-lucide="trash-2" class="w-3 h-3"></i> åˆªé™¤</button></div></div></div></div>`;
            }).join('') + `<button onclick="openAddModal(${i})" class="w-full py-4 rounded-[24px] border-2 border-dashed border-stone-200 text-stone-300 hover:border-stone-300 hover:text-stone-500 transition-all flex items-center justify-center gap-2 tap-effect mt-2 bg-white/50"><i data-lucide="plus" class="w-5 h-5"></i><span class="font-bold">æ–°å¢è¡Œç¨‹</span></button>`;
            lucide.createIcons();
        }
        window.setFilter = function(name) { window.currentFilter = name; window.renderExpenses(); }
        window.renderFilter = function() { const c = document.getElementById('member-filter-container'); let h = `<button onclick="setFilter('ALL')" class="flex-shrink-0 px-4 py-1.5 rounded-full text-xs transition-all ${window.currentFilter === 'ALL' ? 'filter-btn-active' : 'filter-btn-inactive'}">å…¨é«”</button>`; window.companions.forEach(n => { h += `<button onclick="setFilter('${n}')" class="flex-shrink-0 px-4 py-1.5 rounded-full text-xs transition-all ${window.currentFilter === n ? 'filter-btn-active' : 'filter-btn-inactive'}">${n}</button>`; }); c.innerHTML = h; }
        window.renderExpenses = function() {
            const list = document.getElementById('expense-list');
            const totalTwdEl = document.getElementById('total-expense-twd');
            const totalHkdEl = document.getElementById('total-expense-hkd');
            const titleEl = document.getElementById('budget-title');
            let displayExpenses = []; let totalTWD = 0;
            if (window.currentFilter === 'ALL') { displayExpenses = window.expenses; titleEl.innerText = "ç¸½æ¶ˆè²» (ALL)"; totalTWD = window.expenses.reduce((sum, ex) => sum + parseInt(ex.amount), 0); } 
            else { titleEl.innerText = `å€‹äººæ¶ˆè²» (${window.currentFilter})`; displayExpenses = window.expenses.filter(ex => (ex.sharedBy || ["æˆ‘"]).includes(window.currentFilter)); totalTWD = displayExpenses.reduce((sum, ex) => { const count = (ex.sharedBy && ex.sharedBy.length > 0) ? ex.sharedBy.length : 1; return sum + (parseInt(ex.amount) / count); }, 0); }
            list.innerHTML = displayExpenses.map((ex, i) => {
                const originalIndex = window.expenses.indexOf(ex);
                const fullAmount = parseInt(ex.amount);
                let displayAmount = fullAmount; let label = "ç¸½é¡"; let cls = "text-stone-800";
                if (window.currentFilter !== 'ALL') { const count = (ex.sharedBy||[]).length || 1; displayAmount = fullAmount / count; label = "æ‡‰ä»˜"; cls = "text-blue-600"; }
                return `<div class="flex flex-col bg-white p-4 rounded-[20px] shadow-sm border border-stone-100"><div class="flex justify-between items-start mb-2"><div><span class="text-base font-bold text-stone-700 block">${ex.item}</span><span class="text-[10px] text-stone-400">ç”± ${ex.payer||'æˆ‘'} å…ˆä»˜</span></div><div class="text-right"><div class="text-[10px] text-stone-300 font-bold mb-0.5 text-right">${label}</div><div class="font-mono font-bold ${cls} text-lg">NT$ ${Math.round(displayAmount)}</div><div class="font-mono text-xs text-stone-400">â‰ˆ HK$ ${Math.round(displayAmount*EXCHANGE_RATE)}</div></div></div><div class="flex justify-end border-t border-stone-50 pt-2 mt-1"><button onclick="deleteExpense(${originalIndex})" class="text-xs text-stone-300 hover:text-red-400 flex items-center gap-1 px-2 py-1 rounded tap-effect"><i data-lucide="trash-2" class="w-3 h-3"></i> åˆªé™¤</button></div></div>`;
            }).reverse().join('') || `<div class="text-center text-stone-300 text-sm py-8">æ²’æœ‰ç›¸é—œç´€éŒ„</div>`;
            totalTwdEl.innerText = Math.round(totalTWD).toLocaleString(); totalHkdEl.innerText = Math.round(totalTWD * EXCHANGE_RATE).toLocaleString();
            window.renderFilter(); lucide.createIcons();
        }
        window.addExpense = function() { const item = document.getElementById('expense-item').value; const amount = document.getElementById('expense-amount').value; const payer = document.getElementById('expense-payer').value; const shareBtns = document.querySelectorAll('.share-toggle-btn.share-btn-selected'); const sharedBy = Array.from(shareBtns).map(btn => btn.getAttribute('data-name')); if(!item || !amount) return alert("è«‹è¼¸å…¥é …ç›®å’Œé‡‘é¡"); if(sharedBy.length === 0) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€ä½åˆ†æ”¤å°è±¡"); window.expenses.push({ item, amount, payer, sharedBy }); document.getElementById('expense-item').value = ''; document.getElementById('expense-amount').value = ''; window.saveCurrentExpenses(); }
        window.deleteExpense = function(index) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { window.expenses.splice(index, 1); window.saveCurrentExpenses(); } }
        window.promptAddCompanion = function() { const name = prompt("è«‹è¼¸å…¥æ—…ä¼´åå­—ï¼š"); if (name && name.trim() !== "") { if (!window.companions.includes(name.trim())) { window.companions.push(name.trim()); window.saveCurrentCompanions(); } } }
        window.updatePayerSelect = function() { document.getElementById('expense-payer').innerHTML = window.companions.map(c => `<option value="${c}">${c}</option>`).join(''); }
        window.renderShareButtons = function() { document.getElementById('share-buttons-container').innerHTML = window.companions.map(c => `<button type="button" class="share-toggle-btn share-btn-selected px-3 py-1.5 rounded-lg text-xs font-bold border transition-colors" data-name="${c}" onclick="toggleShare(this)">${c}</button>`).join(''); }
        window.toggleShare = function(btn) { if (btn.classList.contains('share-btn-selected')) { btn.classList.remove('share-btn-selected'); btn.classList.add('share-btn-unselected'); } else { btn.classList.remove('share-btn-unselected'); btn.classList.add('share-btn-selected'); } }
        window.selectAllShares = function() { document.querySelectorAll('.share-toggle-btn').forEach(btn => { btn.classList.remove('share-btn-unselected'); btn.classList.add('share-btn-selected'); }); }
        window.openDetailModal = function(dayIndex, itemIndex) { const item = window.scheduleData[dayIndex].items[itemIndex]; let icon = item.type==='food'?'utensils':item.type==='transport'?'bus':item.type==='shop'?'shopping-bag':item.type==='stay'?'bed':'map-pin'; let timeStr = item.time; if (item.endTime) timeStr += ` - ${item.endTime}`; const desc = item.description ? item.description.split('\n').map(l=>`<p class="mb-2">${l}</p>`).join('') : '<p class="text-stone-400 italic">æš«ç„¡è©³ç´°ä»‹ç´¹...</p>'; document.getElementById('detail-content').innerHTML = `<div class="flex items-start justify-between mb-2"><div class="w-12 h-12 rounded-2xl bg-stone-100 flex items-center justify-center text-stone-600"><i data-lucide="${icon}" class="w-6 h-6"></i></div><div class="text-right"><p class="text-2xl font-mono font-bold text-stone-800">${timeStr}</p><p class="text-xs text-stone-400 font-bold">11æœˆ${window.scheduleData[dayIndex].date}æ—¥</p></div></div><h2 class="text-2xl font-bold text-[#433D3C] mb-1 leading-tight">${item.title}</h2><button onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}')" class="inline-flex items-center gap-1.5 text-blue-500 text-sm font-bold mb-4 tap-effect"><i data-lucide="map-pin" class="w-4 h-4"></i> ${item.location || 'è¨­å®šåœ°é»'} <i data-lucide="external-link" class="w-3 h-3"></i></button><div class="bg-white p-5 rounded-2xl border border-stone-100 shadow-sm"><h4 class="text-xs font-bold text-stone-400 mb-3 uppercase tracking-wider">ABOUT</h4><div class="text-stone-600 text-sm leading-relaxed space-y-2">${desc}</div></div>`; document.getElementById('detail-modal').classList.remove('hidden'); lucide.createIcons(); }
        window.closeDetailModal = function() { document.getElementById('detail-modal').classList.add('hidden'); }
        window.openAddModal = function(dayIndex) { document.getElementById('edit-day-index').value = dayIndex; document.getElementById('edit-item-index').value = -1; document.getElementById('modal-title').innerText = "æ–°å¢è¡Œç¨‹"; document.getElementById('edit-time').value = "12:00"; document.getElementById('edit-end-time').value = ""; document.getElementById('edit-type').value = "sight"; document.getElementById('edit-title').value = ""; document.getElementById('edit-location').value = ""; document.getElementById('edit-tags').value = ""; document.getElementById('edit-note').value = ""; document.getElementById('edit-description').value = ""; document.getElementById('edit-modal').classList.remove('hidden'); }
        window.openEditModal = function(dayIndex, itemIndex) { const item = window.scheduleData[dayIndex].items[itemIndex]; document.getElementById('edit-day-index').value = dayIndex; document.getElementById('edit-item-index').value = itemIndex; document.getElementById('modal-title').innerText = "ç·¨è¼¯è¡Œç¨‹"; document.getElementById('edit-time').value = item.time; document.getElementById('edit-end-time').value = item.endTime || ""; document.getElementById('edit-type').value = item.type; document.getElementById('edit-title').value = item.title; document.getElementById('edit-location').value = item.location; document.getElementById('edit-tags').value = item.tags?item.tags.join(', '):''; document.getElementById('edit-note').value = item.note||''; document.getElementById('edit-description').value = item.description||''; document.getElementById('edit-modal').classList.remove('hidden'); }
        window.closeEditModal = function() { document.getElementById('edit-modal').classList.add('hidden'); }
        window.saveScheduleItem = function(e) { e.preventDefault(); const d = parseInt(document.getElementById('edit-day-index').value); const i = parseInt(document.getElementById('edit-item-index').value); const item = { time: document.getElementById('edit-time').value, endTime: document.getElementById('edit-end-time').value, type: document.getElementById('edit-type').value, title: document.getElementById('edit-title').value, location: document.getElementById('edit-location').value, tags: document.getElementById('edit-tags').value.split(',').map(t=>t.trim()).filter(t=>t), note: document.getElementById('edit-note').value, description: document.getElementById('edit-description').value }; if (i === -1) window.scheduleData[d].items.push(item); else window.scheduleData[d].items[i] = item; window.saveCurrentSchedule(); window.renderTimeline(d); window.closeEditModal(); }
        window.deleteScheduleItem = function(d, i) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { window.scheduleData[d].items.splice(i, 1); window.saveCurrentSchedule(); window.renderTimeline(d); } }
        window.switchTab = function(tabId) { document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden')); document.getElementById(`view-${tabId}`).classList.remove('hidden'); ['schedule', 'info', 'budget'].forEach(id => { const btn = document.getElementById(`tab-${id}`); const span = btn.querySelector('span'); if(id === tabId) { btn.className = "active-tab flex items-center gap-2 px-5 py-3 tap-effect transition-all duration-300"; span.classList.remove('hidden'); } else { btn.className = "inactive-tab flex items-center gap-2 px-3 py-3 tap-effect transition-all duration-300"; span.classList.add('hidden'); } }); }
        function generateHourlyWeather() { const ws = [{i:'sun',t:22},{i:'cloud-sun',t:24},{i:'cloud',t:23},{i:'cloud-rain',t:20}]; let h=''; for(let i=6;i<=23;i++){ const m=ws[Math.floor(Math.random()*ws.length)]; h+=`<div class="weather-scroll-item flex flex-col items-center justify-center bg-stone-50 rounded-xl py-2 px-1 snap-start"><span class="text-[10px] text-stone-400 font-mono mb-1">${i}:00</span><i data-lucide="${m.i}" class="w-5 h-5 text-stone-600 mb-1"></i><span class="text-xs font-bold text-stone-800">${m.t}Â°</span></div>`; } document.getElementById('hourly-weather-container').innerHTML=h; }

        init();
        const style = document.createElement('style');
        style.innerHTML = `@keyframes fade-in { from { opacity: 0; } to { opacity: 1; } } @keyframes slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } } .animate-fade-in { animation: fade-in 0.4s ease-out; } .animate-slide-up { animation: slide-up 0.5s cubic-bezier(0.16, 1, 0.3, 1); }`;
        document.head.appendChild(style);
    </script>
</body>
</html>
