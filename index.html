<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å°ç£ä¹‹æ—…</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FEFDF5"> <!-- æ›´æ–°ç‚ºç±³è‰² -->
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* æ—¥å¼æŸ”å’Œé…è‰² */
            --bg-color: #FEFDF5;      /* è±†ä¹³ç±³è‰²èƒŒæ™¯ */
            --card-bg: #FFFFFF;       /* ç´”ç™½å¡ç‰‡ */
            --text-main: #433D3C;     /* æš–æ·±ç° (ä¸ä½¿ç”¨ç´”é»‘) */
            --text-sub: #9CA3AF;      /* æŸ”å’Œç° */
            --accent: #D4C4B7;        /* å¥¶èŒ¶è‰²è£é£¾ */
            --highlight: #F43F5E;     /* æŸ”å’Œç´… (é‡é»æ¨™ç±¤) */
        }

        body {
            /* æ”¹ç”¨åœ“é«”å­—ï¼Œçœ‹èµ·ä¾†æ›´å¯æ„› (QQçš„æ„Ÿè¦º) */
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            -webkit-user-select: none;
            user-select: none;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* QQ çš„æŸ”å’Œé™°å½± */
        .zen-shadow {
            box-shadow: 0 8px 24px rgba(149, 157, 165, 0.08);
            border: 1px solid rgba(255,255,255,0.8);
        }

        /* æ¨™ç±¤æ¨£å¼ - æ›´åœ“æ½¤ */
        .tag-must-eat { background: #FFE4E6; color: #BE123C; }
        .tag-nav { background: #F3F4F6; color: #374151; }
        .tag-tips { background: #E0F2FE; color: #0369A1; }

        /* åº•éƒ¨å°èˆªé¸ä¸­ç‹€æ…‹ - åŠ ä¸€é»å¯æ„›çš„åº•è‰² */
        .active-tab {
            color: #57534E;
            font-weight: 700;
            background-color: #F5F5F4;
            border-radius: 16px;
        }
        
        .inactive-tab { color: #A8A29E; }

        /* æŒ‰éˆ•é»æ“Šæ„Ÿ (QQå½ˆåŠ›) */
        .tap-effect:active { opacity: 0.8; transform: scale(0.95); transition: transform 0.1s cubic-bezier(0.34, 1.56, 0.64, 1); }
        
        /* Modal å‹•ç•« */
        @keyframes slide-up-spring {
            0% { transform: translateY(100%); opacity: 0; }
            60% { transform: translateY(-10px); opacity: 1; }
            100% { transform: translateY(0); }
        }
        .modal-enter { animation: slide-up-spring 0.4s ease-out forwards; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-[#FEFDF5]">

    <!-- é ‚éƒ¨è³‡è¨Š -->
    <header class="bg-[#FEFDF5]/90 backdrop-blur-sm pt-safe-top sticky top-0 z-20 px-6 py-4 flex justify-between items-end">
        <div>
            <p class="text-[10px] text-gray-400 tracking-widest mb-1 font-bold">TAIPEI TRIP</p>
            <h1 class="text-2xl font-bold tracking-wide text-[#433D3C]">å°ç£äº”æ—¥éŠ</h1>
        </div>
        <div class="text-right flex flex-col items-end gap-1">
             <div class="flex items-center gap-1 text-gray-600 bg-white px-3 py-1 rounded-full shadow-sm border border-stone-100">
                <i data-lucide="cloud" class="w-4 h-4 text-stone-400"></i>
                <span class="text-sm font-bold">22Â°C</span>
            </div>
            <button onclick="resetToDefault()" class="text-[10px] text-stone-400 underline mt-1 hover:text-stone-600 transition-colors">æ¢å¾©é è¨­</button>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main id="main-content" class="flex-1 overflow-y-auto no-scrollbar pb-28 relative px-4">
        
        <!-- Tab 1: è¡Œç¨‹ -->
        <div id="view-schedule" class="view-section pt-2 space-y-6 animate-fade-in">
            
            <!-- æ—¥æœŸé¸æ“‡ (æ©«å‘æ²å‹•) -->
            <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2 px-1" id="day-selector">
                <!-- JS ç”Ÿæˆ -->
            </div>

            <!-- æ™‚é–“è»¸å®¹å™¨ -->
            <div id="timeline-container" class="space-y-4 pb-10">
                <!-- JS ç”Ÿæˆ -->
            </div>
        </div>

        <!-- Tab 2: è³‡è¨Š (èˆªç­/ä½å®¿/ç·Šæ€¥) -->
        <div id="view-info" class="view-section hidden pt-4 space-y-6 animate-fade-in">
            
            <!-- èˆªç­å¡ç‰‡ -->
            <div class="bg-white rounded-[24px] p-6 zen-shadow">
                <h3 class="text-lg font-bold text-gray-800 mb-5 flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-500">
                        <i data-lucide="plane-takeoff" class="w-4 h-4"></i> 
                    </div>
                    èˆªç­è³‡è¨Š
                </h3>
                <div class="space-y-6">
                    <!-- å»ç¨‹ -->
                    <div class="relative pl-6 border-l-2 border-stone-100">
                        <div class="absolute -left-[7px] top-0 w-3 h-3 rounded-full bg-stone-200 border-2 border-white ring-1 ring-stone-100"></div>
                        <p class="text-xs text-stone-400 mb-1 font-bold">å»ç¨‹ 11/27 (Day 1)</p>
                        <div class="flex justify-between items-center mb-2 bg-stone-50 p-3 rounded-xl">
                            <span class="text-xl font-bold text-stone-700">HKG</span>
                            <i data-lucide="arrow-right" class="w-4 h-4 text-stone-300"></i>
                            <span class="text-xl font-bold text-stone-700">TPE</span>
                        </div>
                        <p class="text-sm text-stone-500">07:00 æŠµé” (è½æ©Ÿ)</p>
                    </div>
                    <!-- å›ç¨‹ -->
                    <div class="relative pl-6 border-l-2 border-stone-100">
                        <div class="absolute -left-[7px] top-0 w-3 h-3 rounded-full bg-stone-200 border-2 border-white ring-1 ring-stone-100"></div>
                        <p class="text-xs text-stone-400 mb-1 font-bold">å›ç¨‹ 11/31 (Day 5)</p>
                        <div class="flex justify-between items-center mb-2 bg-stone-50 p-3 rounded-xl">
                            <span class="text-xl font-bold text-stone-700">TPE</span>
                            <i data-lucide="arrow-right" class="w-4 h-4 text-stone-300"></i>
                            <span class="text-xl font-bold text-stone-700">HKG</span>
                        </div>
                        <p class="text-sm text-stone-500">22:00 å›é¦™æ¸¯</p>
                    </div>
                </div>
            </div>

            <!-- ä½å®¿ -->
            <div class="bg-white rounded-[24px] p-6 zen-shadow">
                <h3 class="text-lg font-bold text-gray-800 mb-5 flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-purple-50 flex items-center justify-center text-purple-500">
                        <i data-lucide="bed-double" class="w-4 h-4"></i>
                    </div>
                    ä½å®¿è³‡è¨Š
                </h3>
                <div class="space-y-4">
                    <div class="bg-stone-50 rounded-2xl p-4">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="text-sm font-bold text-stone-700">æ°‘å®¿ (å¾…å¡«å…¥åç¨±)</p>
                                <p class="text-xs text-stone-400 mt-1">11/27 - 11/31</p>
                            </div>
                            <button class="w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center text-stone-600 tap-effect">
                                <i data-lucide="navigation" class="w-3 h-3"></i>
                            </button>
                        </div>
                        <div class="flex gap-4 mt-3 pt-3 border-t border-stone-200/50">
                            <div>
                                <p class="text-[10px] text-stone-400">Check-in</p>
                                <p class="text-sm font-bold text-stone-700">15:00</p>
                            </div>
                            <div>
                                <p class="text-[10px] text-stone-400">Check-out</p>
                                <p class="text-sm font-bold text-stone-700">11:00</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç·Šæ€¥è¯çµ¡ -->
            <div class="bg-[#FFF5F5] rounded-[24px] p-6 border border-red-100">
                <h3 class="text-lg font-bold text-red-800 mb-4 flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-500">
                        <i data-lucide="phone" class="w-4 h-4"></i>
                    </div>
                    ç·Šæ€¥è¯çµ¡
                </h3>
                <div class="grid grid-cols-2 gap-3">
                    <a href="tel:110" class="bg-white p-4 rounded-2xl text-center tap-effect shadow-sm border border-red-50">
                        <p class="text-xs text-red-400 mb-1 font-bold">å ±æ¡ˆ</p>
                        <p class="text-xl font-black text-red-500 font-mono">110</p>
                    </a>
                    <a href="tel:119" class="bg-white p-4 rounded-2xl text-center tap-effect shadow-sm border border-red-50">
                        <p class="text-xs text-red-400 mb-1 font-bold">æ•‘è­·è»Š</p>
                        <p class="text-xl font-black text-red-500 font-mono">119</p>
                    </a>
                </div>
            </div>
        </div>

        <!-- Tab 3: è¨˜å¸³ -->
        <div id="view-budget" class="view-section hidden pt-4 space-y-4 animate-fade-in">
            <div class="bg-[#2D2A26] rounded-[24px] p-6 text-white zen-shadow relative overflow-hidden">
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-white/5 rounded-full blur-2xl"></div>
                <p class="text-stone-400 text-xs mb-1 font-medium tracking-wide">ç¸½æ”¯å‡º (NTD)</p>
                <h2 class="text-4xl font-bold tracking-wider font-mono" id="total-expense">0</h2>
            </div>
            
            <form onsubmit="addExpense(event)" class="bg-white p-3 rounded-[20px] zen-shadow flex gap-2 items-center">
                <div class="flex-1 bg-stone-50 rounded-2xl px-4 py-2 flex items-center gap-2 border border-transparent focus-within:border-stone-200 transition-colors">
                    <input type="text" id="expense-item" placeholder="é …ç›®" class="flex-1 bg-transparent text-sm focus:outline-none text-stone-700 placeholder-stone-400">
                </div>
                <div class="w-24 bg-stone-50 rounded-2xl px-3 py-2 flex items-center border border-transparent focus-within:border-stone-200 transition-colors">
                    <span class="text-stone-400 text-xs mr-1">$</span>
                    <input type="number" id="expense-amount" placeholder="0" class="w-full bg-transparent text-sm focus:outline-none text-stone-700 font-mono">
                </div>
                <button type="submit" class="bg-[#2D2A26] text-white w-10 h-10 rounded-full flex items-center justify-center tap-effect shadow-lg shadow-stone-200">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
            </form>

            <div id="expense-list" class="space-y-2 pb-10">
                <!-- JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨å°èˆª (æ‡¸æµ®å¼ QQ é¢¨æ ¼) -->
    <div class="fixed bottom-6 left-6 right-6 z-30">
        <nav class="bg-white/90 backdrop-blur-xl rounded-[24px] shadow-[0_8px_32px_rgba(0,0,0,0.08)] p-2 border border-white/50">
            <div class="flex justify-around items-center">
                <button onclick="switchTab('schedule')" id="tab-schedule" class="active-tab flex items-center gap-2 px-4 py-3 tap-effect transition-all duration-300">
                    <i data-lucide="map" class="w-5 h-5"></i>
                    <span class="text-xs font-bold">è¡Œç¨‹</span>
                </button>
                <button onclick="switchTab('info')" id="tab-info" class="inactive-tab flex items-center gap-2 px-4 py-3 tap-effect transition-all duration-300">
                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                    <span class="text-xs font-bold hidden">è³‡è¨Š</span>
                </button>
                <button onclick="switchTab('budget')" id="tab-budget" class="inactive-tab flex items-center gap-2 px-4 py-3 tap-effect transition-all duration-300">
                    <i data-lucide="wallet" class="w-5 h-5"></i>
                    <span class="text-xs font-bold hidden">è¨˜å¸³</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- ç·¨è¼¯ Modal (QQ å½ˆå‡ºè¦–çª—) -->
    <div id="edit-modal" class="fixed inset-0 bg-[#433D3C]/40 z-50 hidden flex items-end sm:items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-[#FEFDF5] w-full max-w-md rounded-[32px] p-6 shadow-2xl modal-enter relative">
            
            <!-- è£é£¾ç”¨çš„å°æ¢æ¢ -->
            <div class="w-12 h-1.5 bg-stone-200 rounded-full mx-auto mb-6"></div>

            <h3 class="text-xl font-bold mb-6 flex justify-between items-center text-[#433D3C]">
                <span id="modal-title">ç·¨è¼¯è¡Œç¨‹</span>
                <button onclick="closeEditModal()" class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-400 hover:text-stone-600 tap-effect"><i data-lucide="x" class="w-5 h-5"></i></button>
            </h3>
            <form id="edit-form" class="space-y-4" onsubmit="saveScheduleItem(event)">
                <input type="hidden" id="edit-day-index">
                <input type="hidden" id="edit-item-index">
                
                <div class="flex gap-3">
                    <div class="w-1/3 space-y-1">
                        <label class="text-xs text-stone-500 font-bold ml-1">æ™‚é–“</label>
                        <input type="time" id="edit-time" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm text-center">
                    </div>
                    <div class="w-2/3 space-y-1">
                        <label class="text-xs text-stone-500 font-bold ml-1">é¡å‹</label>
                        <select id="edit-type" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm appearance-none">
                            <option value="sight">ğŸ“· æ™¯é»</option>
                            <option value="food">ğŸœ ç¾é£Ÿ</option>
                            <option value="shop">ğŸ›ï¸ è³¼ç‰©</option>
                            <option value="transport">ğŸšŒ äº¤é€š</option>
                            <option value="stay">ğŸ›ï¸ ä½å®¿</option>
                        </select>
                    </div>
                </div>

                <div class="space-y-1">
                    <label class="text-xs text-stone-500 font-bold ml-1">æ¨™é¡Œ</label>
                    <input type="text" id="edit-title" required class="w-full bg-white rounded-2xl p-4 text-sm font-bold border border-transparent focus:border-stone-200 focus:outline-none shadow-sm placeholder-stone-300" placeholder="è¡Œç¨‹åç¨±">
                </div>

                <div class="space-y-1">
                    <label class="text-xs text-stone-500 font-bold ml-1">åœ°é»</label>
                    <div class="relative">
                        <i data-lucide="map-pin" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-stone-400"></i>
                        <input type="text" id="edit-location" class="w-full bg-white rounded-2xl p-4 pl-10 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm placeholder-stone-300" placeholder="è¼¸å…¥åœ°é»é—œéµå­—">
                    </div>
                </div>
                
                 <div class="space-y-1">
                    <label class="text-xs text-stone-500 font-bold ml-1">æ¨™ç±¤ (é€—è™Ÿåˆ†éš”)</label>
                    <input type="text" id="edit-tags" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm placeholder-stone-300" placeholder="ä¾‹å¦‚: å¿…åƒ, æ¨è–¦">
                </div>

                <div class="space-y-1">
                    <label class="text-xs text-stone-500 font-bold ml-1">å‚™è¨»</label>
                    <textarea id="edit-note" rows="2" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm placeholder-stone-300 resize-none" placeholder="å‚™è¨»äº‹é …..."></textarea>
                </div>

                <div class="pt-4">
                    <button type="submit" class="w-full py-4 rounded-2xl bg-[#433D3C] text-[#FEFDF5] font-bold shadow-lg shadow-stone-300 tap-effect">å„²å­˜è®Šæ›´</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒè³‡æ–™: é è¨­è³‡æ–™ ---
        const defaultScheduleData = [
            {
                date: "27",
                month: "11",
                day: "Day 1",
                items: [
                    { time: "07:00", title: "æŠµé”è½æ©Ÿ", type: "transport", location: "å°ç£æ¡ƒåœ’åœ‹éš›æ©Ÿå ´", note: "æ­¡è¿ä¾†åˆ°å°ç£ï¼" },
                    { time: "11:00", title: "æ°‘å®¿æ”¾è¡Œæ", type: "stay", location: "å°åŒ—", note: "ç¢ºèª Check-in æ™‚é–“" },
                    { time: "13:00", title: "ç¨‹å‘³çæ„éºµæ»·å‘³", type: "food", location: "ç¨‹å‘³çæ„éºµ", tags: ["å¿…åƒ: æ»·å‘³", "å¿…åƒ: æ„éºµ", "å¿…åƒ: æ»·è‚‰é£¯"] },
                    { time: "15:00", title: "è¥¿é–€ç”º", type: "sight", location: "è¥¿é–€ç”º", tags: ["é€›è¡—", "è¡—é ­å°åƒ"] },
                    { time: "17:00", title: "å¦³æœ‰å’–å•¡ neo cafÃ©", type: "food", location: "å¦³æœ‰å’–å•¡ neo cafe", tags: ["æ¨è–¦: å¤§äººå‘³å¸ƒä¸", "æ¨è–¦: Pizza"] },
                    { time: "19:00", title: "è©¹è¨˜éº»è¾£ç«é‹", type: "food", location: "è©¹è¨˜éº»è¾£ç«é‹ è¥¿é–€å¤§ä¸–ç•Œ", tags: ["å¿…åƒ: é´¨è¡€", "å¿…åƒ: è±†è…", "éœ€è¨‚ä½"] },
                    { time: "21:00", title: "å—æ©Ÿå ´å¤œå¸‚", type: "food", location: "å—æ©Ÿå ´å¤œå¸‚", tags: ["å¿…åƒ: æ°´é¤ƒ", "å¿…åƒ: è‡­è±†è…"] }
                ]
            },
            {
                date: "28",
                month: "11",
                day: "Day 2",
                items: [
                    { time: "09:00", title: "æ—©é¤", type: "food", location: "å°åŒ—", note: "é™„è¿‘æ‰¾é–“å‚³çµ±æ—©é¤åº—å§ (é˜œæ­?)" },
                    { time: "12:00", title: "ä¹ä»½ / ååˆ†", type: "sight", location: "ä¹ä»½è€è¡—", tags: ["å¿…åƒ: èŠ‹åœ“", "æ”¾å¤©ç‡ˆ", "ç€‘å¸ƒ"] },
                    { time: "16:00", title: "çŒ´ç¡è²“æ‘", type: "sight", location: "çŒ´ç¡è²“æ‘", tags: ["è²“å’ª", "ç…¤ç¤¦æ­·å²"] },
                    { time: "19:00", title: "å¤§è‚¡ç†Ÿæˆç‡’è‚‰å°ˆé–€", type: "food", location: "å¤§è‚¡ç†Ÿæˆç‡’è‚‰å°ˆé–€ å°åŒ—å—äº¬åº—", tags: ["å¿…é»: è¶…åšåˆ‡ç‰›èˆŒ", "æ¸…é…’è²©è³£æ©Ÿ"] },
                    { time: "21:00", title: "å¯§å¤å¤œå¸‚", type: "food", location: "å¯§å¤å¤œå¸‚", tags: ["å¿…åƒ: èŠ‹ä¸¸", "å¿…åƒ: èšµä»”ç…"] }
                ]
            },
            {
                date: "29",
                month: "11",
                day: "Day 3",
                items: [
                    { time: "11:00", title: "çŠåœ’æ¹¯åŒ…é¤¨", type: "food", location: "çŠåœ’æ¹¯åŒ…é¤¨", tags: ["å¿…é»: çµ²ç“œè¦ä»æ¹¯åŒ…", "å¿…é»: ç¾…å‹’é®®èšµæ¹¯åŒ…"] },
                    { time: "14:00", title: "ä¸‰å‰µç”Ÿæ´»åœ’å€", type: "sight", location: "ä¸‰å‰µç”Ÿæ´»åœ’å€", tags: ["3C", "å‹•æ¼«"] },
                    { time: "15:00", title: "è¯å±±1914æ–‡å‰µåœ’å€", type: "sight", location: "è¯å±±1914æ–‡åŒ–å‰µæ„ç”¢æ¥­åœ’å€", tags: ["å±•è¦½", "æ–‡é’å°åº—"] },
                    { time: "17:00", title: "å¸•ç±³è²å¯è´è¶é…¥", type: "shop", location: "å¸•ç±³è²å¯", tags: ["ä¼´æ‰‹ç¦®: è´è¶é…¥"] },
                    { time: "19:00", title: "æ‹¾æ¼", type: "food", location: "æ‹¾æ¼ æ°¸åº·åº—", tags: ["æ—¥å¼ç„¡èœå–®", "é«˜CPå€¼"] },
                    { time: "21:00", title: "é¥’æ²³è¡—è§€å…‰å¤œå¸‚", type: "food", location: "é¥’æ²³è¡—è§€å…‰å¤œå¸‚", tags: ["å¿…åƒ: èƒ¡æ¤’é¤…", "å¿…åƒ: è—¥ç‡‰æ’éª¨"] }
                ]
            },
            {
                date: "30",
                month: "11",
                day: "Day 4",
                items: [
                    { time: "12:00", title: "æ¯”æ¼¾å»£å ´", type: "shop", location: "æ¯”æ¼¾å»£å ´", tags: ["é€›è¡—", "ç¾é£Ÿè¡—"] },
                    { time: "14:00", title: "æ¨‚è¯å•†åœˆ", type: "sight", location: "æ¨‚è¯å¤œå¸‚", tags: ["é€›è¡—"] },
                    { time: "16:00", title: "Chii! Gelato", type: "food", location: "Chii! Gelato", tags: ["æ¨è–¦: é–‹å¿ƒæœä¸‰é‡å¥", "ç¾©å¼å†°æ·‡æ·‹"] },
                    { time: "19:00", title: "é‡‘æœˆ-æ—¥æœ¬é‹æ–™ç†", type: "food", location: "é‡‘æœˆæ—¥æœ¬é‹æ–™ç†æ“”ç•¶", tags: ["å¿…é»: æ¸…é…’æ¹¯åº•", "A5å’Œç‰›", "å’–å“©å¥¶æ²¹å·"] },
                    { time: "21:00", title: "è‡¨æ±Ÿè¡—(é€šåŒ–)å¤œå¸‚", type: "food", location: "è‡¨æ±Ÿè¡—è§€å…‰å¤œå¸‚", tags: ["å¿…åƒ: å†°ç«æ¹¯åœ“", "å¿…åƒ: ç´…èŠ±é¦™è…¸"] }
                ]
            },
            {
                date: "31",
                month: "11",
                day: "Day 5",
                items: [
                    { time: "12:00", title: "Check Out", type: "stay", location: "å°åŒ—", note: "è¡Œæå¯„æ”¾?" },
                    { time: "14:00", title: "è¯æ³°åå“åŸ", type: "shop", location: "GLORIA OUTLETS è¯æ³°åå“åŸ", tags: ["Outlet", "æœ€å¾Œè¡åˆº"] },
                    { time: "19:00", title: "æ™šé¤", type: "food", location: "æ¡ƒåœ’é«˜éµç«™", note: "æ©Ÿå ´æ·é‹æ²¿ç·š" },
                    { time: "22:00", title: "å›é¦™æ¸¯", type: "transport", location: "å°ç£æ¡ƒåœ’åœ‹éš›æ©Ÿå ´", note: "å¹³å®‰å›å®¶" }
                ]
            }
        ];

        // --- åˆå§‹åŒ– & é‚è¼¯ ---
        let scheduleData = [];
        let currentDayIndex = 0;
        let expenses = JSON.parse(localStorage.getItem('tw_trip_expenses') || '[]');

        function init() {
            // è¼‰å…¥è¡Œç¨‹ (LocalStorage æˆ– é è¨­)
            const savedSchedule = localStorage.getItem('tw_trip_schedule');
            if (savedSchedule) {
                scheduleData = JSON.parse(savedSchedule);
            } else {
                scheduleData = JSON.parse(JSON.stringify(defaultScheduleData)); // Deep copy
                saveSchedule();
            }

            lucide.createIcons();
            renderDaySelector();
            renderTimeline(0);
            renderExpenses();
        }

        function saveSchedule() {
            localStorage.setItem('tw_trip_schedule', JSON.stringify(scheduleData));
        }

        function resetToDefault() {
            if(confirm("ç¢ºå®šè¦æ¢å¾©æˆé è¨­è¡Œç¨‹å—ï¼Ÿæ‚¨æ‰€æœ‰çš„ä¿®æ”¹å°‡æœƒæ¶ˆå¤±ã€‚")) {
                scheduleData = JSON.parse(JSON.stringify(defaultScheduleData));
                saveSchedule();
                renderTimeline(currentDayIndex);
                // ä¸ç”¨ alertï¼Œç›´æ¥æ›´æ–°ç•«é¢æ›´é †æš¢
            }
        }

        // æ¸²æŸ“æ—¥æœŸé¸å–®
        function renderDaySelector() {
            const container = document.getElementById('day-selector');
            container.innerHTML = scheduleData.map((day, index) => `
                <button onclick="selectDay(${index})" 
                    class="day-btn flex-shrink-0 flex flex-col items-center justify-center w-[60px] h-[72px] rounded-2xl transition-all border border-transparent tap-effect ${index === 0 ? 'bg-[#433D3C] text-[#FEFDF5] shadow-lg shadow-stone-200' : 'bg-white text-stone-300'}"
                    id="day-btn-${index}">
                    <span class="text-[10px] font-bold tracking-wide opacity-80">${day.day}</span>
                    <span class="text-xl font-bold font-mono mt-1">${day.date}</span>
                </button>
            `).join('');
        }

        // åˆ‡æ›æ—¥æœŸ
        function selectDay(index) {
            currentDayIndex = index;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.day-btn').forEach((btn, idx) => {
                if (idx === index) {
                    btn.className = "day-btn flex-shrink-0 flex flex-col items-center justify-center w-[60px] h-[72px] rounded-2xl transition-all border border-transparent tap-effect bg-[#433D3C] text-[#FEFDF5] shadow-lg shadow-stone-200 transform scale-105";
                } else {
                    btn.className = "day-btn flex-shrink-0 flex flex-col items-center justify-center w-[60px] h-[72px] rounded-2xl transition-all border border-transparent tap-effect bg-white text-stone-300";
                }
            });

            renderTimeline(index);
        }

        // æ¸²æŸ“è¡Œç¨‹å¡ç‰‡
        function renderTimeline(dayIndex) {
            const container = document.getElementById('timeline-container');
            const data = scheduleData[dayIndex];
            
            // å¤©æ°£
            const weathers = ['cloud-sun', 'sun', 'cloud-rain'];
            const randomWeather = weathers[Math.floor(Math.random() * weathers.length)];

            let html = `
                <div class="flex items-center justify-between px-2 mb-4 mt-2 animate-fade-in">
                    <p class="text-sm text-stone-400 font-bold">11æœˆ${data.date}æ—¥ / ${data.day}</p>
                    <i data-lucide="${randomWeather}" class="w-4 h-4 text-stone-400"></i>
                </div>
            `;

            data.items.sort((a, b) => a.time.localeCompare(b.time));

            html += data.items.map((item, itemIndex) => {
                let icon = 'map-pin';
                let iconColor = 'text-stone-500';
                let iconBg = 'bg-stone-100';
                
                if(item.type === 'food') { icon = 'utensils'; iconColor='text-orange-500'; iconBg='bg-orange-50'; }
                if(item.type === 'transport') { icon = 'bus'; iconColor='text-blue-500'; iconBg='bg-blue-50'; }
                if(item.type === 'shop') { icon = 'shopping-bag'; iconColor='text-pink-500'; iconBg='bg-pink-50'; }
                if(item.type === 'stay') { icon = 'bed'; iconColor='text-purple-500'; iconBg='bg-purple-50'; }

                let tagsHtml = '';
                if(item.tags && item.tags.length > 0) {
                    tagsHtml = `<div class="flex flex-wrap gap-2 mt-3">` + 
                    item.tags.map(tag => {
                        let className = 'bg-stone-50 text-stone-500'; // é è¨­
                        if(tag.includes('å¿…åƒ') || tag.includes('å¿…é»')) className = 'tag-must-eat';
                        return `<span class="text-[10px] px-2.5 py-1 rounded-lg font-bold ${className}">${tag}</span>`;
                    }).join('') + `</div>`;
                }

                return `
                <div class="bg-white rounded-[24px] p-5 zen-shadow relative overflow-hidden animate-slide-up group mb-4 border border-white">
                    <div class="flex gap-4">
                        <div class="flex flex-col items-center pt-1 w-12 flex-shrink-0">
                            <span class="text-xs font-bold text-stone-400 mb-2 font-mono">${item.time}</span>
                            <div class="w-10 h-10 rounded-full ${iconBg} flex items-center justify-center ${iconColor}">
                                <i data-lucide="${icon}" class="w-5 h-5"></i>
                            </div>
                            <div class="h-full w-0.5 bg-stone-100 my-2 rounded-full"></div>
                        </div>
                        <div class="flex-1 pb-2 min-w-0">
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-[#433D3C] text-lg leading-tight truncate mr-2">${item.title}</h3>
                                <div class="flex gap-1 flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="openEditModal(${dayIndex}, ${itemIndex})" class="w-8 h-8 rounded-full bg-stone-50 flex items-center justify-center text-stone-400 hover:text-stone-600 tap-effect">
                                        <i data-lucide="pencil" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="deleteScheduleItem(${dayIndex}, ${itemIndex})" class="w-8 h-8 rounded-full bg-red-50 flex items-center justify-center text-red-400 hover:text-red-600 tap-effect">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-2 mt-2 mb-3">
                                <button onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}')" 
                                    class="text-xs flex items-center gap-1.5 bg-stone-50 hover:bg-stone-100 text-stone-500 px-3 py-1.5 rounded-xl transition-colors tap-effect max-w-full truncate font-medium">
                                    <i data-lucide="navigation" class="w-3 h-3 flex-shrink-0"></i> 
                                    <span class="truncate">${item.location || 'è¨­å®šåœ°é»'}</span>
                                </button>
                            </div>
                            
                            ${item.note ? `<p class="text-xs text-stone-400 mt-1 line-clamp-2 leading-relaxed bg-[#FEFDF5] p-2 rounded-lg">${item.note}</p>` : ''}
                            ${tagsHtml}
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            // æ–°å¢æŒ‰éˆ• (QQ é¢¨æ ¼)
            html += `
                <button onclick="openAddModal(${dayIndex})" class="w-full py-4 rounded-[24px] border-2 border-dashed border-stone-200 text-stone-300 hover:border-stone-300 hover:text-stone-500 transition-all flex items-center justify-center gap-2 tap-effect mt-2 bg-white/50">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    <span class="font-bold">æ–°å¢è¡Œç¨‹</span>
                </button>
            `;

            container.innerHTML = html;
            lucide.createIcons();
        }

        // --- ç·¨è¼¯/æ–°å¢åŠŸèƒ½ ---
        const editModal = document.getElementById('edit-modal');
        const modalTitle = document.getElementById('modal-title');
        
        function openAddModal(dayIndex) {
            document.getElementById('edit-day-index').value = dayIndex;
            document.getElementById('edit-item-index').value = -1;
            modalTitle.innerText = "æ–°å¢è¡Œç¨‹";
            
            // é è¨­å€¼
            document.getElementById('edit-time').value = "12:00";
            document.getElementById('edit-type').value = "sight";
            document.getElementById('edit-title').value = "";
            document.getElementById('edit-location').value = "";
            document.getElementById('edit-tags').value = "";
            document.getElementById('edit-note').value = "";
            
            editModal.classList.remove('hidden');
        }

        function openEditModal(dayIndex, itemIndex) {
            const item = scheduleData[dayIndex].items[itemIndex];
            document.getElementById('edit-day-index').value = dayIndex;
            document.getElementById('edit-item-index').value = itemIndex;
            modalTitle.innerText = "ç·¨è¼¯è¡Œç¨‹";
            
            document.getElementById('edit-time').value = item.time;
            document.getElementById('edit-type').value = item.type;
            document.getElementById('edit-title').value = item.title;
            document.getElementById('edit-location').value = item.location;
            document.getElementById('edit-tags').value = item.tags ? item.tags.join(', ') : '';
            document.getElementById('edit-note').value = item.note || '';
            
            editModal.classList.remove('hidden');
        }

        function closeEditModal() {
            editModal.classList.add('hidden');
        }

        function saveScheduleItem(e) {
            e.preventDefault();
            const dayIndex = parseInt(document.getElementById('edit-day-index').value);
            const itemIndex = parseInt(document.getElementById('edit-item-index').value);
            
            const newItem = {
                time: document.getElementById('edit-time').value,
                type: document.getElementById('edit-type').value,
                title: document.getElementById('edit-title').value,
                location: document.getElementById('edit-location').value,
                tags: document.getElementById('edit-tags').value.split(',').map(t => t.trim()).filter(t => t),
                note: document.getElementById('edit-note').value
            };

            if (itemIndex === -1) {
                scheduleData[dayIndex].items.push(newItem);
            } else {
                scheduleData[dayIndex].items[itemIndex] = newItem;
            }

            saveSchedule();
            renderTimeline(dayIndex);
            closeEditModal();
        }

        function deleteScheduleItem(dayIndex, itemIndex) {
            if(confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿ")) {
                scheduleData[dayIndex].items.splice(itemIndex, 1);
                saveSchedule();
                renderTimeline(dayIndex);
            }
        }

        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) closeEditModal();
        });


        // --- è¨˜å¸³åŠŸèƒ½ ---
        function renderExpenses() {
            const list = document.getElementById('expense-list');
            const totalEl = document.getElementById('total-expense');
            
            let total = 0;
            list.innerHTML = expenses.map((ex, i) => {
                total += parseInt(ex.amount);
                return `
                    <div class="flex justify-between items-center bg-white p-4 rounded-[20px] shadow-sm mb-2 border border-stone-100">
                        <span class="text-sm font-bold text-stone-600">${ex.item}</span>
                        <div class="flex items-center gap-3">
                            <span class="font-mono font-bold text-stone-800">NT$ ${ex.amount}</span>
                            <button onclick="deleteExpense(${i})" class="w-6 h-6 rounded-full bg-stone-50 flex items-center justify-center text-stone-300 hover:text-red-400 tap-effect">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).reverse().join('');
            
            totalEl.innerText = total.toLocaleString();
            localStorage.setItem('tw_trip_expenses', JSON.stringify(expenses));
            lucide.createIcons();
        }

        function addExpense(e) {
            e.preventDefault();
            const item = document.getElementById('expense-item').value;
            const amount = document.getElementById('expense-amount').value;
            if(!item || !amount) return;

            expenses.push({ item, amount });
            document.getElementById('expense-item').value = '';
            document.getElementById('expense-amount').value = '';
            renderExpenses();
        }

        function deleteExpense(index) {
            if(confirm('ç¢ºå®šåˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ')) {
                const realIndex = expenses.length - 1 - index;
                expenses.splice(realIndex, 1);
                renderExpenses();
            }
        }

        // --- é é¢åˆ‡æ› ---
        function switchTab(tabId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            
            ['schedule', 'info', 'budget'].forEach(id => {
                const btn = document.getElementById(`tab-${id}`);
                const span = btn.querySelector('span');
                if(id === tabId) {
                    btn.className = "active-tab flex items-center gap-2 px-5 py-3 tap-effect transition-all duration-300";
                    span.classList.remove('hidden');
                } else {
                    btn.className = "inactive-tab flex items-center gap-2 px-3 py-3 tap-effect transition-all duration-300";
                    span.classList.add('hidden');
                }
            });
        }

        init();

        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
            @keyframes slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
            .animate-fade-in { animation: fade-in 0.4s ease-out; }
            .animate-slide-up { animation: slide-up 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        `;
        document.head.appendChild(style);

    </script>
</body>
</html>
