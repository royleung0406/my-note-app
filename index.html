<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>旅遊小幫手 v3.2 (Share)</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FEFDF5">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght%40400;500;700&family=Zen+Maru+Gothic:wght%40400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #FEFDF5;
            --text-main: #433D3C;
            --text-sub: #9CA3AF;
            --accent: #D4C4B7;
            --highlight: #F43F5E;
        }

        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            -webkit-user-select: none;
            user-select: none;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .zen-shadow {
            box-shadow: 0 8px 24px rgba(149, 157, 165, 0.08);
            border: 1px solid rgba(255,255,255,0.8);
        }

        .tag-must-eat { background: #FFE4E6; color: #BE123C; }
        .tag-nav { background: #F3F4F6; color: #374151; }
        .tag-tips { background: #E0F2FE; color: #0369A1; }

        .active-tab {
            color: #57534E;
            font-weight: 700;
            background-color: #F5F5F4;
            border-radius: 16px;
        }
        .inactive-tab { color: #A8A29E; }

        .tap-effect:active { opacity: 0.8; transform: scale(0.98); transition: transform 0.1s; }
        
        @keyframes slide-up-spring {
            0% { transform: translateY(100%); opacity: 0; }
            60% { transform: translateY(-10px); opacity: 1; }
            100% { transform: translateY(0); }
        }
        .modal-enter { animation: slide-up-spring 0.4s ease-out forwards; }
        
        button, .card-clickable { touch-action: manipulation; cursor: pointer; }

        .share-btn-selected { background-color: #433D3C; color: #FFFFFF; border-color: #433D3C; }
        .share-btn-unselected { background-color: #F5F5F4; color: #A8A29E; border-color: transparent; }
        .filter-btn-active { background-color: rgba(255,255,255,0.2); color: white; font-weight: bold; border: 1px solid rgba(255,255,255,0.4); }
        .filter-btn-inactive { color: rgba(255,255,255,0.6); }
        .weather-scroll-item { min-width: 60px; }
        
        /* 同步狀態燈號 */
        #sync-indicator {
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(67, 61, 60, 0.9); color: white;
            padding: 6px 16px; border-radius: 20px; font-size: 11px; font-weight: bold;
            z-index: 9999; backdrop-filter: blur(4px);
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0; pointer-events: none;
        }
        #sync-indicator.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        #sync-indicator.error { background: rgba(239, 68, 68, 0.95); }

        /* Toast Message */
        #toast-message {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 50px;
            font-size: 14px; opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 10000;
        }
        #toast-message.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* View Switching */
        .page-view {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 0;
            left: 0;
            background-color: var(--bg-color);
            transition: transform 0.3s ease-in-out, opacity 0.3s;
        }
        .page-hidden {
            transform: translateX(100%);
            opacity: 0;
            pointer-events: none;
            z-index: -1;
        }
        .page-active {
            transform: translateX(0);
            opacity: 1;
            z-index: 10;
        }
        
        /* Trip Card */
        .trip-card-bg-0 { background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%); }
        .trip-card-bg-1 { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); }
        .trip-card-bg-2 { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); }
        .trip-card-bg-3 { background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); }
    </style>
</head>
<body class="h-screen overflow-hidden bg-[#FEFDF5] relative">

    <!-- 同步提示 -->
    <div id="sync-indicator">
        <i id="sync-icon" data-lucide="refresh-cw" class="w-3 h-3 animate-spin"></i>
        <span id="sync-msg">同步中...</span>
    </div>

    <!-- Toast -->
    <div id="toast-message"></div>

    <!-- VIEW 1: TRIP LIST (My Trips) -->
    <div id="view-trip-list" class="page-view z-20">
        <header class="pt-safe-top px-6 py-6 pb-2 flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold text-[#433D3C] tracking-tight">My Trips ✈️</h1>
                <p class="text-stone-400 text-sm font-bold mt-1">選擇您的旅程或建立新計畫</p>
            </div>
            
            <!-- User Profile / Login Button -->
            <div id="user-auth-area">
                <button onclick="loginWithGoogle()" class="flex flex-col items-center gap-1 group">
                    <div class="w-10 h-10 rounded-full bg-white border border-stone-200 shadow-sm flex items-center justify-center overflow-hidden">
                        <i data-lucide="user" class="w-5 h-5 text-stone-400"></i>
                    </div>
                    <span class="text-[10px] font-bold text-stone-400 group-hover:text-[#433D3C]">登入備份</span>
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar p-6 space-y-4" id="trip-list-container">
            <!-- JS Generated Cards -->
        </main>

        <!-- Floating Add Button -->
        <div class="absolute bottom-8 right-6">
            <button onclick="openAddTripModal()" class="w-14 h-14 bg-[#433D3C] rounded-full text-white shadow-xl flex items-center justify-center tap-effect hover:scale-105 transition-transform">
                <i data-lucide="plus" class="w-7 h-7"></i>
            </button>
        </div>
    </div>

    <!-- VIEW 2: TRIP DETAIL (The Original App) -->
    <div id="view-trip-detail" class="page-view page-hidden">
        <!-- 頂部資訊 (Modified with Back Button) -->
        <header class="bg-[#FEFDF5]/90 backdrop-blur-sm pt-safe-top sticky top-0 z-20 px-4 py-3 flex justify-between items-center border-b border-stone-100/50">
            <div class="flex items-center gap-3">
                <button onclick="backToTripList()" class="w-10 h-10 rounded-full bg-white border border-stone-100 flex items-center justify-center text-stone-500 tap-effect shadow-sm">
                    <i data-lucide="chevron-left" class="w-6 h-6"></i>
                </button>
                <div>
                    <p class="text-[10px] text-gray-400 tracking-widest mb-0.5 font-bold uppercase" id="header-subtitle">TRIP</p>
                    <div class="flex items-center gap-2">
                        <h1 class="text-lg font-bold tracking-wide text-[#433D3C] truncate max-w-[160px]" id="header-title">Loading...</h1>
                        <button onclick="openDateModal()" class="text-stone-400 hover:text-stone-600 tap-effect p-1">
                            <i data-lucide="settings-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="text-right flex items-center gap-3">
                 <!-- Share / Save Button -->
                <div id="share-save-area">
                    <button onclick="openShareModal()" id="share-button" class="bg-white hover:bg-stone-50 text-stone-600 px-3 py-1.5 rounded-xl text-xs font-bold shadow-sm border border-stone-100 tap-effect hidden">
                        <i data-lucide="share-2" class="w-4 h-4 mr-1 inline-block"></i> 分享
                    </button>
                    <button onclick="forkSharedTrip()" id="save-button" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-xl text-xs font-bold shadow-sm border border-blue-700 tap-effect hidden">
                        <i data-lucide="bookmark" class="w-4 h-4 mr-1 inline-block"></i> 儲存到我的計畫
                    </button>
                </div>

                <div class="flex flex-col items-end gap-1">
                    <div class="flex items-center gap-1 text-gray-600 bg-white px-2 py-1 rounded-full shadow-sm border border-stone-100">
                        <i data-lucide="cloud" class="w-3 h-3 text-stone-400"></i>
                        <span class="text-xs font-bold">22°</span>
                    </div>
                    <!-- 連線狀態燈 -->
                    <div class="flex items-center gap-1 mt-1">
                        <div id="status-dot" class="w-1.5 h-1.5 rounded-full bg-gray-300 transition-colors"></div>
                        <span id="status-text" class="text-[9px] text-stone-400">Connecting...</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- 主要內容區 -->
        <main id="main-content" class="flex-1 overflow-y-auto no-scrollbar pb-28 relative px-4">
            
            <!-- Tab 1: 行程 -->
            <div id="view-schedule" class="view-section pt-2 space-y-6 animate-fade-in">
                
                <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2 px-1" id="day-selector"></div>
                
                <div class="bg-white rounded-[24px] p-4 zen-shadow border border-white overflow-hidden">
                    <div class="flex items-center gap-2 mb-3 px-1">
                        <i data-lucide="cloud-sun" class="w-4 h-4 text-blue-400"></i>
                        <span class="text-xs font-bold text-stone-500">每小時天氣預報</span>
                    </div>
                    <div class="flex overflow-x-auto no-scrollbar gap-2" id="hourly-weather-container">
                        <!-- JS 生成 -->
                    </div>
                </div>

                <div id="timeline-container" class="space-y-4 pb-10"></div>
            </div>

            <!-- Tab 2: 資訊 -->
            <div id="view-info" class="view-section hidden pt-4 space-y-6 animate-fade-in">
                <div class="bg-white rounded-[24px] p-6 zen-shadow">
                    <h3 class="text-lg font-bold text-gray-800 mb-5 flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-500"><i data-lucide="plane-takeoff" class="w-4 h-4"></i></div>
                        航班資訊
                    </h3>
                    <div class="space-y-6">
                        <div class="relative pl-6 border-l-2 border-stone-100">
                            <div class="absolute -left-[7px] top-0 w-3 h-3 rounded-full bg-stone-200 border-2 border-white ring-1 ring-stone-100"></div>
                            <p class="text-xs text-stone-400 mb-1 font-bold">去程</p>
                            <div class="flex justify-between items-center mb-2 bg-stone-50 p-3 rounded-xl">
                                <span class="text-xl font-bold text-stone-700">HKG</span>
                                <i data-lucide="arrow-right" class="w-4 h-4 text-stone-300"></i>
                                <span class="text-xl font-bold text-stone-700">TPE</span>
                            </div>
                            <p class="text-sm text-stone-500">08:00 抵達 (落機)</p>
                        </div>
                        <div class="relative pl-6 border-l-2 border-stone-100">
                            <div class="absolute -left-[7px] top-0 w-3 h-3 rounded-full bg-stone-200 border-2 border-white ring-1 ring-stone-100"></div>
                            <p class="text-xs text-stone-400 mb-1 font-bold">回程</p>
                            <div class="flex justify-between items-center mb-2 bg-stone-50 p-3 rounded-xl">
                                <span class="text-xl font-bold text-stone-700">TPE</span>
                                <i data-lucide="arrow-right" class="w-4 h-4 text-stone-300"></i>
                                <span class="text-xl font-bold text-stone-700">HKG</span>
                            </div>
                            <p class="text-sm text-stone-500">22:00 回香港</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-[24px] p-6 zen-shadow mt-4">
                     <h3 class="text-lg font-bold text-gray-800 mb-5 flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-orange-50 flex items-center justify-center text-orange-500"><i data-lucide="alert-circle" class="w-4 h-4"></i></div>
                        行前準備
                     </h3>
                    <ul class="space-y-3">
                         <li class="flex items-center gap-3 bg-stone-50 p-3 rounded-xl">
                             <input type="checkbox" class="w-5 h-5 rounded-full accent-[#433D3C]">
                             <span class="text-sm text-stone-600 font-bold">線上入台證申請</span>
                           </li>
                         <li class="flex items-center gap-3 bg-stone-50 p-3 rounded-xl">
                             <input type="checkbox" class="w-5 h-5 rounded-full accent-[#433D3C]">
                             <span class="text-sm text-stone-600 font-bold">購買旅遊保險</span>
                           </li>
                    </ul>
                </div>
            </div>

            <!-- Tab 3: 記帳 -->
            <div id="view-budget" class="view-section hidden pt-4 space-y-6 animate-fade-in">
                
                <div class="bg-[#2D2A26] rounded-[24px] p-6 text-white zen-shadow relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 w-24 h-24 bg-white/5 rounded-full blur-2xl"></div>
                    
                    <div class="flex justify-between items-start mb-4">
                        <p class="text-stone-400 text-xs font-medium tracking-wide uppercase" id="budget-title">總消費 (ALL)</p>
                        <button onclick="promptAddCompanion()" class="bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-full text-[10px] flex items-center gap-1 backdrop-blur-sm transition-colors">
                            <i data-lucide="user-plus" class="w-3 h-3"></i> 管理旅伴
                        </button>
                    </div>

                    <div class="mb-6">
                        <div class="flex items-baseline gap-2">
                            <span class="text-lg text-stone-400 font-bold">NT$</span>
                            <h2 class="text-5xl font-bold tracking-tighter font-mono" id="total-expense-twd">0</h2>
                        </div>
                        <p class="text-stone-400 text-sm mt-1 font-medium flex items-center gap-1">
                            <span class="bg-white/10 px-2 py-0.5 rounded text-xs">約 HK$ <span id="total-expense-hkd" class="font-mono">0</span></span>
                        </p>
                    </div>

                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1" id="member-filter-container"></div>
                </div>
                
                <div class="bg-white p-5 rounded-[24px] zen-shadow space-y-5 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-stone-200 to-white"></div>
                    <h3 class="text-stone-800 font-bold text-lg flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-600"><i data-lucide="receipt" class="w-4 h-4"></i></div>
                        記一筆
                    </h3>

                    <div class="bg-stone-50 rounded-2xl px-5 py-4 flex flex-col border border-transparent focus-within:border-[#433D3C] transition-all shadow-inner relative group">
                        <label class="text-[10px] text-stone-400 font-bold mb-1 uppercase">金額 (TWD)</label>
                        <div class="flex items-baseline">
                            <span class="text-stone-400 text-2xl mr-2 font-bold">$</span>
                            <input type="number" id="expense-amount" placeholder="0" class="flex-1 bg-transparent text-4xl focus:outline-none text-stone-800 font-mono font-bold placeholder-stone-200">
                        </div>
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 text-stone-300 font-mono text-sm pointer-events-none group-focus-within:text-stone-400 transition-colors">
                            ≈ HK$ <span id="input-hkd-preview">0</span>
                        </div>
                    </div>

                    <div class="bg-stone-50 rounded-2xl px-4 py-3 flex items-center gap-2 border border-transparent focus-within:border-stone-200 transition-colors">
                        <input type="text" id="expense-item" placeholder="消費項目 (例如: 晚餐、車費)" class="flex-1 bg-transparent text-base focus:outline-none text-stone-700 placeholder-stone-400 font-medium">
                    </div>

                    <div class="grid grid-cols-1 gap-3 bg-stone-50 p-4 rounded-2xl">
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-stone-500 font-bold flex items-center gap-1"><i data-lucide="wallet" class="w-3 h-3"></i> 誰先付錢？</span>
                            <select id="expense-payer" class="bg-white text-stone-700 text-sm font-bold px-3 py-1.5 rounded-lg border-none focus:ring-0 outline-none cursor-pointer shadow-sm"></select>
                        </div>
                        <div class="h-px bg-stone-200/50 w-full"></div>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-stone-500 font-bold flex items-center gap-1"><i data-lucide="users" class="w-3 h-3"></i> 誰要分攤？</span>
                                <button type="button" onclick="selectAllShares()" class="text-[10px] bg-blue-50 text-blue-500 font-bold px-2 py-1 rounded hover:bg-blue-100 transition-colors">全選</button>
                            </div>
                            <div id="share-buttons-container" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>

                    <button onclick="addExpense()" class="w-full bg-[#433D3C] text-white py-4 rounded-2xl flex items-center justify-center gap-2 tap-effect shadow-lg shadow-stone-200 font-bold text-lg active:scale-[0.98] transition-transform">
                        <i data-lucide="plus" class="w-5 h-5"></i> 加入記帳
                    </button>
                </div>

                <div class="flex justify-between items-end px-2">
                    <h4 class="text-stone-400 text-xs font-bold tracking-widest uppercase">交易紀錄 (HISTORY)</h4>
                    <span class="text-[10px] text-stone-300" id="list-filter-status">顯示全部</span>
                </div>

                <div id="expense-list" class="space-y-3 pb-10 min-h-[100px]"></div>
            </div>
        </main>

        <!-- 底部導航 -->
        <div class="fixed bottom-6 left-6 right-6 z-30">
            <nav class="bg-white/90 backdrop-blur-xl rounded-[24px] shadow-[0_8px_32px_rgba(0,0,0,0.08)] p-2 border border-white/50">
                <div class="flex justify-around items-center">
                    <button onclick="switchTab('schedule')" id="tab-schedule" class="active-tab flex items-center gap-2 px-4 py-3 tap-effect transition-all duration-300">
                        <i data-lucide="map" class="w-5 h-5"></i><span class="text-xs font-bold">行程</span>
                    </button>
                    <button onclick="switchTab('info')" id="tab-info" class="inactive-tab flex items-center gap-2 px-4 py-3 tap-effect transition-all duration-300">
                        <i data-lucide="sparkles" class="w-5 h-5"></i><span class="text-xs font-bold hidden">資訊</span>
                    </button>
                    <button onclick="switchTab('budget')" id="tab-budget" class="inactive-tab flex items-center gap-2 px-4 py-3 tap-effect transition-all duration-300">
                        <i data-lucide="wallet" class="w-5 h-5"></i><span class="text-xs font-bold hidden">記帳</span>
                    </button>
                </div>
            </nav>
        </div>
    </div>

    <!-- Modals (詳細, 編輯, 行程設定, 新增行程) -->
    
    <!-- ADD TRIP MODAL -->
    <div id="add-trip-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-[#FEFDF5] w-full max-w-sm rounded-[32px] p-6 shadow-2xl modal-enter relative">
            <h3 class="text-xl font-bold mb-6 text-[#433D3C]">建立新旅程</h3>
            <div class="space-y-4">
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">旅程名稱</label><input type="text" id="new-trip-title" class="w-full bg-white rounded-2xl p-4 text-base font-bold border border-transparent focus:border-stone-200 focus:outline-none shadow-sm" placeholder="例如: 東京五日遊"></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">出發日期</label><input type="date" id="new-trip-date" class="w-full bg-white rounded-2xl p-4 text-base font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm"></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">天數</label><input type="number" id="new-trip-days" value="3" min="1" max="30" class="w-full bg-white rounded-2xl p-4 text-base font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm"></div>
                
                <div class="pt-2 flex items-center gap-2">
                    <input type="checkbox" id="use-template" class="w-4 h-4 rounded text-[#433D3C] focus:ring-[#433D3C]">
                    <label for="use-template" class="text-sm text-stone-600">使用範本 (台灣五日遊)</label>
                </div>
            </div>
            <div class="flex gap-3 mt-6"><button onclick="closeAddTripModal()" class="flex-1 py-3 rounded-2xl bg-stone-100 text-stone-500 font-bold tap-effect">取消</button><button onclick="confirmAddTrip()" class="flex-1 py-3 rounded-2xl bg-[#433D3C] text-white font-bold tap-effect shadow-lg shadow-stone-300">建立</button></div>
        </div>
    </div>

    <!-- SHARE MODAL -->
    <div id="share-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-[#FEFDF5] w-full max-w-sm rounded-[32px] p-6 shadow-2xl modal-enter relative">
            <h3 class="text-xl font-bold mb-6 text-[#433D3C] text-center">分享行程 (協作模式)</h3>
            <p class="text-sm text-stone-600 mb-4 text-center">一旦發布，所有擁有此連結的人都可以即時編輯和查看此行程！</p>
            <div id="share-content">
                <!-- Content generated by JS -->
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeShareModal()" class="flex-1 py-3 rounded-2xl bg-stone-100 text-stone-500 font-bold tap-effect">關閉</button>
            </div>
        </div>
        <!-- Custom Confirm Modal HTML -->
    </div>

    <!-- EXISTING MODALS -->
    <div id="detail-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 hidden flex items-end sm:items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-[#FEFDF5] w-full max-w-md rounded-[32px] p-6 shadow-2xl modal-enter relative max-h-[85vh] overflow-y-auto no-scrollbar">
            <div class="w-12 h-1.5 bg-stone-200 rounded-full mx-auto mb-6"></div>
            <div id="detail-content" class="space-y-5"></div>
            <button onclick="closeDetailModal()" class="absolute top-6 right-6 w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-400 hover:text-stone-600 tap-effect"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 hidden flex items-end sm:items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-[#FEFDF5] w-full max-w-md rounded-[32px] p-6 shadow-2xl modal-enter relative max-h-[90vh] overflow-y-auto no-scrollbar">
            <h3 class="text-xl font-bold mb-6 flex justify-between items-center text-[#433D3C]">
                <span id="modal-title">編輯行程</span>
                <button onclick="closeEditModal()" class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-400 hover:text-stone-600 tap-effect"><i data-lucide="x" class="w-5 h-5"></i></button>
            </h3>
            <form id="edit-form" class="space-y-4" onsubmit="saveScheduleItem(event)">
                <input type="hidden" id="edit-day-index"><input type="hidden" id="edit-item-index">
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">開始時間</label><input type="time" id="edit-time" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm text-center"></div>
                    <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">結束時間 (選填)</label><input type="time" id="edit-end-time" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm text-center text-stone-500 placeholder-stone-300"></div>
                </div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">類型</label><select id="edit-type" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm appearance-none"><option value="sight">📷 景點</option><option value="food">🍜 美食</option><option value="shop">🛍️ 購物</option><option value="transport">🚌 交通</option><option value="stay">🛏️ 住宿</option></select></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">標題</label><input type="text" id="edit-title" required class="w-full bg-white rounded-2xl p-4 text-sm font-bold border border-transparent focus:border-stone-200 focus:outline-none shadow-sm" placeholder="行程名稱"></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">地點</label><div class="relative"><i data-lucide="map-pin" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-stone-400"></i><input type="text" id="edit-location" class="w-full bg-white rounded-2xl p-4 pl-10 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm" placeholder="輸入地點關鍵字"></div></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">標籤 (逗號分隔)</label><input type="text" id="edit-tags" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm" placeholder="例如: 必吃, 推薦"></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">簡短備註</label><input type="text" id="edit-note" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm" placeholder="顯示在卡片上的短句"></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">詳細介紹 (同步顯示)</label><textarea id="edit-description" rows="4" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm resize-none" placeholder="這裡輸入的內容會同步到詳細頁面..."></textarea></div>
                <div class="pt-4"><button type="submit" class="w-full py-4 rounded-2xl bg-[#433D3C] text-[#FEFDF5] font-bold shadow-lg shadow-stone-300 tap-effect">儲存變更</button></div>
            </form>
        </div>
    </div>

    <div id="date-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-[#FEFDF5] w-full max-w-sm rounded-[32px] p-6 shadow-2xl modal-enter relative">
            <h3 class="text-lg font-bold mb-6 text-[#433D3C] text-center">行程設定</h3>
            <div class="space-y-4">
                <div><label class="text-xs text-stone-500 font-bold ml-1 block mb-2">出發日期</label><input type="date" id="start-date-input" class="w-full bg-white rounded-2xl p-4 text-lg font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm text-center text-[#433D3C]"></div>
                <div><label class="text-xs text-stone-500 font-bold ml-1 block mb-2">旅行總天數</label><div class="flex items-center gap-3 bg-white rounded-2xl p-2 shadow-sm"><button onclick="changeDays(-1)" class="w-10 h-10 rounded-xl bg-stone-100 text-stone-600 flex items-center justify-center font-bold text-xl tap-effect">-</button><input type="number" id="trip-days-input" readonly class="flex-1 text-center text-xl font-bold bg-transparent border-none focus:ring-0 text-[#433D3C]" value="5"><button onclick="changeDays(1)" class="w-10 h-10 rounded-xl bg-stone-100 text-stone-600 flex items-center justify-center font-bold text-xl tap-effect">+</button></div></div>
            </div>
            <p class="text-[10px] text-red-400 text-center mt-6 mb-2">* 減少天數將會刪除多餘日期的行程</p>
            <div class="flex gap-3"><button onclick="closeDateModal()" class="flex-1 py-3 rounded-2xl bg-stone-100 text-stone-500 font-bold tap-effect">取消</button><button onclick="updateTravelDates()" class="flex-1 py-3 rounded-2xl bg-[#433D3C] text-white font-bold tap-effect shadow-lg shadow-stone-300">確認更新</button></div>
        </div>
    </div>

    <!-- Firebase Integration -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // 匯率 (NTD to HKD) - 由於這裡沒有 API，使用一個靜態值
        const EXCHANGE_RATE = 0.25; // 假設 1 TWD ≈ 0.25 HKD

        // 1. Setup Firebase using environment config
        // NOTE: The provided config is hardcoded. In a real environment, it would come from __firebase_config.
        const firebaseConfig = {
            apiKey: "AIzaSyDP1jX1u8TCI3TY8U3xfhEZbaMv9JLgJNw", // 您的 API Key
            authDomain: "mytaiwantrip-603c6.firebaseapp.com",
            projectId: "mytaiwantrip-603c6",
            storageBucket: "mytaiwantrip-603c6.firebasestorage.app",
            messagingSenderId: "1063667328708",
            appId: "1:1063667328708:web:d2ae7acd304e589b790b91"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        // 2. Use __app_id for environment consistency
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'travel_app_v2';
        let currentUser = null;
        
        // Multi-Trip State
        window.tripsList = [];
        let tripUnsubscribes = []; // To store listeners and detach them when switching trips
        window.currentDayIndex = 0;
        window.currentFilter = 'ALL';
        window.companions = ["我"];
        window.expenses = [];


        // New Global Trip Context
        window.currentTrip = {
            id: null, // The main ID (same as Private ID)
            sharedId: null, // If shared, this is the ID used in the public document (often same as id)
            isShared: false, // Is the trip currently being viewed/edited in the public collaborative path?
            creatorId: null, // The original creator's UID (only for shared trips)
            meta: {} // Stores the trip metadata (title, days, startDate)
        };
        
        // --- Firestore Path Helper ---
        // Modified to accept a forcePublic flag
        function getTripDocRef(tripId, collectionName, forcePublic = false) {
            const currentContext = window.currentTrip;
            const docName = `${tripId}_${collectionName}`;
            
            // Check if we are in shared mode OR if we are forcing a public read (for initial metadata load/publishing)
            if (currentContext.isShared || forcePublic) {
                // Public/Shared Path: artifacts/{appId}/public/data/shared_trips/{sharedId}_{collectionName}
                return doc(db, 'artifacts', appId, 'public', 'data', 'shared_trips', docName);
            } else {
                // Private Path: artifacts/{appId}/users/{userId}/travel_data/{tripId}_{collectionName}
                const uid = currentUser?.uid || 'anonymous';
                return doc(db, 'artifacts', appId, 'users', uid, 'travel_data', docName);
            }
        }

        // 3. Save Logic (Rewritten to use dynamic path)
        window.saveToFirestore = async (type, data) => {
            if (!currentUser) {
                showToast("尚未連線，無法儲存");
                return;
            }
            if (!window.currentTrip.id) {
                console.warn("No trip selected, skipping save");
                return;
            }
            
            try {
                showSyncing();
                // Check if we are in private mode but the trip has a sharedId (i.e., we are the owner but viewing privately)
                // If so, we should update BOTH private and public copies of the data for consistency
                if (!window.currentTrip.isShared && window.currentTrip.sharedId) {
                    // Save to Public (Shared) copy
                    const publicDocRef = getTripDocRef(window.currentTrip.sharedId, type, true);
                    await setDoc(publicDocRef, { items: data, lastUpdated: new Date().toISOString() });
                }
                
                // Save to Private or Public (depending on isShared status)
                const docRef = getTripDocRef(window.currentTrip.id, type);
                await setDoc(docRef, { items: data, lastUpdated: new Date().toISOString() });
                
                showSaved();
            } catch (e) { 
                console.error("Sync error:", e); 
                showError();
            }
        };
        
        // Save Trip Index List (Always Private)
        window.saveTripsIndex = async (trips) => {
             if (!currentUser || currentUser.isAnonymous) return; // Only save index for signed-in users
             try {
                 showSyncing();
                 const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'travel_data', 'trips_index');
                 await setDoc(docRef, { items: trips });
                 showSaved();
             } catch (e) { 
                 console.error("Sync error (Index):", e); 
                 showError();
             }
        }
        
        // Save Trip Meta Data (Always Private)
        window.saveTripMeta = async (tripId, meta) => {
            if (!currentUser || currentUser.isAnonymous) return;
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'travel_data', `${tripId}_meta`);
                await setDoc(docRef, meta);
            } catch (e) {
                console.error("Meta save error:", e);
            }
        }

        // UI Helpers (Same as before)
        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');
        const syncIndicator = document.getElementById('sync-indicator');
        const syncIcon = document.getElementById('sync-icon');
        const syncMsg = document.getElementById('sync-msg');

        function showSyncing() {
            syncIndicator.classList.add('show');
            syncIndicator.classList.remove('error');
            syncIcon.classList.add('animate-spin');
            syncIcon.setAttribute('data-lucide', 'refresh-cw');
            syncMsg.innerText = "同步中...";
            lucide.createIcons();
        }

        function showSaved() {
            syncIcon.classList.remove('animate-spin');
            syncIcon.setAttribute('data-lucide', 'check');
            syncMsg.innerText = "已儲存";
            lucide.createIcons();
            setTimeout(() => syncIndicator.classList.remove('show'), 1000);
        }

        function showError(msg) {
            syncIndicator.classList.add('show', 'error');
            syncIcon.classList.remove('animate-spin');
            syncIcon.setAttribute('data-lucide', 'alert-circle');
            syncMsg.innerText = msg || "儲存失敗";
            lucide.createIcons();
        }

        window.showToast = function(message) {
            const toast = document.getElementById('toast-message');
            toast.innerText = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // 4. Initialize Auth & Listeners
        async function initFirebase() {
            try {
                // Initial Auth Check (Custom Token from Canvas)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    // Fallback to anonymous sign-in
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        updateAuthUI(user);
                        statusText.innerText = user.isAnonymous ? "Guest Mode" : (user.displayName || user.uid.substring(0, 4));
                        statusDot.classList.replace('bg-gray-300', 'bg-green-400');
                        
                        // Load list OR shared trip from URL
                        const urlParams = new URLSearchParams(window.location.search);
                        const sharedTripId = urlParams.get('share');
                        
                        if (sharedTripId) {
                            await loadSharedTrip(sharedTripId);
                            // If shared trip is loaded, we skip loadTripList/routing below
                            return;
                        }

                        // Load trip list and handle private deep-linking inside the snapshot listener
                        loadTripList(user.uid);
                    } else {
                        // Should not happen often if we sign in anonymously above, but as a fallback:
                        statusText.innerText = "Offline";
                        statusDot.classList.replace('bg-gray-300', 'bg-red-400');
                        loadTripList('anonymous'); // Still try to load/render trips for anonymous user
                    }
                });

            } catch (e) { 
                console.error("Auth/Init error:", e); 
                statusText.innerText = "Error";
                statusDot.classList.replace('bg-gray-300', 'bg-red-400');
            }
        }
        
        // Google Auth Functions (Same as before)
        window.loginWithGoogle = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google login failed", error);
                if(error.code === 'auth/popup-blocked' || error.code === 'auth/operation-not-supported-in-this-environment') {
                    showToast("⚠️ 登入受限: 請在瀏覽器中運行程式碼。");
                } else {
                    showToast("登入失敗: " + error.message);
                }
            }
        }
        
        window.logoutGoogle = async () => {
            // Using custom confirm/modal logic (since alert is banned)
            showCustomConfirm('確定要登出嗎？', async () => {
                 await signOut(auth);
                 // Force re-initialization as anonymous
                 await signInAnonymously(auth);
                 backToTripList();
            });
        }
        
        function updateAuthUI(user) {
            const container = document.getElementById('user-auth-area');
            if (user.isAnonymous) {
                container.innerHTML = `
                <button onclick="loginWithGoogle()" class="flex flex-col items-center gap-1 group">
                    <div class="w-10 h-10 rounded-full bg-white border border-stone-200 shadow-sm flex items-center justify-center overflow-hidden transition-all group-hover:border-blue-300">
                        <i data-lucide="user" class="w-5 h-5 text-stone-400 group-hover:text-blue-500"></i>
                    </div>
                    <span class="text-[10px] font-bold text-stone-400 group-hover:text-blue-500">登入備份</span>
                </button>`;
            } else {
                const photoURL = user.photoURL || '';
                const initial = user.displayName ? user.displayName[0] : 'U';
                container.innerHTML = `
                <button onclick="logoutGoogle()" class="flex flex-col items-center gap-1 group">
                    <div class="w-10 h-10 rounded-full bg-stone-100 border-2 border-green-400 shadow-sm flex items-center justify-center overflow-hidden">
                        ${photoURL ? `<img src="${photoURL}" class="w-full h-full object-cover">` : `<span class="text-stone-600 font-bold">${initial}</span>`}
                    </div>
                    <span class="text-[10px] font-bold text-stone-600 group-hover:text-red-400">${user.displayName || user.uid.substring(0, 4)}</span>
                </button>`;
            }
            lucide.createIcons();
        }

        // 5. Load Trip List (Modified to handle private deep-linking)
        function loadTripList(uid) {
            // Only fetch user's own list if they are authenticated (not anonymous)
            if (uid === 'anonymous' || auth.currentUser.isAnonymous) {
                window.tripsList = [];
                window.renderTripListUI();
                return;
            }
            
            const indexRef = doc(db, 'artifacts', appId, 'users', uid, 'travel_data', 'trips_index');
            
            onSnapshot(indexRef, (docSnap) => {
                const urlParams = new URLSearchParams(window.location.search);
                const privateTripId = urlParams.get('id'); // NEW: Check for private ID

                if (docSnap.exists()) {
                    window.tripsList = docSnap.data().items || [];
                } else {
                    window.tripsList = [];
                }
                window.renderTripListUI();

                // Check for private deep link ONLY on initial load when currentTrip is null
                if (window.currentTrip.id === null && privateTripId) {
                    const trip = window.tripsList.find(t => t.id === privateTripId);
                    if (trip) {
                        openTrip(privateTripId);
                        return;
                    } else {
                        // Trip ID in URL, but not in user's list. Clear the URL.
                         history.pushState(null, '', window.location.pathname);
                    }
                }
                
                // Ensure default view (trip list) is active if no trip is loaded
                if (window.currentTrip.id === null) {
                    document.getElementById('view-trip-list').classList.add('page-active');
                    document.getElementById('view-trip-detail').classList.add('page-hidden');
                }
            });
        }
        
        // 6. Load Shared Trip (New functionality)
        window.loadSharedTrip = async function(sharedTripId) {
            // FIX: Pass true to getTripDocRef to force reading from the public path for metadata
            const metaRef = getTripDocRef(sharedTripId, 'meta', true);
            const metaSnap = await getDoc(metaRef);
            
            if (!metaSnap.exists()) {
                window.showToast("分享的行程不存在或已被移除。");
                backToTripList(); // Go back to the trip list page
                return;
            }

            const meta = metaSnap.data();

            // Set Global State for shared trip
            window.currentTrip = {
                id: sharedTripId, // In shared mode, the ID of the document being viewed is the shared ID
                sharedId: sharedTripId,
                isShared: true,
                creatorId: meta.creatorId,
                meta: meta
            };
            
            // Update URL to reflect the shared ID
            history.pushState(null, '', `${window.location.pathname}?share=${sharedTripId}`);

            // Update UI
            document.getElementById('header-title').innerText = meta.title;
            document.getElementById('header-subtitle').innerText = "SHARED TRIP";
            
            // Show Save/Share buttons based on context
            const isCreator = currentUser && currentUser.uid === meta.creatorId;
            document.getElementById('share-button').classList.toggle('hidden', !isCreator);
            document.getElementById('save-button').classList.toggle('hidden', isCreator);
            
            // Switch View
            document.getElementById('view-trip-list').classList.remove('page-active');
            document.getElementById('view-trip-list').classList.add('page-hidden');
            document.getElementById('view-trip-detail').classList.remove('page-hidden');
            document.getElementById('view-trip-detail').classList.add('page-active');
            
            // Start listening on public paths
            // Note: startTripListeners will now use the correct public path because currentTrip.isShared is true
            window.startTripListeners(sharedTripId);
        }

        // 7. Start Listeners for Specific Trip (Modified to use dynamic paths)
        window.startTripListeners = function(tripId) {
            // Unsubscribe previous listeners
            tripUnsubscribes.forEach(unsub => unsub());
            tripUnsubscribes = [];
            
            const types = ['schedule', 'expenses', 'companions'];
            
            types.forEach(type => {
                const docRef = getTripDocRef(tripId, type);
                
                const unsub = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data().items;
                        if(type === 'schedule') {
                            window.scheduleData = data;
                            window.renderDaySelector();
                            window.renderTimeline(window.currentDayIndex);
                        } else if(type === 'expenses') {
                            window.expenses = data;
                            window.renderExpenses();
                        } else if(type === 'companions') {
                            window.companions = data;
                            window.updatePayerSelect();
                            window.renderShareButtons();
                            window.renderFilter();
                        }
                    } else {
                        // Initialize with defaults if doc doesn't exist
                        if(type === 'schedule') window.scheduleData = []; 
                        if(type === 'expenses') window.expenses = [];
                        // Only initialize companions if it's the owner/private view and the list is completely empty
                        if(type === 'companions' && !docSnap.exists()) window.companions = ["我"];
                    }
                    // For the main trip, we also need to update its local metadata if it's not a shared trip
                    if (!window.currentTrip.isShared && type === 'schedule' && window.scheduleData.length > 0) {
                        const trip = window.tripsList.find(t => t.id === tripId);
                        if (trip && trip.days !== window.scheduleData.length) {
                             trip.days = window.scheduleData.length;
                             // Check if scheduleData[0] exists before accessing its properties
                             if (window.scheduleData[0] && window.scheduleData[0].month) {
                                trip.startDate = `${window.scheduleData[0].month}/${window.scheduleData[0].date}`;
                             }
                             window.saveTripsIndex(window.tripsList);
                        }
                    }
                }, (error) => {
                    console.error(`Read error (${type}):`, error);
                });
                
                tripUnsubscribes.push(unsub);
            });
        }
        
        // Modified to handle routing for bookmarked shared trips
        window.openTrip = function(tripId) {
            const trip = window.tripsList.find(t => t.id === tripId);
            if (!trip) return;
            
            // NEW LOGIC: If the trip is flagged as a shared bookmark, load it as a shared trip
            if (trip.isShared) {
                // The ID in the tripsList is the shared ID (trip.id === trip.sharedId), load as shared trip
                loadSharedTrip(trip.id); 
                return;
            }

            // 1. Set State (Private context)
            window.currentTrip = {
                id: tripId,
                sharedId: trip.sharedId || null, // Preserve sharedId if it exists in the index (owner)
                isShared: false,
                creatorId: trip.creatorId || currentUser?.uid,
                meta: trip
            };
            
            // 2. Update UI
            document.getElementById('header-title').innerText = trip.title;
            document.getElementById('header-subtitle').innerText = "TRIP";
            
            // Always show the Share button for owner's trips.
            document.getElementById('share-button').classList.remove('hidden');
            document.getElementById('save-button').classList.add('hidden');
            
            // 3. Start Listeners
            window.startTripListeners(tripId);

            // 4. Update URL for deep linking
            history.pushState(null, '', `${window.location.pathname}?id=${tripId}`);
            
            // 5. Switch View
            document.getElementById('view-trip-list').classList.remove('page-active');
            document.getElementById('view-trip-list').classList.add('page-hidden');
            document.getElementById('view-trip-detail').classList.remove('page-hidden');
            document.getElementById('view-trip-detail').classList.add('page-active');
        }

        window.backToTripList = function() {
             // Unsubscribe all listeners when leaving the trip detail view
             tripUnsubscribes.forEach(unsub => unsub());
             tripUnsubscribes = [];

             // Reset URL
             history.pushState(null, '', window.location.pathname);
            
            // Reset Trip Context
            window.currentTrip = { id: null, sharedId: null, isShared: false, creatorId: null, meta: {} };
            
            // Remove Share/Save buttons
            document.getElementById('share-button').classList.add('hidden');
            document.getElementById('save-button').classList.add('hidden');
            
            document.getElementById('view-trip-detail').classList.remove('page-active');
            document.getElementById('view-trip-detail').classList.add('page-hidden');
            document.getElementById('view-trip-list').classList.remove('page-hidden');
            document.getElementById('view-trip-list').classList.add('page-active');
        }
        
        // --- Sharing Functionality (NEW) ---
        const shareModal = document.getElementById('share-modal');
        const shareContent = document.getElementById('share-content');

        window.openShareModal = function() { 
            if (!window.currentTrip.id) return showToast("請先選擇一個行程");
            
            // If not shared yet, check if it was shared before
            if (!window.currentTrip.meta.isShared && !window.currentTrip.sharedId) {
                publishTripForSharing();
            } else if (window.currentTrip.sharedId) {
                renderShareLink(window.currentTrip.sharedId);
            } else {
                renderShareLink(window.currentTrip.id);
            }
            shareModal.classList.remove('hidden'); 
            lucide.createIcons();
        }
        window.closeShareModal = function() { shareModal.classList.add('hidden'); }
        shareModal.addEventListener('click', (e) => { if (e.target === shareModal) closeShareModal(); });

        async function publishTripForSharing() {
            if (!currentUser || currentUser.isAnonymous) return showToast("請先登入 Google 才能發布行程進行協作。");
            
            const tripId = window.currentTrip.id;
            const meta = window.currentTrip.meta;
            const sharedId = tripId; // Use the private ID as the shared ID

            // 1. Prepare shared metadata
            const sharedMeta = {
                ...meta,
                creatorId: currentUser.uid,
                isShared: true,
                createdAt: meta.createdAt || new Date().toISOString()
            };
            
            // 2. Copy data from Private to Public path
            showSyncing();
            
            try {
                // Save Metadata (to public path)
                const metaRef = getTripDocRef(sharedId, 'meta', true);
                await setDoc(metaRef, sharedMeta);
                
                // Save current data to Public path (Force Public: true)
                const publicScheduleRef = getTripDocRef(sharedId, 'schedule', true);
                await setDoc(publicScheduleRef, { items: window.scheduleData, lastUpdated: new Date().toISOString() });
                
                const publicExpensesRef = getTripDocRef(sharedId, 'expenses', true);
                await setDoc(publicExpensesRef, { items: window.expenses, lastUpdated: new Date().toISOString() });
                
                const publicCompanionsRef = getTripDocRef(sharedId, 'companions', true);
                await setDoc(publicCompanionsRef, { items: window.companions, lastUpdated: new Date().toISOString() });
                
                showSaved();
                window.showToast("✅ 行程已成功發布為協作模式！");

                // 3. Update local index (for owner)
                const tripIndex = window.tripsList.findIndex(t => t.id === tripId);
                if (tripIndex !== -1) {
                    window.tripsList[tripIndex].isShared = true;
                    window.tripsList[tripIndex].sharedId = sharedId;
                    window.tripsList[tripIndex].creatorId = currentUser.uid;
                    await window.saveTripsIndex(window.tripsList);
                }
                
                // 4. Update current context and listeners to read/write from the public path
                window.currentTrip.meta = sharedMeta;
                window.currentTrip.sharedId = sharedId;
                window.currentTrip.isShared = true;
                window.startTripListeners(sharedId); // Restart listeners to point to public path

                // 5. Update UI and render link
                document.getElementById('header-subtitle').innerText = "SHARED TRIP";
                document.getElementById('share-button').classList.remove('hidden');
                document.getElementById('save-button').classList.add('hidden');
                renderShareLink(sharedId);
                
                // Crucial: Update URL to reflect the new shared state
                history.pushState(null, '', `${window.location.pathname}?share=${sharedId}`);
            } catch (e) {
                console.error("Publish error:", e);
                showError("發布失敗，請重試。");
            }
        }

        function renderShareLink(tripId) {
            const shareLink = `${window.location.origin}${window.location.pathname}?share=${tripId}`;
            
            shareContent.innerHTML = `
                <div class="bg-stone-100 p-4 rounded-xl flex flex-col gap-2 mb-4">
                    <p class="text-xs text-stone-500 font-bold uppercase">協作連結</p>
                    <input type="text" id="share-link-input" value="${shareLink}" readonly class="w-full bg-stone-50 text-stone-700 font-mono text-sm p-2 rounded-lg border-none focus:outline-none">
                </div>
                <div class="flex flex-col gap-3">
                    <button onclick="copyShareLink('${shareLink}')" class="w-full py-3 rounded-2xl bg-blue-600 text-white font-bold tap-effect shadow-md shadow-blue-200 flex items-center justify-center gap-2">
                        <i data-lucide="copy" class="w-4 h-4"></i> 複製連結
                    </button>
                    <button onclick="window.location.href = 'mailto:?subject=邀請你一起規劃行程：${window.currentTrip.meta.title}&body=點擊此連結加入協作：${shareLink}'" class="w-full py-3 rounded-2xl bg-stone-200 text-stone-700 font-bold tap-effect flex items-center justify-center gap-2">
                        <i data-lucide="mail" class="w-4 h-4"></i> 電郵分享
                    </button>
                </div>
            `;
            lucide.createIcons();
        }
        
        window.copyShareLink = function(link) {
            // Using document.execCommand('copy') for better iframe compatibility
            const el = document.createElement('textarea');
            el.value = link;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            window.showToast("已複製到剪貼簿！");
            closeShareModal();
        }

        // --- Forking Functionality (NEW - Modified to be Collaborative Bookmark) ---
        window.forkSharedTrip = async function() {
            // Only allow saving if user is signed in (not anonymous)
            if (!currentUser || currentUser.isAnonymous) return showToast("請先登入才能儲存行程！");
            if (!window.currentTrip.isShared) return; // Safety check

            const sharedId = window.currentTrip.id;
            
            // Check if the trip is already saved in the private list (as a bookmark)
            if (window.tripsList.some(t => t.id === sharedId && t.isShared)) {
                 return window.showToast("此協作行程已儲存到您的計畫中。");
            }
            
            showCustomConfirm(`確定要將「${window.currentTrip.meta.title}」儲存為協作連結到您的計畫中嗎？`, async () => {
                
                // 1. Create the new Private Metadata (This is just a pointer/bookmark)
                const newTripMeta = {
                    // We use the shared ID as the 'id' in the user's list for simple retrieval, 
                    // and flag it as shared. This prevents creating new, unnecessary private documents.
                    id: sharedId, 
                    title: window.currentTrip.meta.title, 
                    startDate: window.currentTrip.meta.startDate,
                    days: window.currentTrip.meta.days,
                    isShared: true, // Key flag: indicates it's a bookmark to a public document
                    sharedId: sharedId,
                    creatorId: window.currentTrip.creatorId,
                    bookmarkedAt: new Date().toISOString()
                };
                
                // 2. Update User's Trip Index (Always Private)
                showSyncing();
                window.tripsList.push(newTripMeta);
                await window.saveTripsIndex(window.tripsList);
                
                showSaved();
                window.showToast(`✅ 已將行程「${newTripMeta.title}」儲存為協作連結！`);
                
                // Stay on the shared view (URL remains ?share={id})
                document.getElementById('save-button').classList.add('hidden'); // Hide save button after saving
            });
        }
        
        // --- Custom Confirm Modal (Since alert/confirm is banned) ---
        function showCustomConfirm(message, onConfirm) {
            const modalHtml = `
                <div id="custom-confirm-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
                    <div class="bg-[#FEFDF5] w-full max-w-xs rounded-[24px] p-6 shadow-2xl modal-enter relative">
                        <p class="text-sm font-bold text-stone-700 mb-6 text-center">${message}</p>
                        <div class="flex gap-3">
                            <button id="confirm-cancel" class="flex-1 py-3 rounded-xl bg-stone-100 text-stone-500 font-bold tap-effect">取消</button>
                            <button id="confirm-ok" class="flex-1 py-3 rounded-xl bg-red-500 text-white font-bold tap-effect shadow-md shadow-red-200">確定</button>
                        </div>
                    </div>
                </div>
            `;
            const wrapper = document.createElement('div');
            wrapper.innerHTML = modalHtml;
            document.body.appendChild(wrapper);

            const modal = document.getElementById('custom-confirm-modal');
            
            document.getElementById('confirm-cancel').onclick = () => { modal.remove(); };
            document.getElementById('confirm-ok').onclick = () => { onConfirm(); modal.remove(); };
            
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        }


        // --- Other Logic (Kept as before, updated save calls to use global context) ---
        
        // Load List UI (Same as before)
        window.renderTripListUI = function() {
            const container = document.getElementById('trip-list-container');
            if (window.tripsList.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-center mt-10">
                        <div class="w-20 h-20 bg-stone-100 rounded-full flex items-center justify-center text-stone-300 mb-4">
                            <i data-lucide="map" class="w-10 h-10"></i>
                        </div>
                        <h3 class="text-xl font-bold text-stone-600">還沒有旅程</h3>
                        <p class="text-stone-400 text-sm mt-2">點擊右下角的 + 開始規劃吧！</p>
                    </div>
                `;
            } else {
                container.innerHTML = window.tripsList.map((trip, idx) => {
                    const days = trip.days || '?';
                    const bgClass = `trip-card-bg-${idx % 4}`;
                    // Check if the trip is a shared bookmark or the owner's shared trip
                    const isSharedText = trip.isShared ? `<div class="text-[10px] font-bold text-white/80 bg-black/20 px-2 py-0.5 rounded-full absolute top-3 left-3 flex items-center gap-1"><i data-lucide="users" class="w-3 h-3"></i> 協作</div>` : '';
                    return `
                        <div onclick="openTrip('${trip.id}')" class="relative group w-full ${bgClass} rounded-[24px] p-6 shadow-lg transform transition-all tap-effect overflow-hidden cursor-pointer min-h-[140px] flex flex-col justify-between">
                            ${isSharedText}
                            <div class="absolute top-0 right-0 p-3 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="event.stopPropagation(); deleteTrip('${trip.id}')" class="w-8 h-8 bg-white/30 backdrop-blur-md rounded-full flex items-center justify-center text-white hover:bg-red-500 hover:text-white transition-colors">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                            
                            <div>
                                <h3 class="text-2xl font-bold text-white mb-1 drop-shadow-sm leading-tight">${trip.title}</h3>
                                <div class="flex items-center gap-2 text-white/90 text-xs font-bold bg-black/10 w-fit px-2 py-1 rounded-lg backdrop-blur-sm">
                                    <i data-lucide="calendar" class="w-3 h-3"></i> ${trip.startDate}
                                </div>
                            </div>
                            
                            <div class="flex items-end justify-between mt-4">
                                <div class="flex -space-x-2">
                                     <div class="w-8 h-8 rounded-full bg-white/90 border-2 border-white flex items-center justify-center text-xs font-bold text-stone-500">我</div>
                                </div>
                                <span class="text-white font-bold text-4xl opacity-80">${days}<span class="text-sm ml-1">Days</span></span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            lucide.createIcons();
        }

        // Add Trip Modal Logic (Same as before, but calls updateTripMeta too)
        const addTripModal = document.getElementById('add-trip-modal');
        window.openAddTripModal = function() { addTripModal.classList.remove('hidden'); }
        window.closeAddTripModal = function() { addTripModal.classList.add('hidden'); }
        
        window.confirmAddTrip = async function() {
            const title = document.getElementById('new-trip-title').value;
            const startDate = document.getElementById('new-trip-date').value;
            const days = parseInt(document.getElementById('new-trip-days').value);
            const useTemplate = document.getElementById('use-template').checked;
            
            if(!title || !startDate) return window.showToast("請填寫完整資訊");
            
            const newId = 'trip_' + Date.now();
            const newTripMeta = {
                id: newId,
                title: title,
                startDate: startDate,
                days: days,
                isShared: false,
                creatorId: currentUser?.uid || 'anonymous',
                createdAt: new Date().toISOString()
            };
            
            // 1. Prepare Initial Schedule Data
            let initialSchedule = [];
            const start = new Date(startDate.replace(/-/g, '/')); // Fix Safari date parsing
            for(let i=0; i<days; i++) {
                const dt = new Date(start);
                dt.setDate(start.getDate()+i);
                
                let items = [];
                if (useTemplate && window.templateScheduleData[i]) {
                    items = window.templateScheduleData[i].items;
                }
                
                initialSchedule.push({
                    date: dt.getDate(),
                    month: dt.getMonth() + 1,
                    day: `Day ${i+1}`,
                    items: items
                });
            }
            
            // 2. Update Local State & UI immediately (Optimistic)
            window.tripsList.push(newTripMeta);
            window.renderTripListUI();
            closeAddTripModal();
            
            // 3. Save to Private Paths
            const prevContext = { ...window.currentTrip };
            window.currentTrip = { id: newId, isShared: false, meta: newTripMeta };
            
            await window.saveTripMeta(newId, newTripMeta);
            await window.saveToFirestore('schedule', initialSchedule);
            await window.saveToFirestore('expenses', []);
            await window.saveToFirestore('companions', ["我"]);
            
            window.currentTrip = prevContext; // Reset context
            await window.saveTripsIndex(window.tripsList);
            
            // 4. Open it
            openTrip(newId);
        }
        
        window.deleteTrip = async function(tripId) {
            // Check if the trip is currently active and redirect if so
            if (window.currentTrip.id === tripId) {
                backToTripList();
            }

            showCustomConfirm("確定要刪除這個旅程嗎？此操作只會移除您列表中的連結或私人資料，無法復原。", async () => {
                 window.tripsList = window.tripsList.filter(t => t.id !== tripId);
                 window.renderTripListUI();
                 await window.saveTripsIndex(window.tripsList);
                 // NOTE: This version does NOT delete the actual private or public documents.
                 // It only removes the reference from the user's index (trips_index).
                 window.showToast("行程已從您的列表中移除");
            });
        }
        
        // --- Core Logic (Scheduled Data & Budgeting) ---

        window.renderDaySelector = function() { 
            const c = document.getElementById('day-selector'); 
            if (!window.scheduleData || window.scheduleData.length === 0) {
                 c.innerHTML = ""; return;
            }
            
            if (window.currentDayIndex >= window.scheduleData.length) {
                 window.currentDayIndex = 0;
            }

            c.innerHTML = window.scheduleData.map((d, i) => `<button onclick="selectDay(${i})" class="day-btn flex-shrink-0 flex flex-col items-center justify-center w-[60px] h-[72px] rounded-2xl transition-all border border-transparent tap-effect ${i===window.currentDayIndex?'bg-[#433D3C] text-[#FEFDF5] shadow-lg shadow-stone-200':'bg-white text-stone-300'}"><span class="text-[10px] font-bold tracking-wide opacity-80">${d.day}</span><span class="text-xl font-bold font-mono mt-1">${d.month}/${d.date}</span></button>`).join(''); 
        }
        
        window.selectDay = function(i) { 
            window.currentDayIndex = i; 
            document.querySelectorAll('.day-btn').forEach((b, idx) => { b.className = `day-btn flex-shrink-0 flex flex-col items-center justify-center w-[60px] h-[72px] rounded-2xl transition-all border border-transparent tap-effect ${idx===i?'bg-[#433D3C] text-[#FEFDF5] shadow-lg shadow-stone-200 transform scale-105':'bg-white text-stone-300'}`; }); 
            window.renderTimeline(i);
            generateHourlyWeather(); 
        }
        
        window.renderTimeline = function(i) { 
            const c = document.getElementById('timeline-container'); 
            if (!window.scheduleData[i]) {
                c.innerHTML = `<div class="text-center text-stone-300 py-10">尚無行程</div>`;
                return;
            }
            const d = window.scheduleData[i];
            if (!d.items) d.items = [];
            d.items.sort((a,b)=>a.time.localeCompare(b.time));
            
            let html = d.items.map((item, idx) => {
                let icon = item.type==='food'?'utensils':item.type==='transport'?'bus':item.type==='shop'?'shopping-bag':item.type==='stay'?'bed':'map-pin';
                let color = item.type==='food'?'text-orange-500 bg-orange-50':item.type==='transport'?'text-blue-500 bg-blue-50':item.type==='shop'?'text-pink-500 bg-pink-50':item.type==='stay'?'text-purple-500 bg-purple-50':'text-stone-500 bg-stone-100';
                let tags = item.tags ? item.tags.map(t => `<span class="text-[10px] px-2.5 py-1 rounded-lg font-bold bg-stone-50 text-stone-500 ${t.includes('必')?'tag-must-eat':''}">${t}</span>`).join('') : '';
                let timeDisplay = `<div class="text-center"><span class="text-xs font-bold text-stone-400 font-mono block leading-tight">${item.time}</span>`;
                if(item.endTime) { timeDisplay += `<span class="text-[10px] text-stone-300 font-mono block leading-tight my-0.5">↓</span><span class="text-xs font-bold text-stone-400 font-mono block leading-tight">${item.endTime}</span>`; }
                timeDisplay += `</div>`;

                return `<div onclick="openDetailModal(${i}, ${idx})" class="card-clickable bg-white rounded-[24px] p-5 zen-shadow relative overflow-hidden animate-slide-up mb-4 border border-white active:bg-stone-50 transition-colors"><div class="flex gap-4"><div class="flex flex-col items-center pt-1 w-12 flex-shrink-0">${timeDisplay}<div class="w-10 h-10 rounded-full flex items-center justify-center ${color} mt-2"><i data-lucide="${icon}" class="w-5 h-5"></i></div><div class="h-full w-0.5 bg-stone-100 my-2 rounded-full"></div></div><div class="flex-1 pb-2 min-w-0"><div class="flex justify-between items-start"><h3 class="font-bold text-[#433D3C] text-lg leading-tight truncate mr-2">${item.title}</h3></div><div class="flex items-center gap-2 mt-2 mb-3"><div class="text-xs flex items-center gap-1.5 bg-stone-50 text-stone-500 px-3 py-1.5 rounded-xl max-w-full truncate font-medium"><i data-lucide="map-pin" class="w-3 h-3 flex-shrink-0"></i><span class="truncate">${item.location||'設定地點'}</span></div></div>${item.note?`<p class="text-xs text-stone-400 mt-1 line-clamp-2 leading-relaxed bg-[#FEFDF5] p-2 rounded-lg">${item.note}</p>`:''}<div class="flex flex-wrap gap-2 mt-3">${tags}</div><div class="flex justify-end gap-2 mt-3 pt-2 border-t border-stone-50"><button onclick="event.stopPropagation(); openEditModal(${i}, ${idx})" class="px-3 py-1.5 bg-stone-100 rounded-lg text-xs font-bold text-stone-500 tap-effect flex items-center gap-1"><i data-lucide="pencil" class="w-3 h-3"></i> 編輯</button><button onclick="event.stopPropagation(); deleteScheduleItem(${i}, ${idx})" class="px-3 py-1.5 bg-red-50 rounded-lg text-xs font-bold text-red-400 tap-effect flex items-center gap-1"><i data-lucide="trash-2" class="w-3 h-3"></i> 刪除</button></div></div></div></div>`
            }).join('') + `<button onclick="openAddModal(${i})" class="w-full py-4 rounded-[24px] border-2 border-dashed border-stone-200 text-stone-300 hover:border-stone-300 hover:text-stone-500 transition-all flex items-center justify-center gap-2 tap-effect mt-2 bg-white/50"><i data-lucide="plus" class="w-5 h-5"></i><span class="font-bold">新增行程</span></button>`;
            c.innerHTML = html;
            lucide.createIcons();
        }

        window.setFilter = function(name) { window.currentFilter = name; window.renderExpenses(); }
        window.renderFilter = function() { const c = document.getElementById('member-filter-container'); let h = `<button onclick="setFilter('ALL')" class="flex-shrink-0 px-4 py-1.5 rounded-full text-xs transition-all ${window.currentFilter === 'ALL' ? 'filter-btn-active' : 'filter-btn-inactive'}">全體</button>`; window.companions.forEach(n => { h += `<button onclick="setFilter('${n}')" class="flex-shrink-0 px-4 py-1.5 rounded-full text-xs transition-all ${window.currentFilter === n ? 'filter-btn-active' : 'filter-btn-inactive'}">${n}</button>`; }); c.innerHTML = h; }
        
        window.renderExpenses = function() {
            const list = document.getElementById('expense-list');
            const totalTwdEl = document.getElementById('total-expense-twd');
            const totalHkdEl = document.getElementById('total-expense-hkd');
            const titleEl = document.getElementById('budget-title');
            const listStatusEl = document.getElementById('list-filter-status');
            let displayExpenses = []; let totalTWD = 0;
            
            if (window.currentFilter === 'ALL') { 
                displayExpenses = window.expenses; titleEl.innerText = "總消費 (ALL)"; listStatusEl.innerText = "顯示全部"; 
                totalTWD = window.expenses.reduce((sum, ex) => sum + parseInt(ex.amount), 0);
            } else { 
                titleEl.innerText = `個人消費 (${window.currentFilter})`; listStatusEl.innerText = `只顯示 ${window.currentFilter} 的分攤項目`; 
                
                // FIX: Correctly filter by checking if the current filter/user is in the sharedBy array (which holds names)
                displayExpenses = window.expenses.filter(ex => ex.sharedBy && ex.sharedBy.includes(window.currentFilter));
                
                // FIX: Calculate the sum of the divided amounts for the current user based on the correctly filtered list
                totalTWD = displayExpenses.reduce((sum, ex) => { 
                    const sharersCount = (ex.sharedBy && ex.sharedBy.length > 0) ? ex.sharedBy.length : 1; 
                    return sum + (parseInt(ex.amount) / sharersCount); 
                }, 0); 
            }
            
            list.innerHTML = displayExpenses.map((ex, i) => {
                const originalIndex = window.expenses.indexOf(ex);
                const fullAmount = parseInt(ex.amount);
                let displayAmount = fullAmount; let displayLabel = "總額"; let detailText = ""; let amountClass = "text-stone-800";
                const sharersCount = (ex.sharedBy && ex.sharedBy.length > 0) ? ex.sharedBy.length : 1; // Calculate sharer count here
                
                if (window.currentFilter !== 'ALL') { 
                    displayAmount = fullAmount / sharersCount; 
                    displayLabel = "應付"; 
                    detailText = `(總額 $${fullAmount} ÷ ${sharersCount}人)`; 
                    amountClass = "text-blue-600"; 
                }
                const amountHKD = Math.round(displayAmount * EXCHANGE_RATE); const amountTWD = Math.round(displayAmount);
                const payer = ex.payer || "我"; const sharedBy = ex.sharedBy || ["我"]; const shareText = sharedBy.length === window.companions.length ? "全員" : sharedBy.join(",");
                return `<div class="flex flex-col bg-white p-4 rounded-[20px] shadow-sm border border-stone-100"><div class="flex justify-between items-start mb-2"><div><span class="text-base font-bold text-stone-700 block">${ex.item}</span><span class="text-[10px] text-stone-400">由 ${payer} 先付 • 分攤: ${shareText}</span></div><div class="text-right"><div class="text-[10px] text-stone-300 font-bold mb-0.5 text-right">${displayLabel}</div><div class="font-mono font-bold ${amountClass} text-lg">NT$ ${amountTWD}</div><div class="font-mono text-xs text-stone-400">≈ HK$ ${amountHKD}</div>${detailText ? `<div class="text-[10px] text-stone-400 mt-0.5">${detailText}</div>` : ''}</div></div><div class="flex justify-end border-t border-stone-50 pt-2 mt-1"><button onclick="deleteExpense(${originalIndex})" class="text-xs text-stone-300 hover:text-red-400 flex items-center gap-1 px-2 py-1 rounded tap-effect"><i data-lucide="trash-2" class="w-3 h-3"></i> 刪除</button></div></div>`;
            }).reverse().join('') || `<div class="text-center text-stone-300 text-sm py-8">沒有相關紀錄</div>`;
            totalTwdEl.innerText = Math.round(totalTWD).toLocaleString(); totalHkdEl.innerText = Math.round(totalTWD * EXCHANGE_RATE).toLocaleString();
            window.renderFilter(); lucide.createIcons();
        }

        window.addExpense = function() { const item = document.getElementById('expense-item').value; const amount = document.getElementById('expense-amount').value; const payer = document.getElementById('expense-payer').value; const shareBtns = document.querySelectorAll('.share-toggle-btn.share-btn-selected'); const sharedBy = Array.from(shareBtns).map(btn => btn.getAttribute('data-name')); if(!item || !amount) { window.showToast("請輸入項目和金額"); return; } if(sharedBy.length === 0) { window.showToast("請至少選擇一位分攤對象"); return; } window.expenses.push({ item, amount, payer, sharedBy }); document.getElementById('expense-item').value = ''; document.getElementById('expense-amount').value = ''; document.getElementById('input-hkd-preview').innerText = '0'; window.saveToFirestore('expenses', window.expenses); }
        window.deleteExpense = function(index) { showCustomConfirm('確定刪除這筆紀錄？', () => { window.expenses.splice(index, 1); window.saveToFirestore('expenses', window.expenses); }); }
        
        window.promptAddCompanion = function() { 
            // Using prompt for simplicity, replace with custom modal if needed
            const name = prompt("請輸入旅伴名字："); 
            if (name && name.trim() !== "") { 
                if (!window.companions.includes(name.trim())) { 
                    window.companions.push(name.trim()); 
                    window.saveToFirestore('companions', window.companions); 
                } else { 
                    window.showToast("已經在名單內囉！"); 
                } 
            } 
        }
        
        window.updatePayerSelect = function() { 
            const payerSelect = document.getElementById('expense-payer');
            payerSelect.innerHTML = window.companions.map(c => `<option value="${c}">${c}</option>`).join(''); 
        }
        window.renderShareButtons = function() { 
            document.getElementById('share-buttons-container').innerHTML = window.companions.map(c => `<button type="button" class="share-toggle-btn share-btn-selected px-3 py-1.5 rounded-lg text-xs font-bold border transition-colors" data-name="${c}" onclick="toggleShare(this)">${c}</button>`).join(''); 
        }
        window.toggleShare = function(btn) { 
            if (btn.classList.contains('share-btn-selected')) { 
                btn.classList.remove('share-btn-selected'); 
                btn.classList.add('share-btn-unselected'); 
            } else { 
                btn.classList.remove('share-btn-unselected'); 
                btn.classList.add('share-btn-selected'); 
            } 
        }
        window.selectAllShares = function() { 
            document.querySelectorAll('.share-toggle-btn').forEach(btn => { 
                btn.classList.remove('share-btn-unselected'); 
                btn.classList.add('share-btn-selected'); 
            }); 
        }
        
        // Modals
        const detailModal = document.getElementById('detail-modal'); const detailContent = document.getElementById('detail-content');
        window.openDetailModal = function(dayIndex, itemIndex) { const item = window.scheduleData[dayIndex].items[itemIndex]; let icon = item.type==='food'?'utensils':item.type==='transport'?'bus':item.type==='shop'?'shopping-bag':item.type==='stay'?'bed':'map-pin'; let timeStr = item.time; if (item.endTime) timeStr += ` - ${item.endTime}`; 
            const descriptionText = item.description ? item.description.split('\n').map(l=>`<p class="mb-2">${l}</p>`).join('') : '<p class="text-stone-400 italic">暫無詳細介紹...</p>';
            detailContent.innerHTML = `<div class="flex items-start justify-between mb-2"><div class="w-12 h-12 rounded-2xl bg-stone-100 flex items-center justify-center text-stone-600"><i data-lucide="${icon}" class="w-6 h-6"></i></div><div class="text-right"><p class="text-2xl font-mono font-bold text-stone-800">${timeStr}</p><p class="text-xs text-stone-400 font-bold">11月${window.scheduleData[dayIndex].date}日</p></div></div><h2 class="text-2xl font-bold text-[#433D3C] mb-1 leading-tight">${item.title}</h2><button onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}')" class="inline-flex items-center gap-1.5 text-blue-500 text-sm font-bold mb-4 tap-effect"><i data-lucide="map-pin" class="w-4 h-4"></i> ${item.location || '設定地點'} <i data-lucide="external-link" class="w-3 h-3"></i></button><div class="bg-white p-5 rounded-2xl border border-stone-100 shadow-sm"><h4 class="text-xs font-bold text-stone-400 mb-3 uppercase tracking-wider">ABOUT</h4><div class="text-stone-600 text-sm leading-relaxed space-y-2">${descriptionText}</div></div>`; 
            detailModal.classList.remove('hidden'); lucide.createIcons(); 
        }
        window.closeDetailModal = function() { detailModal.classList.add('hidden'); }
        detailModal.addEventListener('click', (e) => { if (e.target === detailModal) closeDetailModal(); });

        const editModal = document.getElementById('edit-modal'); const modalTitle = document.getElementById('modal-title');
        window.openAddModal = function(dayIndex) { document.getElementById('edit-day-index').value = dayIndex; document.getElementById('edit-item-index').value = -1; modalTitle.innerText = "新增行程"; document.getElementById('edit-time').value = "12:00"; document.getElementById('edit-end-time').value = ""; document.getElementById('edit-type').value = "sight"; document.getElementById('edit-title').value = ""; document.getElementById('edit-location').value = ""; document.getElementById('edit-tags').value = ""; document.getElementById('edit-note').value = ""; document.getElementById('edit-description').value = ""; editModal.classList.remove('hidden'); }
        window.openEditModal = function(dayIndex, itemIndex) { const item = window.scheduleData[dayIndex].items[itemIndex]; document.getElementById('edit-day-index').value = dayIndex; document.getElementById('edit-item-index').value = itemIndex; modalTitle.innerText = "編輯行程"; document.getElementById('edit-time').value = item.time; document.getElementById('edit-end-time').value = item.endTime || ""; document.getElementById('edit-type').value = item.type; document.getElementById('edit-title').value = item.title; document.getElementById('edit-location').value = item.location; document.getElementById('edit-tags').value = item.tags?item.tags.join(', '):''; document.getElementById('edit-note').value = item.note||''; document.getElementById('edit-description').value = item.description||''; editModal.classList.remove('hidden'); }
        window.closeEditModal = function() { editModal.classList.add('hidden'); }
        window.saveScheduleItem = function(e) { e.preventDefault(); const d = parseInt(document.getElementById('edit-day-index').value); const i = parseInt(document.getElementById('edit-item-index').value); const item = { time: document.getElementById('edit-time').value, endTime: document.getElementById('edit-end-time').value, type: document.getElementById('edit-type').value, title: document.getElementById('edit-title').value, location: document.getElementById('edit-location').value, tags: document.getElementById('edit-tags').value.split(',').map(t=>t.trim()).filter(t=>t), note: document.getElementById('edit-note').value, description: document.getElementById('edit-description').value }; if (i === -1) window.scheduleData[d].items.push(item); else window.scheduleData[d].items[i] = item; window.saveToFirestore('schedule', window.scheduleData); window.renderTimeline(d); closeEditModal(); }
        window.deleteScheduleItem = function(d, i) { showCustomConfirm("確定刪除？", () => { window.scheduleData[d].items.splice(i, 1); window.saveToFirestore('schedule', window.scheduleData); window.renderTimeline(d); }); }
        editModal.addEventListener('click', (e) => { if (e.target === editModal) closeEditModal(); });

        // Date & Days
        const dateModal = document.getElementById('date-modal');
        window.openDateModal = function() { 
            // Only allow editing if not viewing a shared trip (to prevent accidental overwrites)
            if (window.currentTrip.isShared) {
                showToast("協作模式下無法更改天數。請先儲存為私人副本。");
                return;
            }
            document.getElementById('start-date-input').value = window.currentTrip.meta.startDate || new Date().toISOString().split('T')[0]; 
            document.getElementById('trip-days-input').value = window.scheduleData.length || 3; 
            dateModal.classList.remove('hidden'); 
        }
        window.closeDateModal = function() { dateModal.classList.add('hidden'); }
        window.changeDays = function(delta) { let v = parseInt(document.getElementById('trip-days-input').value) + delta; if(v < 1) v = 1; document.getElementById('trip-days-input').value = v; }
        
        window.updateTravelDates = function() {
            const dStr = document.getElementById('start-date-input').value; 
            const days = parseInt(document.getElementById('trip-days-input').value);
            
            if(window.currentTrip.isShared) return; // Double check permission

            if(!dStr) return window.showToast("請選擇日期");
            const start = new Date(dStr.replace(/-/g, '/'));
            const oldLength = window.scheduleData.length;
            
            // Remove days
            if(days < oldLength) { 
                showCustomConfirm(`確定減少天數？這將刪除 Day ${days + 1} 到 Day ${oldLength} 的所有行程。`, () => {
                      
                      window.scheduleData.length = days;
                      updateDayMetadata(start, days, dStr);
                });
                return;
            }
            
            // Add days
            if(days > oldLength) { 
                for(let i=oldLength; i<days; i++) {
                    window.scheduleData.push({ date:"", month:"", day:`Day ${i+1}`, items:[] }); 
                }
            }
            
            // Update all day metadata (dates/day names)
            updateDayMetadata(start, days, dStr);

            function updateDayMetadata(start, days, dStr) {
                window.scheduleData.forEach((d, i) => { 
                    const dt = new Date(start); 
                    dt.setDate(start.getDate()+i); 
                    d.date=dt.getDate(); 
                    d.month=dt.getMonth()+1; 
                    d.day=`Day ${i+1}`; 
                });
                
                window.saveToFirestore('schedule', window.scheduleData); 
                
                // Update metadata locally and remotely (only for the creator's private copy)
                if(!window.currentTrip.isShared) {
                    const tripIndex = window.tripsList.findIndex(t => t.id === window.currentTrip.id);
                    if (tripIndex !== -1) {
                        window.tripsList[tripIndex].days = days;
                        window.tripsList[tripIndex].startDate = dStr;
                        window.currentTrip.meta = window.tripsList[tripIndex];
                        window.saveTripsIndex(window.tripsList);
                        window.saveTripMeta(window.currentTrip.id, window.currentTrip.meta);
                    }
                }
                
                window.renderDaySelector(); 
                window.renderTimeline(0); 
                closeDateModal();
            }
        }

        window.switchTab = function(tabId) { document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden')); document.getElementById(`view-${tabId}`).classList.remove('hidden'); ['schedule', 'info', 'budget'].forEach(id => { const btn = document.getElementById(`tab-${id}`); const span = btn.querySelector('span'); if(id === tabId) { btn.className = "active-tab flex items-center gap-2 px-5 py-3 tap-effect transition-all duration-300"; span.classList.remove('hidden'); } else { btn.className = "inactive-tab flex items-center gap-2 px-3 py-3 tap-effect transition-all duration-300"; span.classList.add('hidden'); } }); }

        function generateHourlyWeather() { const ws = [{i:'sun',t:22},{i:'cloud-sun',t:24},{i:'cloud',t:23},{i:'cloud-rain',t:20}]; let h=''; for(let i=6;i<=23;i++){ const m=ws[Math.floor(Math.random()*ws.length)]; h+=`<div class="weather-scroll-item flex flex-col items-center justify-center bg-stone-50 rounded-xl py-2 px-1 snap-start"><span class="text-[10px] text-stone-400 font-mono mb-1">${i}:00</span><i data-lucide="${m.i}" class="w-5 h-5 text-stone-600 mb-1"></i><span class="text-xs font-bold text-stone-800">${m.t}°</span></div>`; } document.getElementById('hourly-weather-container').innerHTML=h; }

        // --- UPDATED TEMPLATE DATA ---
        const templateScheduleData = [
             // Day 1 (27)
             { date: "27", month: "12", day: "Day 1", items: [ 
                { time: "08:00", endTime: "11:00", title: "抵達落機", type: "transport", location: "桃園國際機場 (TPE)", note: "買悠遊卡/SIM卡，搭機場捷運", description: "飛機抵達機場並完成入境手續。建議在機場先兌換少量台幣或取款。" },
                { time: "11:00", endTime: "12:00", title: "民宿擺行李", type: "stay", location: "台北市區 (自訂)", note: "辦理入住或寄放行李", description: "將行李寄放到住宿地點，方便開始輕鬆的行程。" }, 
                { time: "13:00", endTime: "14:30", title: "程味珍意麵滷味", type: "food", location: "程味珍意麵", tags: ["必吃滷味", "西門町"], note: "西門町老字號，必點意麵", description: "一家受歡迎的滷味店，滷汁濃郁入味，意麵 Q 彈有嚼勁。" },
                { time: "14:30", endTime: "17:00", title: "西門町", type: "sight", location: "西門町商圈", tags: ["逛街", "潮流"], note: "年輕人文化中心、萬年大樓", description: "台北的流行指標，有許多電影院、商店和小吃攤，適合逛街購物。" },
                { time: "17:00", endTime: "18:00", title: "妳有咖啡 neo cafe", type: "food", location: "妳有咖啡", tags: ["網美咖啡", "下午茶"], note: "享用咖啡或輕食", description: "一家風格獨特的咖啡店，可以休息放鬆，享受午後時光。" },
                { time: "18:00", endTime: "20:30", title: "詹記麻辣火鍋-西門大世界", type: "food", location: "詹記麻辣火鍋 (西門大世界)", tags: ["麻辣鍋", "必吃"], note: "台灣最紅麻辣鍋之一，鴨血豆腐無限續", description: "以復古裝潢和招牌鴨血、豆腐聞名的麻辣火鍋店，建議提前訂位。" },
                { time: "21:00", endTime: "23:00", title: "南機場夜市", type: "food", location: "南機場夜市", tags: ["夜市", "美食"], note: "在地人愛逛，來排芋頭餅", description: "當地知名的夜市，擁有許多排隊美食，適合晚餐後繼續品嚐小吃。" },
             ] },
             // Day 2 (28)
             { date: "28", month: "12", day: "Day 2", items: [ 
                { time: "09:00", endTime: "11:00", title: "早餐", type: "food", location: "台北 (自訂)", note: "找間傳統豆漿店或蛋餅店", description: "品嚐台式傳統早餐，如燒餅油條、飯糰或蛋餅。" }, 
                { time: "11:00", endTime: "15:00", title: "九份十份", type: "sight", location: "九份老街 / 十分瀑布", tags: ["山城", "天燈", "瀑布"], note: "建議先到十分瀑布，下午上九份", description: "可先在十分放天燈，下午前往九份老街欣賞山城景觀及茶樓文化。" },
                { time: "15:00", endTime: "17:00", title: "猴硐貓村", type: "sight", location: "猴硐貓村", tags: ["動物", "打卡"], note: "貓奴必去，愛護動物", description: "一個以貓咪為主題的小村落，到處可見可愛的貓咪，是愛貓人士的天堂。" },
                { time: "18:00", endTime: "20:00", title: "大股熟成燒肉專門-台北南京店", type: "food", location: "大股熟成燒肉 (南京店)", tags: ["燒肉", "晚餐"], note: "燒肉店，熟成肉品質不錯", description: "專注於熟成肉品的燒肉店，提供高品質的牛肉和舒適的用餐環境。" },
                { time: "21:00", endTime: "23:00", title: "寧夏夜市", type: "food", location: "寧夏夜市", tags: ["夜市", "圓環美食"], note: "美食集中，必吃劉芋仔", description: "以美食聞名的環狀夜市，小吃種類豐富，特別推薦劉芋仔蛋黃芋餅。" },
             ] },
             // Day 3 (29)
             { date: "29", month: "12", day: "Day 3", items: [ 
                { time: "11:00", endTime: "12:30", title: "犁園湯包館", type: "food", location: "犁園湯包館", tags: ["湯包", "午餐"], note: "絲瓜蝦仁湯包必點", description: "提供各式湯包點心，尤其是絲瓜蝦仁湯包清爽多汁。" },
                { time: "12:30", endTime: "14:00", title: "三創生活園區", type: "shop", location: "三創生活園區", tags: ["3C", "科技"], note: "最新的電子產品和數位內容", description: "台北主要的電子產品和科技商場，集合了各種品牌和體驗店。" },
                { time: "14:00", endTime: "16:00", title: "華山1914文化創意產業園區", type: "sight", location: "華山1914文創園區", tags: ["文創", "藝術"], note: "欣賞展覽和獨立商店", description: "由舊酒廠改造的藝術園區，經常舉辦各種展覽、市集和表演，充滿文藝氣息。" },
                { time: "16:00", endTime: "18:00", title: "螞米貝可千層蝴蝶酥/伴手禮", type: "shop", location: "螞米貝可 (自訂)", tags: ["伴手禮", "手信"], note: "購買千層蝴蝶酥等伴手禮", description: "購買台灣特色點心作為送給親友的禮物。" },
                { time: "19:00", endTime: "21:00", title: "輸漁永康店", type: "food", location: "輸漁日式料理 (永康店)", tags: ["日式料理", "晚餐"], note: "平價新鮮的海鮮丼飯", description: "提供新鮮的海鮮和日式料理，在永康街附近。" },
                { time: "21:00", endTime: "23:00", title: "饒河街觀光夜市", type: "food", location: "饒河街觀光夜市", tags: ["夜市", "小吃"], note: "胡椒餅、藥燉排骨", description: "台北知名的夜市之一，以胡椒餅、藥燉排骨和豐富的小吃聞名。" },
             ] },
             // Day 4 (30)
             { date: "30", month: "12", day: "Day 4", items: [ 
                { time: "12:00", endTime: "14:00", title: "比薩廣場/新北永和", type: "food", location: "比薩廣場 (永和)", tags: ["午餐", "義式"], note: "享受披薩和義大利麵", description: "在永和地區享用義式午餐，可以嘗試不同的披薩口味。" },
                { time: "14:00", endTime: "15:00", title: "樂華商圈商店街", type: "shop", location: "樂華夜市商圈", tags: ["逛街", "購物"], note: "周邊商店街閒逛", description: "樂華夜市周邊的商店，適合下午茶或購買小物品。" },
                { time: "15:00", endTime: "17:00", title: "Chill! Gelato", type: "food", location: "Chill! Gelato (自訂)", tags: ["甜點", "義式冰淇淋"], note: "品嚐手工義式冰淇淋", description: "一間手工義式冰淇淋店，口味清爽，適合炎熱的下午。" },
                { time: "18:00", endTime: "20:00", title: "金月-日本鍋料理 饗宴", type: "food", location: "金月-日本鍋料理", tags: ["晚餐", "日式鍋物"], note: "享用日式壽喜燒或涮涮鍋", description: "提供精緻的日式鍋物料理，可以選擇壽喜燒或涮涮鍋，體驗日式風味。" },
                { time: "21:00", endTime: "23:00", title: "臨江街觀光夜市", type: "food", location: "臨江街觀光夜市 (通化街)", tags: ["夜市", "小吃"], note: "又稱通化街夜市，人氣很旺", description: "以美食和服飾聞名的夜市，營業時間較晚，適合宵夜。" },
             ] },
             // Day 5 (31)
             { date: "31", month: "12", day: "Day 5", items: [ 
                { time: "12:00", endTime: "14:00", title: "Check Out / 華泰名品城", type: "shop", location: "華泰名品城 (GLORIA OUTLETS)", tags: ["購物", "Outlet"], note: "離機場近，最後購物衝刺", description: "在前往機場前，先到 Outlet 進行最後的購物，有許多國際品牌折扣店。" },
                { time: "20:00", endTime: "21:00", title: "晚餐", type: "food", location: "機場或市區 (自訂)", note: "回港前最後一餐", description: "在機場或市區找一間餐廳享用晚餐，準備搭機回港。" },
                { time: "22:00", endTime: "23:00", title: "回香港", type: "transport", location: "桃園國際機場 (TPE)", note: "搭機回程", description: "提前到達機場辦理登機手續，搭乘飛機返回香港。" },
             ] }
        ];

        // Global State
        window.scheduleData = [];
        window.templateScheduleData = templateScheduleData;
        
        function initUI() {
            lucide.createIcons();
            generateHourlyWeather();
            document.getElementById('expense-amount').addEventListener('input', function(e) {
                 const val = parseInt(e.target.value) || 0;
                 document.getElementById('input-hkd-preview').innerText = Math.round(val * EXCHANGE_RATE);
            });
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('new-trip-date').value = today;
        }

        initUI();
        
        const style = document.createElement('style');
        style.innerHTML = `@keyframes fade-in { from { opacity: 0; } to { opacity: 1; } } @keyframes slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } } .animate-fade-in { animation: fade-in 0.4s ease-out; } .animate-slide-up { animation: slide-up 0.5s cubic-bezier(0.16, 1, 0.3, 1); }`;
        document.head.appendChild(style);
    </script>
</body>
</html>
