<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å°ç£ä¹‹æ—…</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FEFDF5">
    
    <!-- App Icon -->
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #FEFDF5;
            --card-bg: #FFFFFF;
            --text-main: #433D3C;
            --text-sub: #9CA3AF;
            --accent: #D4C4B7;
            --highlight: #F43F5E;
        }

        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            -webkit-user-select: none;
            user-select: none;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .zen-shadow {
            box-shadow: 0 8px 24px rgba(149, 157, 165, 0.08);
            border: 1px solid rgba(255,255,255,0.8);
        }

        .tag-must-eat { background: #FFE4E6; color: #BE123C; }
        .tag-nav { background: #F3F4F6; color: #374151; }
        .tag-tips { background: #E0F2FE; color: #0369A1; }

        .active-tab {
            color: #57534E;
            font-weight: 700;
            background-color: #F5F5F4;
            border-radius: 16px;
        }
        .inactive-tab { color: #A8A29E; }

        .tap-effect:active { opacity: 0.8; transform: scale(0.98); transition: transform 0.1s; }
        
        @keyframes slide-up-spring {
            0% { transform: translateY(100%); opacity: 0; }
            60% { transform: translateY(-10px); opacity: 1; }
            100% { transform: translateY(0); }
        }
        .modal-enter { animation: slide-up-spring 0.4s ease-out forwards; }
        
        button, .card-clickable { touch-action: manipulation; cursor: pointer; }

        /* åˆ†æ”¤æŒ‰éˆ•æ¨£å¼ */
        .share-btn-selected { background-color: #433D3C; color: #FFFFFF; border-color: #433D3C; }
        .share-btn-unselected { background-color: #F5F5F4; color: #A8A29E; border-color: transparent; }

        /* æˆå“¡æ¿¾é¡æŒ‰éˆ•æ¨£å¼ */
        .filter-btn-active { background-color: rgba(255,255,255,0.2); color: white; font-weight: bold; border: 1px solid rgba(255,255,255,0.4); }
        .filter-btn-inactive { color: rgba(255,255,255,0.6); }
        
        /* å¤©æ°£æ©«å‘æ²å‹•å€å¡Š */
        .weather-scroll-item { min-width: 60px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-[#FEFDF5]">

    <!-- é ‚éƒ¨è³‡è¨Š -->
    <header class="bg-[#FEFDF5]/90 backdrop-blur-sm pt-safe-top sticky top-0 z-20 px-6 py-4 flex justify-between items-end">
        <div>
            <p class="text-[10px] text-gray-400 tracking-widest mb-1 font-bold">TAIPEI TRIP</p>
            <div class="flex items-center gap-2">
                <h1 class="text-2xl font-bold tracking-wide text-[#433D3C]">å°ç£äº”æ—¥éŠ</h1>
                <button onclick="openDateModal()" class="text-stone-400 hover:text-stone-600 tap-effect p-1">
                    <i data-lucide="calendar-days" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
        <div class="text-right flex flex-col items-end gap-1">
             <div class="flex items-center gap-1 text-gray-600 bg-white px-3 py-1 rounded-full shadow-sm border border-stone-100">
                <i data-lucide="cloud" class="w-4 h-4 text-stone-400"></i>
                <span class="text-sm font-bold">22Â°C</span>
            </div>
            <button onclick="resetToDefault()" class="text-[10px] text-stone-400 underline mt-1 hover:text-stone-600 transition-colors">æ¢å¾©é è¨­</button>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main id="main-content" class="flex-1 overflow-y-auto no-scrollbar pb-28 relative px-4">
        
        <!-- Tab 1: è¡Œç¨‹ -->
        <div id="view-schedule" class="view-section pt-2 space-y-6 animate-fade-in">
            
            <!-- æ—¥æœŸé¸æ“‡ -->
            <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2 px-1" id="day-selector"></div>
            
            <!-- æ¯å°æ™‚å¤©æ°£é æ¸¬ (æ–°å¢) -->
            <div class="bg-white rounded-[24px] p-4 zen-shadow border border-white overflow-hidden">
                <div class="flex items-center gap-2 mb-3 px-1">
                    <i data-lucide="cloud-sun" class="w-4 h-4 text-blue-400"></i>
                    <span class="text-xs font-bold text-stone-500">æ¯å°æ™‚å¤©æ°£é å ±</span>
                </div>
                <div class="flex overflow-x-auto no-scrollbar gap-2" id="hourly-weather-container">
                    <!-- JS ç”Ÿæˆ -->
                </div>
            </div>

            <!-- è¡Œç¨‹æ™‚é–“è»¸ -->
            <div id="timeline-container" class="space-y-4 pb-10"></div>
        </div>

        <!-- Tab 2: è³‡è¨Š -->
        <div id="view-info" class="view-section hidden pt-4 space-y-6 animate-fade-in">
            <div class="bg-white rounded-[24px] p-6 zen-shadow">
                <h3 class="text-lg font-bold text-gray-800 mb-5 flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-500"><i data-lucide="plane-takeoff" class="w-4 h-4"></i></div>
                    èˆªç­è³‡è¨Š
                </h3>
                <div class="space-y-6">
                    <div class="relative pl-6 border-l-2 border-stone-100">
                        <div class="absolute -left-[7px] top-0 w-3 h-3 rounded-full bg-stone-200 border-2 border-white ring-1 ring-stone-100"></div>
                        <p class="text-xs text-stone-400 mb-1 font-bold">å»ç¨‹ (Day 1)</p>
                        <div class="flex justify-between items-center mb-2 bg-stone-50 p-3 rounded-xl">
                            <span class="text-xl font-bold text-stone-700">HKG</span>
                            <i data-lucide="arrow-right" class="w-4 h-4 text-stone-300"></i>
                            <span class="text-xl font-bold text-stone-700">TPE</span>
                        </div>
                        <p class="text-sm text-stone-500">07:00 æŠµé” (è½æ©Ÿ)</p>
                    </div>
                    <div class="relative pl-6 border-l-2 border-stone-100">
                        <div class="absolute -left-[7px] top-0 w-3 h-3 rounded-full bg-stone-200 border-2 border-white ring-1 ring-stone-100"></div>
                        <p class="text-xs text-stone-400 mb-1 font-bold">å›ç¨‹ (Day 5)</p>
                        <div class="flex justify-between items-center mb-2 bg-stone-50 p-3 rounded-xl">
                            <span class="text-xl font-bold text-stone-700">TPE</span>
                            <i data-lucide="arrow-right" class="w-4 h-4 text-stone-300"></i>
                            <span class="text-xl font-bold text-stone-700">HKG</span>
                        </div>
                        <p class="text-sm text-stone-500">22:00 å›é¦™æ¸¯</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: è¨˜å¸³ -->
        <div id="view-budget" class="view-section hidden pt-4 space-y-6 animate-fade-in">
            
            <!-- ç¸½æ”¯å‡ºå¡ç‰‡ -->
            <div class="bg-[#2D2A26] rounded-[24px] p-6 text-white zen-shadow relative overflow-hidden">
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-white/5 rounded-full blur-2xl"></div>
                
                <div class="flex justify-between items-start mb-4">
                    <p class="text-stone-400 text-xs font-medium tracking-wide uppercase" id="budget-title">ç¸½æ¶ˆè²» (ALL)</p>
                    <button onclick="promptAddCompanion()" class="bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-full text-[10px] flex items-center gap-1 backdrop-blur-sm transition-colors">
                        <i data-lucide="user-plus" class="w-3 h-3"></i> ç®¡ç†æ—…ä¼´
                    </button>
                </div>

                <div class="mb-6">
                    <div class="flex items-baseline gap-2">
                        <span class="text-lg text-stone-400 font-bold">NT$</span>
                        <h2 class="text-5xl font-bold tracking-tighter font-mono" id="total-expense-twd">0</h2>
                    </div>
                    <p class="text-stone-400 text-sm mt-1 font-medium flex items-center gap-1">
                        <span class="bg-white/10 px-2 py-0.5 rounded text-xs">ç´„ HK$ <span id="total-expense-hkd" class="font-mono">0</span></span>
                    </p>
                </div>

                <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1" id="member-filter-container"></div>
            </div>
            
            <!-- æ–°å¢æ”¯å‡ºè¡¨å–® -->
            <div class="bg-white p-5 rounded-[24px] zen-shadow space-y-5 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-stone-200 to-white"></div>
                <h3 class="text-stone-800 font-bold text-lg flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-600"><i data-lucide="receipt" class="w-4 h-4"></i></div>
                    è¨˜ä¸€ç­†
                </h3>

                <div class="bg-stone-50 rounded-2xl px-5 py-4 flex flex-col border border-transparent focus-within:border-[#433D3C] transition-all shadow-inner relative group">
                    <label class="text-[10px] text-stone-400 font-bold mb-1 uppercase">é‡‘é¡ (TWD)</label>
                    <div class="flex items-baseline">
                        <span class="text-stone-400 text-2xl mr-2 font-bold">$</span>
                        <input type="number" id="expense-amount" placeholder="0" class="flex-1 bg-transparent text-4xl focus:outline-none text-stone-800 font-mono font-bold placeholder-stone-200">
                    </div>
                    <div class="absolute right-4 top-1/2 -translate-y-1/2 text-stone-300 font-mono text-sm pointer-events-none group-focus-within:text-stone-400 transition-colors">
                        â‰ˆ HK$ <span id="input-hkd-preview">0</span>
                    </div>
                </div>

                <div class="bg-stone-50 rounded-2xl px-4 py-3 flex items-center gap-2 border border-transparent focus-within:border-stone-200 transition-colors">
                    <input type="text" id="expense-item" placeholder="æ¶ˆè²»é …ç›® (ä¾‹å¦‚: æ™šé¤ã€è»Šè²»)" class="flex-1 bg-transparent text-base focus:outline-none text-stone-700 placeholder-stone-400 font-medium">
                </div>

                <div class="grid grid-cols-1 gap-3 bg-stone-50 p-4 rounded-2xl">
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-stone-500 font-bold flex items-center gap-1"><i data-lucide="wallet" class="w-3 h-3"></i> èª°å…ˆä»˜éŒ¢ï¼Ÿ</span>
                        <select id="expense-payer" class="bg-white text-stone-700 text-sm font-bold px-3 py-1.5 rounded-lg border-none focus:ring-0 outline-none cursor-pointer shadow-sm"></select>
                    </div>
                    <div class="h-px bg-stone-200/50 w-full"></div>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-stone-500 font-bold flex items-center gap-1"><i data-lucide="users" class="w-3 h-3"></i> èª°è¦åˆ†æ”¤ï¼Ÿ</span>
                            <button type="button" onclick="selectAllShares()" class="text-[10px] bg-blue-50 text-blue-500 font-bold px-2 py-1 rounded hover:bg-blue-100 transition-colors">å…¨é¸</button>
                        </div>
                        <div id="share-buttons-container" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <button onclick="addExpense()" class="w-full bg-[#433D3C] text-white py-4 rounded-2xl flex items-center justify-center gap-2 tap-effect shadow-lg shadow-stone-200 font-bold text-lg active:scale-[0.98] transition-transform">
                    <i data-lucide="plus" class="w-5 h-5"></i> åŠ å…¥è¨˜å¸³
                </button>
            </div>

            <div class="flex justify-between items-end px-2">
                <h4 class="text-stone-400 text-xs font-bold tracking-widest uppercase">äº¤æ˜“ç´€éŒ„ (HISTORY)</h4>
                <span class="text-[10px] text-stone-300" id="list-filter-status">é¡¯ç¤ºå…¨éƒ¨</span>
            </div>

            <div id="expense-list" class="space-y-3 pb-10 min-h-[100px]"></div>
        </div>
    </main>

    <!-- åº•éƒ¨å°èˆª -->
    <div class="fixed bottom-6 left-6 right-6 z-30">
        <nav class="bg-white/90 backdrop-blur-xl rounded-[24px] shadow-[0_8px_32px_rgba(0,0,0,0.08)] p-2 border border-white/50">
            <div class="flex justify-around items-center">
                <button onclick="switchTab('schedule')" id="tab-schedule" class="active-tab flex items-center gap-2 px-4 py-3 tap-effect transition-all duration-300">
                    <i data-lucide="map" class="w-5 h-5"></i><span class="text-xs font-bold">è¡Œç¨‹</span>
                </button>
                <button onclick="switchTab('info')" id="tab-info" class="inactive-tab flex items-center gap-2 px-4 py-3 tap-effect transition-all duration-300">
                    <i data-lucide="sparkles" class="w-5 h-5"></i><span class="text-xs font-bold hidden">è³‡è¨Š</span>
                </button>
                <button onclick="switchTab('budget')" id="tab-budget" class="inactive-tab flex items-center gap-2 px-4 py-3 tap-effect transition-all duration-300">
                    <i data-lucide="wallet" class="w-5 h-5"></i><span class="text-xs font-bold hidden">è¨˜å¸³</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Modals (è©³ç´°, ç·¨è¼¯, æ—¥æœŸ) -->
    <div id="detail-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 hidden flex items-end sm:items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-[#FEFDF5] w-full max-w-md rounded-[32px] p-6 shadow-2xl modal-enter relative max-h-[85vh] overflow-y-auto no-scrollbar">
            <div class="w-12 h-1.5 bg-stone-200 rounded-full mx-auto mb-6"></div>
            <div id="detail-content" class="space-y-5"></div>
            <button onclick="closeDetailModal()" class="absolute top-6 right-6 w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-400 hover:text-stone-600 tap-effect"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 hidden flex items-end sm:items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-[#FEFDF5] w-full max-w-md rounded-[32px] p-6 shadow-2xl modal-enter relative max-h-[90vh] overflow-y-auto no-scrollbar">
            <h3 class="text-xl font-bold mb-6 flex justify-between items-center text-[#433D3C]">
                <span id="modal-title">ç·¨è¼¯è¡Œç¨‹</span>
                <button onclick="closeEditModal()" class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-400 hover:text-stone-600 tap-effect"><i data-lucide="x" class="w-5 h-5"></i></button>
            </h3>
            <form id="edit-form" class="space-y-4" onsubmit="saveScheduleItem(event)">
                <input type="hidden" id="edit-day-index"><input type="hidden" id="edit-item-index">
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">é–‹å§‹æ™‚é–“</label><input type="time" id="edit-time" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm text-center"></div>
                    <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">çµæŸæ™‚é–“ (é¸å¡«)</label><input type="time" id="edit-end-time" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm text-center text-stone-500 placeholder-stone-300"></div>
                </div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">é¡å‹</label><select id="edit-type" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm appearance-none"><option value="sight">ğŸ“· æ™¯é»</option><option value="food">ğŸœ ç¾é£Ÿ</option><option value="shop">ğŸ›ï¸ è³¼ç‰©</option><option value="transport">ğŸšŒ äº¤é€š</option><option value="stay">ğŸ›ï¸ ä½å®¿</option></select></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">æ¨™é¡Œ</label><input type="text" id="edit-title" required class="w-full bg-white rounded-2xl p-4 text-sm font-bold border border-transparent focus:border-stone-200 focus:outline-none shadow-sm" placeholder="è¡Œç¨‹åç¨±"></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">åœ°é»</label><div class="relative"><i data-lucide="map-pin" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-stone-400"></i><input type="text" id="edit-location" class="w-full bg-white rounded-2xl p-4 pl-10 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm" placeholder="è¼¸å…¥åœ°é»é—œéµå­—"></div></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">æ¨™ç±¤ (é€—è™Ÿåˆ†éš”)</label><input type="text" id="edit-tags" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm" placeholder="ä¾‹å¦‚: å¿…åƒ, æ¨è–¦"></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">ç°¡çŸ­å‚™è¨»</label><input type="text" id="edit-note" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm" placeholder="é¡¯ç¤ºåœ¨å¡ç‰‡ä¸Šçš„çŸ­å¥"></div>
                <div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">è©³ç´°ä»‹ç´¹</label><textarea id="edit-description" rows="4" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm resize-none" placeholder="è©³ç´°æ”»ç•¥..."></textarea></div>
                <div class="pt-4"><button type="submit" class="w-full py-4 rounded-2xl bg-[#433D3C] text-[#FEFDF5] font-bold shadow-lg shadow-stone-300 tap-effect">å„²å­˜è®Šæ›´</button></div>
            </form>
        </div>
    </div>

    <!-- æ—¥æœŸç·¨è¼¯ Modal (æ–°å¢) -->
    <div id="date-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-[#FEFDF5] w-full max-w-sm rounded-[32px] p-6 shadow-2xl modal-enter relative">
            <h3 class="text-lg font-bold mb-4 text-[#433D3C] text-center">è¨­å®šæ—…ç¨‹å‡ºç™¼æ—¥æœŸ</h3>
            <p class="text-xs text-stone-400 text-center mb-6">é€™å°‡æœƒè‡ªå‹•æ›´æ–°æ‰€æœ‰è¡Œç¨‹çš„æ—¥æœŸ</p>
            <input type="date" id="start-date-input" class="w-full bg-white rounded-2xl p-4 text-lg font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm text-center mb-6 text-[#433D3C]">
            <div class="flex gap-3">
                <button onclick="closeDateModal()" class="flex-1 py-3 rounded-2xl bg-stone-100 text-stone-500 font-bold tap-effect">å–æ¶ˆ</button>
                <button onclick="updateTravelDates()" class="flex-1 py-3 rounded-2xl bg-[#433D3C] text-white font-bold tap-effect shadow-lg shadow-stone-300">ç¢ºèªæ›´æ–°</button>
            </div>
        </div>
    </div>

    <script>
        // --- è³‡æ–™èˆ‡åƒæ•¸ ---
        const EXCHANGE_RATE = 0.24;
        const defaultScheduleData = [
            { date: "27", month: "11", day: "Day 1", items: [{ time: "07:00", endTime: "08:00", title: "æŠµé”è½æ©Ÿ", type: "transport", location: "å°ç£æ¡ƒåœ’åœ‹éš›æ©Ÿå ´", note: "æ­¡è¿ä¾†åˆ°å°ç£ï¼", description: "è¨˜å¾—å…ˆå»é ˜å–äº‹å…ˆé è¨‚çš„ WiFi æ©Ÿæˆ– SIM å¡ã€‚" }, { time: "11:00", endTime: "11:30", title: "æ°‘å®¿æ”¾è¡Œæ", type: "stay", location: "å°åŒ—", note: "ç¢ºèª Check-in æ™‚é–“", description: "å¦‚æœæ˜¯ä½¿ç”¨ Airbnbï¼Œè¨˜å¾—å…ˆèˆ‡æˆ¿æ±è¯ç¹«ç¢ºèªå¤§é–€å¯†ç¢¼ã€‚" }, { time: "13:00", endTime: "14:00", title: "ç¨‹å‘³çæ„éºµæ»·å‘³", type: "food", location: "ç¨‹å‘³çæ„éºµ", tags: ["å¿…åƒ: æ»·å‘³"], note: "è¥¿é–€ç”ºè€å­—è™Ÿ", description: "æ»·å‘³éå¸¸å…¥å‘³ï¼å¿…é»æ»·è˜¿è””ã€å¤§è±†å¹²ã€‚" }, { time: "15:00", endTime: "17:00", title: "è¥¿é–€ç”º", type: "sight", location: "è¥¿é–€ç”º", tags: ["é€›è¡—"], note: "æ½®æµè–åœ°", description: "æ¨è–¦å°åƒï¼šé˜¿å®—éºµç·šã€å¹¸ç¦å ‚ã€‚" }, { time: "17:00", endTime: "18:30", title: "å¦³æœ‰å’–å•¡ neo cafÃ©", type: "food", location: "å¦³æœ‰å’–å•¡ neo cafe", tags: ["æ¨è–¦: å¸ƒä¸"], note: "å¾©å¤å’–å•¡å»³", description: "å¤§äººå‘³ç„¦ç³–å¸ƒä¸å¿…é»ã€‚" }, { time: "19:00", endTime: "20:30", title: "è©¹è¨˜éº»è¾£ç«é‹", type: "food", location: "è©¹è¨˜éº»è¾£ç«é‹ è¥¿é–€å¤§ä¸–ç•Œ", tags: ["å¿…åƒ: é´¨è¡€"], note: "å°åŒ—æœ€é›£è¨‚", description: "é´¨è¡€åƒæœå‡ä¸€æ¨£æ»‘å«©ï¼" }, { time: "21:00", endTime: "22:30", title: "å—æ©Ÿå ´å¤œå¸‚", type: "food", location: "å—æ©Ÿå ´å¤œå¸‚", tags: ["å¿…åƒ: æ°´é¤ƒ"], note: "åœ¨åœ°äººæœ€æ„›", description: "æ¨è–¦ï¼šä¾†ä¾†æ°´é¤ƒã€‚" }] },
            { date: "28", month: "11", day: "Day 2", items: [{ time: "09:00", endTime: "10:00", title: "é˜œæ­è±†æ¼¿", type: "food", location: "é˜œæ­è±†æ¼¿", note: "å¿…æ¯”ç™»æ¨è–¦", description: "åšç‡’é¤…å¤¾è›‹éå¸¸å¥½åƒï¼" }, { time: "12:00", endTime: "14:00", title: "ä¹ä»½ / ååˆ†", type: "sight", location: "ä¹ä»½è€è¡—", tags: ["å¿…åƒ: èŠ‹åœ“"], note: "ç¥éš±å°‘å¥³å ´æ™¯", description: "å…ˆå»ååˆ†æ”¾å¤©ç‡ˆï¼Œå†å»ä¹ä»½åƒèŠ‹åœ“ã€‚" }, { time: "16:00", endTime: "17:30", title: "çŒ´ç¡è²“æ‘", type: "sight", location: "çŒ´ç¡è²“æ‘", tags: ["è²“å’ª"], note: "è²“å¥´å¤©å ‚", description: "ä¸è¦é–‹é–ƒå…‰ç‡ˆæ‹ç…§å–”ã€‚" }, { time: "19:00", endTime: "20:30", title: "å¤§è‚¡ç†Ÿæˆç‡’è‚‰", type: "food", location: "å¤§è‚¡ç†Ÿæˆç‡’è‚‰å°ˆé–€ å°åŒ—å—äº¬åº—", tags: ["å¿…é»: ç‰›èˆŒ"], note: "æ¸…é…’è²©è³£æ©Ÿ", description: "å°ˆäººä»£çƒ¤ï¼Œç‰›èˆŒè¶…å¥½åƒã€‚" }, { time: "21:00", endTime: "22:00", title: "å¯§å¤å¤œå¸‚", type: "food", location: "å¯§å¤å¤œå¸‚", tags: ["å¿…åƒ: èŠ‹ä¸¸"], note: "å°è€Œç¾", description: "åŠ‰èŠ‹ä»”è›‹é»ƒèŠ‹é¤…å¿…æ’ã€‚" }] },
            { date: "29", month: "11", day: "Day 3", items: [{ time: "11:00", endTime: "12:30", title: "çŠåœ’æ¹¯åŒ…é¤¨", type: "food", location: "çŠåœ’æ¹¯åŒ…é¤¨", tags: ["å¿…é»: çµ²ç“œæ¹¯åŒ…"], note: "å¹³åƒ¹é¼æ³°è±", description: "ç¾…å‹’é®®èšµæ¹¯åŒ…å¾ˆæœ‰ç‰¹è‰²ã€‚" }, { time: "14:00", endTime: "15:00", title: "ä¸‰å‰µç”Ÿæ´»åœ’å€", type: "sight", location: "ä¸‰å‰µç”Ÿæ´»åœ’å€", tags: ["3C"], note: "ç§‘æŠ€å•†å ´", description: "æ—é‚Šå°±æ˜¯å…‰è¯å•†å ´ã€‚" }, { time: "15:00", endTime: "17:00", title: "è¯å±±æ–‡å‰µåœ’å€", type: "sight", location: "è¯å±±1914æ–‡åŒ–å‰µæ„ç”¢æ¥­åœ’å€", tags: ["å±•è¦½"], note: "æ–‡é’å¿…å»", description: "èˆŠé…’å» æ”¹å»ºï¼Œå¾ˆå¥½æ‹ç…§ã€‚" }, { time: "19:00", endTime: "20:30", title: "æ‹¾æ¼", type: "food", location: "æ‹¾æ¼ æ°¸åº·åº—", tags: ["æ—¥å¼ç„¡èœå–®"], note: "é«˜CPå€¼", description: "è¨˜å¾—æº–æ™‚åˆ°ã€‚" }, { time: "21:00", endTime: "22:30", title: "é¥’æ²³å¤œå¸‚", type: "food", location: "é¥’æ²³è¡—è§€å…‰å¤œå¸‚", tags: ["å¿…åƒ: èƒ¡æ¤’é¤…"], note: "è—¥ç‡‰æ’éª¨", description: "é™³è‘£è—¥ç‡‰æ’éª¨å†¬å¤©å¿…åƒã€‚" }] },
            { date: "30", month: "11", day: "Day 4", items: [{ time: "12:00", endTime: "13:30", title: "æ¯”æ¼¾å»£å ´", type: "shop", location: "æ¯”æ¼¾å»£å ´", tags: ["é€›è¡—"], note: "æ°¸å’Œç™¾è²¨", description: "åœ¨åœ°ç™¾è²¨å…¬å¸ã€‚" }, { time: "14:00", endTime: "15:30", title: "æ¨‚è¯å•†åœˆ", type: "sight", location: "æ¨‚è¯å¤œå¸‚", tags: ["é€›è¡—"], note: "è·¯å¯¬å¥½é€›", description: "ä¸‹åˆä¹Ÿæœ‰åº—å®¶ç‡Ÿæ¥­ã€‚" }, { time: "16:00", endTime: "17:00", title: "Chii! Gelato", type: "food", location: "Chii! Gelato", tags: ["æ¨è–¦: é–‹å¿ƒæœ"], note: "ç¾©å¼å†°æ·‡æ·‹", description: "å£å‘³éå¸¸é“åœ°ã€‚" }, { time: "19:00", endTime: "20:30", title: "é‡‘æœˆæ—¥æœ¬é‹", type: "food", location: "é‡‘æœˆæ—¥æœ¬é‹æ–™ç†æ“”ç•¶", tags: ["å¿…é»: æ¸…é…’æ¹¯åº•"], note: "å°ˆäººæœå‹™", description: "æ¸…é…’æ¹¯åº•ç…®æµ·é®®å¾ˆé®®ç”œã€‚" }, { time: "21:00", endTime: "22:00", title: "è‡¨æ±Ÿè¡—å¤œå¸‚", type: "food", location: "è‡¨æ±Ÿè¡—è§€å…‰å¤œå¸‚", tags: ["å¿…åƒ: æ¹¯åœ“"], note: "é€šåŒ–å¤œå¸‚", description: "å¾¡å“å…ƒå†°ç«æ¹¯åœ“å¿…åƒã€‚" }] },
            { date: "31", month: "11", day: "Day 5", items: [{ time: "12:00", endTime: "12:30", title: "Check Out", type: "stay", location: "å°åŒ—", note: "è¡Œæå¯„æ”¾?", description: "æª¢æŸ¥éš¨èº«ç‰©å“ã€‚" }, { time: "14:00", endTime: "17:00", title: "è¯æ³°åå“åŸ", type: "shop", location: "GLORIA OUTLETS è¯æ³°åå“åŸ", tags: ["Outlet"], note: "æœ€å¾Œè¡åˆº", description: "ç¾å¼éœ²å¤© Outletã€‚" }, { time: "22:00", endTime: "23:00", title: "å›é¦™æ¸¯", type: "transport", location: "å°ç£æ¡ƒåœ’åœ‹éš›æ©Ÿå ´", note: "å¹³å®‰å›å®¶", description: "ææ—©2.5å°æ™‚åˆ°æ©Ÿå ´ã€‚" }] }
        ];

        let scheduleData = [];
        let currentDayIndex = 0;
        let expenses = JSON.parse(localStorage.getItem('tw_trip_expenses') || '[]');
        let companions = JSON.parse(localStorage.getItem('tw_trip_companions') || '["æˆ‘"]');
        let currentFilter = 'ALL'; 

        function init() {
            const savedSchedule = localStorage.getItem('tw_trip_schedule');
            scheduleData = savedSchedule ? JSON.parse(savedSchedule) : JSON.parse(JSON.stringify(defaultScheduleData));
            if(!savedSchedule) saveSchedule();
            
            lucide.createIcons();
            renderDaySelector();
            renderTimeline(0);
            
            renderExpenses(); 
            updatePayerSelect();
            renderShareButtons();
            
            document.getElementById('expense-amount').addEventListener('input', function(e) {
                const val = parseInt(e.target.value) || 0;
                document.getElementById('input-hkd-preview').innerText = Math.round(val * EXCHANGE_RATE);
            });
        }

        // --- å¤©æ°£åŠŸèƒ½ (æ¨¡æ“¬) ---
        function generateHourlyWeather() {
            const weathers = [
                { icon: 'sun', temp: 22 }, { icon: 'cloud-sun', temp: 24 }, { icon: 'cloud', temp: 23 },
                { icon: 'cloud-rain', temp: 20 }, { icon: 'cloud-lightning', temp: 19 }
            ];
            let html = '';
            // æ¨¡æ“¬ 06:00 - 23:00
            for (let i = 6; i <= 23; i++) {
                const mock = weathers[Math.floor(Math.random() * weathers.length)];
                const temp = mock.temp + Math.floor(Math.random() * 3); // éš¨æ©Ÿå¾®èª¿
                const timeStr = i.toString().padStart(2, '0') + ":00";
                
                html += `
                    <div class="weather-scroll-item flex flex-col items-center justify-center bg-stone-50 rounded-xl py-2 px-1 snap-start">
                        <span class="text-[10px] text-stone-400 font-mono mb-1">${timeStr}</span>
                        <i data-lucide="${mock.icon}" class="w-5 h-5 text-stone-600 mb-1"></i>
                        <span class="text-xs font-bold text-stone-800">${temp}Â°</span>
                    </div>
                `;
            }
            document.getElementById('hourly-weather-container').innerHTML = html;
            lucide.createIcons();
        }

        // --- æ—¥æœŸç·¨è¼¯åŠŸèƒ½ ---
        const dateModal = document.getElementById('date-modal');
        function openDateModal() {
            // é è¨­é¡¯ç¤ºç•¶å‰ç¬¬ä¸€å¤©çš„æ—¥æœŸ
            const currentFirstDay = scheduleData[0];
            const currentYear = new Date().getFullYear(); // å‡è¨­ç•¶å¹´ï¼Œå¯¦éš›æ‡‰ç”¨å¯å­˜å¹´ä»½
            // é€™è£¡ç°¡åŒ–è™•ç†ï¼Œå‡è¨­æ ¼å¼ç‚º "27" (æ—¥) "11" (æœˆ)
            // ç‚ºäº† input type="date" æ­£ç¢ºé¡¯ç¤ºï¼Œæˆ‘å€‘éœ€è¦ YYYY-MM-DD
            // é€™è£¡ç°¡å–®è®“ä½¿ç”¨è€…é‡é¸ï¼Œä¸é å¡«è¤‡é›œé‚è¼¯
            dateModal.classList.remove('hidden');
        }
        function closeDateModal() { dateModal.classList.add('hidden'); }
        
        function updateTravelDates() {
            const input = document.getElementById('start-date-input').value;
            if (!input) return alert("è«‹é¸æ“‡æ—¥æœŸ");
            
            const startDate = new Date(input);
            
            // æ›´æ–°æ¯ä¸€å¤©çš„æ—¥æœŸ
            scheduleData.forEach((dayItem, index) => {
                const d = new Date(startDate);
                d.setDate(startDate.getDate() + index);
                
                dayItem.date = d.getDate().toString();
                dayItem.month = (d.getMonth() + 1).toString();
                // Day X ä¿æŒä¸è®Šï¼Œæˆ–è€…ä¹Ÿå¯ä»¥é‡ç½®
            });
            
            saveSchedule();
            renderDaySelector();
            renderTimeline(currentDayIndex); // é‡æ–°æ¸²æŸ“ç•¶å‰é é¢
            closeDateModal();
        }

        // ... (å…¶ä»–æ ¸å¿ƒé‚è¼¯: Schedule, Modal, Expense ä¿æŒä¸è®Š) ...
        function saveSchedule() { localStorage.setItem('tw_trip_schedule', JSON.stringify(scheduleData)); }
        function resetToDefault() { if(confirm("æ¢å¾©é è¨­è¡Œç¨‹ï¼Ÿ")) { scheduleData = JSON.parse(JSON.stringify(defaultScheduleData)); saveSchedule(); renderTimeline(currentDayIndex); } }
        function renderDaySelector() { const c = document.getElementById('day-selector'); c.innerHTML = scheduleData.map((d, i) => `<button onclick="selectDay(${i})" class="day-btn flex-shrink-0 flex flex-col items-center justify-center w-[60px] h-[72px] rounded-2xl transition-all border border-transparent tap-effect ${i===0?'bg-[#433D3C] text-[#FEFDF5] shadow-lg shadow-stone-200':'bg-white text-stone-300'}"><span class="text-[10px] font-bold tracking-wide opacity-80">${d.day}</span><span class="text-xl font-bold font-mono mt-1">${d.month}/${d.date}</span></button>`).join(''); }
        function selectDay(i) { 
            currentDayIndex = i; 
            document.querySelectorAll('.day-btn').forEach((b, idx) => { b.className = `day-btn flex-shrink-0 flex flex-col items-center justify-center w-[60px] h-[72px] rounded-2xl transition-all border border-transparent tap-effect ${idx===i?'bg-[#433D3C] text-[#FEFDF5] shadow-lg shadow-stone-200 transform scale-105':'bg-white text-stone-300'}`; }); 
            renderTimeline(i);
            // åˆ‡æ›æ—¥æœŸæ™‚é‡æ–°ç”Ÿæˆå¤©æ°£ (æ¨¡æ“¬ä¸åŒå¤©çš„å¤©æ°£)
            generateHourlyWeather(); 
        }
        
        function renderTimeline(i) { 
            const c = document.getElementById('timeline-container'); 
            const d = scheduleData[i];
            d.items.sort((a,b)=>a.time.localeCompare(b.time));
            // ç§»é™¤äº†èˆŠçš„å¤©æ°£æ¨™é¡Œï¼Œå› ç‚ºå·²ç¶“æœ‰ç¨ç«‹å€å¡Š
            
            let html = d.items.map((item, idx) => {
                let icon = item.type==='food'?'utensils':item.type==='transport'?'bus':item.type==='shop'?'shopping-bag':item.type==='stay'?'bed':'map-pin';
                let color = item.type==='food'?'text-orange-500 bg-orange-50':item.type==='transport'?'text-blue-500 bg-blue-50':item.type==='shop'?'text-pink-500 bg-pink-50':item.type==='stay'?'text-purple-500 bg-purple-50':'text-stone-500 bg-stone-100';
                let tags = item.tags ? item.tags.map(t => `<span class="text-[10px] px-2.5 py-1 rounded-lg font-bold bg-stone-50 text-stone-500 ${t.includes('å¿…')?'tag-must-eat':''}">${t}</span>`).join('') : '';
                
                let timeDisplay = `<div class="text-center"><span class="text-xs font-bold text-stone-400 font-mono block leading-tight">${item.time}</span>`;
                if(item.endTime) { timeDisplay += `<span class="text-[10px] text-stone-300 font-mono block leading-tight my-0.5">â†“</span><span class="text-xs font-bold text-stone-400 font-mono block leading-tight">${item.endTime}</span>`; }
                timeDisplay += `</div>`;

                return `<div onclick="openDetailModal(${i}, ${idx})" class="card-clickable bg-white rounded-[24px] p-5 zen-shadow relative overflow-hidden animate-slide-up mb-4 border border-white active:bg-stone-50 transition-colors"><div class="flex gap-4"><div class="flex flex-col items-center pt-1 w-12 flex-shrink-0">${timeDisplay}<div class="w-10 h-10 rounded-full flex items-center justify-center ${color} mt-2"><i data-lucide="${icon}" class="w-5 h-5"></i></div><div class="h-full w-0.5 bg-stone-100 my-2 rounded-full"></div></div><div class="flex-1 pb-2 min-w-0"><div class="flex justify-between items-start"><h3 class="font-bold text-[#433D3C] text-lg leading-tight truncate mr-2">${item.title}</h3></div><div class="flex items-center gap-2 mt-2 mb-3"><div class="text-xs flex items-center gap-1.5 bg-stone-50 text-stone-500 px-3 py-1.5 rounded-xl max-w-full truncate font-medium"><i data-lucide="map-pin" class="w-3 h-3 flex-shrink-0"></i><span class="truncate">${item.location||'è¨­å®šåœ°é»'}</span></div></div>${item.note?`<p class="text-xs text-stone-400 mt-1 line-clamp-2 leading-relaxed bg-[#FEFDF5] p-2 rounded-lg">${item.note}</p>`:''}<div class="flex flex-wrap gap-2 mt-3">${tags}</div><div class="flex justify-end gap-2 mt-3 pt-2 border-t border-stone-50"><button onclick="event.stopPropagation(); openEditModal(${i}, ${idx})" class="px-3 py-1.5 bg-stone-100 rounded-lg text-xs font-bold text-stone-500 tap-effect flex items-center gap-1"><i data-lucide="pencil" class="w-3 h-3"></i> ç·¨è¼¯</button><button onclick="event.stopPropagation(); deleteScheduleItem(${i}, ${idx})" class="px-3 py-1.5 bg-red-50 rounded-lg text-xs font-bold text-red-400 tap-effect flex items-center gap-1"><i data-lucide="trash-2" class="w-3 h-3"></i> åˆªé™¤</button></div></div></div></div>`
            }).join('') + `<button onclick="openAddModal(${i})" class="w-full py-4 rounded-[24px] border-2 border-dashed border-stone-200 text-stone-300 hover:border-stone-300 hover:text-stone-500 transition-all flex items-center justify-center gap-2 tap-effect mt-2 bg-white/50"><i data-lucide="plus" class="w-5 h-5"></i><span class="font-bold">æ–°å¢è¡Œç¨‹</span></button>`;
            
            c.innerHTML = html;
            lucide.createIcons();
        }

        // ... (Expense Logic, Filters, Add Expense, Delete Expense etc. - same as before) ...
        function setFilter(name) { currentFilter = name; renderExpenses(); }
        function renderFilter() { const c = document.getElementById('member-filter-container'); let h = `<button onclick="setFilter('ALL')" class="flex-shrink-0 px-4 py-1.5 rounded-full text-xs transition-all ${currentFilter === 'ALL' ? 'filter-btn-active' : 'filter-btn-inactive'}">å…¨é«”</button>`; companions.forEach(n => { h += `<button onclick="setFilter('${n}')" class="flex-shrink-0 px-4 py-1.5 rounded-full text-xs transition-all ${currentFilter === n ? 'filter-btn-active' : 'filter-btn-inactive'}">${n}</button>`; }); c.innerHTML = h; }
        function renderExpenses() {
            const list = document.getElementById('expense-list');
            const totalTwdEl = document.getElementById('total-expense-twd');
            const totalHkdEl = document.getElementById('total-expense-hkd');
            const titleEl = document.getElementById('budget-title');
            const listStatusEl = document.getElementById('list-filter-status');
            let displayExpenses = []; let totalTWD = 0;
            if (currentFilter === 'ALL') { displayExpenses = expenses; titleEl.innerText = "ç¸½æ¶ˆè²» (ALL)"; listStatusEl.innerText = "é¡¯ç¤ºå…¨éƒ¨"; } else { titleEl.innerText = `å€‹äººæ¶ˆè²» (${currentFilter})`; listStatusEl.innerText = `åªé¡¯ç¤º ${currentFilter} çš„åˆ†æ”¤é …ç›®`; displayExpenses = expenses.filter(ex => { const sharers = ex.sharedBy && ex.sharedBy.length > 0 ? ex.sharedBy : ["æˆ‘"]; return sharers.includes(currentFilter); }); }
            if (currentFilter === 'ALL') { totalTWD = expenses.reduce((sum, ex) => sum + parseInt(ex.amount), 0); } else { totalTWD = displayExpenses.reduce((sum, ex) => { const sharersCount = (ex.sharedBy && ex.sharedBy.length > 0) ? ex.sharedBy.length : 1; return sum + (parseInt(ex.amount) / sharersCount); }, 0); }
            list.innerHTML = displayExpenses.map((ex, i) => {
                const originalIndex = expenses.indexOf(ex);
                const fullAmount = parseInt(ex.amount);
                let displayAmount = fullAmount; let displayLabel = "ç¸½é¡"; let detailText = ""; let amountClass = "text-stone-800";
                if (currentFilter !== 'ALL') { const sharersCount = (ex.sharedBy && ex.sharedBy.length > 0) ? ex.sharedBy.length : 1; displayAmount = fullAmount / sharersCount; displayLabel = "æ‡‰ä»˜"; detailText = `(ç¸½é¡ $${fullAmount} Ã· ${sharersCount}äºº)`; amountClass = "text-blue-600"; }
                const amountHKD = Math.round(displayAmount * EXCHANGE_RATE); const amountTWD = Math.round(displayAmount);
                const payer = ex.payer || "æˆ‘"; const sharedBy = ex.sharedBy || ["æˆ‘"]; const shareText = sharedBy.length === companions.length ? "å…¨å“¡" : sharedBy.join(",");
                return `<div class="flex flex-col bg-white p-4 rounded-[20px] shadow-sm border border-stone-100"><div class="flex justify-between items-start mb-2"><div><span class="text-base font-bold text-stone-700 block">${ex.item}</span><span class="text-[10px] text-stone-400">ç”± ${payer} å…ˆä»˜ â€¢ åˆ†æ”¤: ${shareText}</span></div><div class="text-right"><div class="text-[10px] text-stone-300 font-bold mb-0.5 text-right">${displayLabel}</div><div class="font-mono font-bold ${amountClass} text-lg">NT$ ${amountTWD}</div><div class="font-mono text-xs text-stone-400">â‰ˆ HK$ ${amountHKD}</div>${detailText ? `<div class="text-[10px] text-stone-400 mt-0.5">${detailText}</div>` : ''}</div></div><div class="flex justify-end border-t border-stone-50 pt-2 mt-1"><button onclick="deleteExpense(${originalIndex})" class="text-xs text-stone-300 hover:text-red-400 flex items-center gap-1 px-2 py-1 rounded tap-effect"><i data-lucide="trash-2" class="w-3 h-3"></i> åˆªé™¤</button></div></div>`;
            }).reverse().join('') || `<div class="text-center text-stone-300 text-sm py-8">æ²’æœ‰ç›¸é—œç´€éŒ„</div>`;
            totalTwdEl.innerText = Math.round(totalTWD).toLocaleString(); totalHkdEl.innerText = Math.round(totalTWD * EXCHANGE_RATE).toLocaleString();
            renderFilter(); localStorage.setItem('tw_trip_expenses', JSON.stringify(expenses)); lucide.createIcons();
        }
        function addExpense() { const item = document.getElementById('expense-item').value; const amount = document.getElementById('expense-amount').value; const payer = document.getElementById('expense-payer').value; const shareBtns = document.querySelectorAll('.share-toggle-btn.share-btn-selected'); const sharedBy = Array.from(shareBtns).map(btn => btn.getAttribute('data-name')); if(!item || !amount) { alert("è«‹è¼¸å…¥é …ç›®å’Œé‡‘é¡"); return; } if(sharedBy.length === 0) { alert("è«‹è‡³å°‘é¸æ“‡ä¸€ä½åˆ†æ”¤å°è±¡"); return; } expenses.push({ item, amount, payer, sharedBy }); document.getElementById('expense-item').value = ''; document.getElementById('expense-amount').value = ''; document.getElementById('input-hkd-preview').innerText = '0'; renderExpenses(); }
        function deleteExpense(index) { if(confirm('ç¢ºå®šåˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ')) { expenses.splice(index, 1); renderExpenses(); } }
        function promptAddCompanion() { const name = prompt("è«‹è¼¸å…¥æ—…ä¼´åå­—ï¼š"); if (name && name.trim() !== "") { if (!companions.includes(name.trim())) { companions.push(name.trim()); localStorage.setItem('tw_trip_companions', JSON.stringify(companions)); updatePayerSelect(); renderShareButtons(); renderFilter(); } else { alert("å·²ç¶“åœ¨åå–®å…§å›‰ï¼"); } } }
        function updatePayerSelect() { document.getElementById('expense-payer').innerHTML = companions.map(c => `<option value="${c}">${c}</option>`).join(''); }
        function renderShareButtons() { document.getElementById('share-buttons-container').innerHTML = companions.map(c => `<button type="button" class="share-toggle-btn share-btn-selected px-3 py-1.5 rounded-lg text-xs font-bold border transition-colors" data-name="${c}" onclick="toggleShare(this)">${c}</button>`).join(''); }
        function toggleShare(btn) { if (btn.classList.contains('share-btn-selected')) { btn.classList.remove('share-btn-selected'); btn.classList.add('share-btn-unselected'); } else { btn.classList.remove('share-btn-unselected'); btn.classList.add('share-btn-selected'); } }
        function selectAllShares() { document.querySelectorAll('.share-toggle-btn').forEach(btn => { btn.classList.remove('share-btn-unselected'); btn.classList.add('share-btn-selected'); }); }

        // ... (Modals: Detail & Edit) ...
        const detailModal = document.getElementById('detail-modal'); const detailContent = document.getElementById('detail-content');
        function openDetailModal(dayIndex, itemIndex) { const item = scheduleData[dayIndex].items[itemIndex]; let icon = item.type==='food'?'utensils':item.type==='transport'?'bus':item.type==='shop'?'shopping-bag':item.type==='stay'?'bed':'map-pin'; let timeStr = item.time; if (item.endTime) timeStr += ` - ${item.endTime}`; detailContent.innerHTML = `<div class="flex items-start justify-between mb-2"><div class="w-12 h-12 rounded-2xl bg-stone-100 flex items-center justify-center text-stone-600"><i data-lucide="${icon}" class="w-6 h-6"></i></div><div class="text-right"><p class="text-2xl font-mono font-bold text-stone-800">${timeStr}</p><p class="text-xs text-stone-400 font-bold">11æœˆ${scheduleData[dayIndex].date}æ—¥</p></div></div><h2 class="text-2xl font-bold text-[#433D3C] mb-1 leading-tight">${item.title}</h2><button onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}')" class="inline-flex items-center gap-1.5 text-blue-500 text-sm font-bold mb-4 tap-effect"><i data-lucide="map-pin" class="w-4 h-4"></i> ${item.location || 'è¨­å®šåœ°é»'} <i data-lucide="external-link" class="w-3 h-3"></i></button><div class="bg-white p-5 rounded-2xl border border-stone-100 shadow-sm"><h4 class="text-xs font-bold text-stone-400 mb-3 uppercase tracking-wider">ABOUT</h4><div class="text-stone-600 text-sm leading-relaxed space-y-2">${item.description ? item.description.split('\n').map(l=>`<p class="mb-2">${l}</p>`).join('') : '<p class="text-stone-400 italic">æš«ç„¡è©³ç´°ä»‹ç´¹...</p>'}</div></div>`; detailModal.classList.remove('hidden'); lucide.createIcons(); }
        function closeDetailModal() { detailModal.classList.add('hidden'); }
        detailModal.addEventListener('click', (e) => { if (e.target === detailModal) closeDetailModal(); });

        const editModal = document.getElementById('edit-modal'); const modalTitle = document.getElementById('modal-title');
        function openAddModal(dayIndex) { document.getElementById('edit-day-index').value = dayIndex; document.getElementById('edit-item-index').value = -1; modalTitle.innerText = "æ–°å¢è¡Œç¨‹"; document.getElementById('edit-time').value = "12:00"; document.getElementById('edit-end-time').value = ""; document.getElementById('edit-type').value = "sight"; document.getElementById('edit-title').value = ""; document.getElementById('edit-location').value = ""; document.getElementById('edit-tags').value = ""; document.getElementById('edit-note').value = ""; document.getElementById('edit-description').value = ""; editModal.classList.remove('hidden'); }
        function openEditModal(dayIndex, itemIndex) { const item = scheduleData[dayIndex].items[itemIndex]; document.getElementById('edit-day-index').value = dayIndex; document.getElementById('edit-item-index').value = itemIndex; modalTitle.innerText = "ç·¨è¼¯è¡Œç¨‹"; document.getElementById('edit-time').value = item.time; document.getElementById('edit-end-time').value = item.endTime || ""; document.getElementById('edit-type').value = item.type; document.getElementById('edit-title').value = item.title; document.getElementById('edit-location').value = item.location; document.getElementById('edit-tags').value = item.tags?item.tags.join(', '):''; document.getElementById('edit-note').value = item.note||''; document.getElementById('edit-description').value = item.description||''; editModal.classList.remove('hidden'); }
        function closeEditModal() { editModal.classList.add('hidden'); }
        function saveScheduleItem(e) { e.preventDefault(); const d = parseInt(document.getElementById('edit-day-index').value); const i = parseInt(document.getElementById('edit-item-index').value); const item = { time: document.getElementById('edit-time').value, endTime: document.getElementById('edit-end-time').value, type: document.getElementById('edit-type').value, title: document.getElementById('edit-title').value, location: document.getElementById('edit-location').value, tags: document.getElementById('edit-tags').value.split(',').map(t=>t.trim()).filter(t=>t), note: document.getElementById('edit-note').value, description: document.getElementById('edit-description').value }; if (i === -1) scheduleData[d].items.push(item); else scheduleData[d].items[i] = item; saveSchedule(); renderTimeline(d); closeEditModal(); }
        function deleteScheduleItem(d, i) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { scheduleData[d].items.splice(i, 1); saveSchedule(); renderTimeline(d); } }
        editModal.addEventListener('click', (e) => { if (e.target === editModal) closeEditModal(); });

        function switchTab(tabId) { document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden')); document.getElementById(`view-${tabId}`).classList.remove('hidden'); ['schedule', 'info', 'budget'].forEach(id => { const btn = document.getElementById(`tab-${id}`); const span = btn.querySelector('span'); if(id === tabId) { btn.className = "active-tab flex items-center gap-2 px-5 py-3 tap-effect transition-all duration-300"; span.classList.remove('hidden'); } else { btn.className = "inactive-tab flex items-center gap-2 px-3 py-3 tap-effect transition-all duration-300"; span.classList.add('hidden'); } }); }

        init();
        
        // åˆå§‹å¤©æ°£æ¸²æŸ“
        generateHourlyWeather();

        const style = document.createElement('style');
        style.innerHTML = `@keyframes fade-in { from { opacity: 0; } to { opacity: 1; } } @keyframes slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } } .animate-fade-in { animation: fade-in 0.4s ease-out; } .animate-slide-up { animation: slide-up 0.5s cubic-bezier(0.16, 1, 0.3, 1); }`;
        document.head.appendChild(style);
    </script>
</body>
</html>
